<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Delphi CreateProcess 创建一个新的进程和它的主线程' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Delphi CreateProcess 创建一个新的进程和它的主线程</center></div><div class='banquan'>原文出处:本文由博客园博主黄浩#提供。<br/>
原文连接:https://www.cnblogs.com/hhmm99/p/10946354.html</div><br>
    <h3 class="title pre fs1"><span class="tcnt">Delphi CreateProcess WIN32API函数CreateProcess用来创建一个新的进程和它的主线程，这个新进程运行指定的可执行文件&nbsp;</span></h3>
<p><span class="tcnt">CreateProcess<br />百科名片<br /></span></p>
<p>WIN32API函数CreateProcess用来创建一个新的进程和它的主线程，这个新进程运行指定的<a href="http://baike.baidu.com/view/159830.htm" target="_blank">可执行文件</a>。</p>
<p>&nbsp;</p>
<p><a href="http://baike.baidu.com/view/697167.htm">编辑本段</a><a name="1"></a>函数原型<br />　　BOOL CreateProcess<span class="Apple-converted-space">&nbsp;<br />　　(<span class="Apple-converted-space">&nbsp;<br />　　LPCTSTR lpApplicationName,<span class="Apple-converted-space">&nbsp;<br />　　LPTSTR lpCommandLine,<span class="Apple-converted-space">&nbsp;<br />　　LPSECURITY_ATTRIBUTES lpProcessAttributes。<span class="Apple-converted-space">&nbsp;<br />　　LPSECURITY_ATTRIBUTES lpThreadAttributes,<span class="Apple-converted-space">&nbsp;<br />　　BOOL bInheritHandles,<span class="Apple-converted-space">&nbsp;<br />　　DWORD dwCreationFlags,<span class="Apple-converted-space">&nbsp;<br />　　LPVOID lpEnvironment,<span class="Apple-converted-space">&nbsp;<br />　　LPCTSTR lpCurrentDirectory,<span class="Apple-converted-space">&nbsp;<br />　　LPSTARTUPINFO lpStartupInfo,<span class="Apple-converted-space">&nbsp;<br />　　LPPROCESS_INFORMATION lpProcessInformation<span class="Apple-converted-space">&nbsp;<br />　　);<span class="Apple-converted-space">&nbsp;<br /><a href="http://baike.baidu.com/view/697167.htm">编辑本段</a><a name="2"></a>参数<br />　　1.lpApplicationName：<span class="Apple-converted-space">&nbsp;<br />　　指向一个NULL结尾的、用来指定可执行模块的字符串。<span class="Apple-converted-space">&nbsp;<br />　　这个字符串可以是可执行模块的绝对路径，也可以是相对路径，在后一种情况下，函数使用当前驱动器和目录建立可执行模块的路径。<span class="Apple-converted-space">&nbsp;<br />　　这个参数可以被设为NULL，在这种情况下，可执行模块的名字必须处于 lpCommandLine 参数的最前面并由空格符与后面的字符分开。<span class="Apple-converted-space">&nbsp;<br />　　这个被指定的模块可以是一个Win32<a href="http://baike.baidu.com/view/330120.htm" target="_blank">应用程序</a>。如果适当的子系统在当前计算机上可用的话，它也可以是其他类型的模块（如<a href="http://baike.baidu.com/view/61797.htm" target="_blank">MS-DOS</a><span class="Apple-converted-space">&nbsp;或 OS/2）。<span class="Apple-converted-space">&nbsp;<br />　　在Windows NT中，如果可执行模块是一个16位的应用程序，那么这个参数应该被设置为NULL并且因该在lpCommandLine参数中指定可执行模块的名称。16位的应用程序是以DOS<a href="http://baike.baidu.com/view/1132.htm" target="_blank">虚拟机</a>或Win32上的Windows（WOW） 为进程的方式运行。<span class="Apple-converted-space">&nbsp;<br />　　2.lpCommandLine：<span class="Apple-converted-space">&nbsp;<br />　　指向一个NULL结尾的、用来指定要运行的命令行。<span class="Apple-converted-space">&nbsp;<br />　　这个参数可以为空，那么函数将使用参数指定的字符串当作要运行的程序的命令行。<span class="Apple-converted-space">&nbsp;<br />　　如果lpApplicationName和lpCommandLine参数都不为空，那么lpApplicationName参数指定将要被运行的模块，lpCommandLine参数指定将被运行的模块的命令行。新运行的进程可以使用<a href="http://baike.baidu.com/view/1460180.htm" target="_blank">GetCommandLine</a>函数获得整个命令行。C语言程序可以使用argc和argv参数。<span class="Apple-converted-space">&nbsp;<br />　　如果lpApplicationName参数为空，那么这个字符串中的第一个被空格分隔的要素指定可执行模块名。如果文件名不包含扩展名，那么.exe将被假定为默认的扩展名。如果文件名以一个点（.）结尾且没有扩展名，或文件名中包含路径，.exe将不会被加到后面。如果文件名中不包含路径，Windows将按照如下顺序寻找这个<a href="http://baike.baidu.com/view/159830.htm" target="_blank">可执行文件</a>：<span class="Apple-converted-space">&nbsp;<br />　　1).当前应用程序的目录。<span class="Apple-converted-space">&nbsp;<br />　　2).父进程的目录。<span class="Apple-converted-space">&nbsp;<br />　　3).Windows 95：Windows系统目录，可以使用<a href="http://baike.baidu.com/view/1290410.htm" target="_blank">GetSystemDirectory</a>函数获得。<span class="Apple-converted-space">&nbsp;<br />　　Windows NT：32位Windows系统目录。可以使用GetSystemDirectory函数获得，目录名是SYSTEM32。<span class="Apple-converted-space">&nbsp;<br />　　4).在Windows NT中：16位Windows系统目录。不可以使用Win32函数获得这个目录，但是它会被搜索，目录名是SYSTEM。<span class="Apple-converted-space">&nbsp;<br />　　5).Windows目录。可以使用<a href="http://baike.baidu.com/view/1292121.htm" target="_blank">GetWindowsDirectory</a>函数获得这个目录。<span class="Apple-converted-space">&nbsp;<br />　　6).列在PATH环境变量中的目录。<span class="Apple-converted-space">&nbsp;<br />　　如果被创建的进程是一个以MS-DOS或16位Windows为基础的应用程序，lpCommandLine参数应该是一个以可执行文件的文件名作为第一个要素的绝对路径，因为这样做可以使32位Windows程序工作的很好，这样设置lpCommandLine参数是最强壮的。<span class="Apple-converted-space">&nbsp;<br />　　注意：Visual C++ 2005以后的版本中，如果向CreateProcess函数传递一个常量指针作为命令行参数的话，将会发生访问违规错误。原因是系统在[1]<a name="ref_[1]"></a>执行该函数时会修改lpCommandLine所指向的字符串（比如解释转义字符等）。因此，在调用此函数前，应该定义一个临时字符<a href="http://baike.baidu.com/view/1349297.htm" target="_blank">数组变量</a>来保存命令行参数，并将这个临时变量作为lpCommandLine参数传递.<span class="Apple-converted-space">&nbsp;<br />　　3.lpProcessAttributes：<span class="Apple-converted-space">&nbsp;<br />　　指向一个<a href="http://baike.baidu.com/view/1624681.htm" target="_blank">SECURITY_ATTRIBUTES</a>结构体，这个结构体决定是否返回的句柄可以被子进程继承。如果lpProcessAttributes参数为空（NULL），那么句柄不能被继承。<span class="Apple-converted-space">&nbsp;<br />　　在Windows NT中：SECURITY_ATTRIBUTES结构的lpSecurityDescriptor成员指定了新进程的安全描述符，如果参数为空，新进程使用默认的安全描述符。<span class="Apple-converted-space">&nbsp;<br />　　在Windows95中：SECURITY_ATTRIBUTES结构的lpSecurityDescriptor成员被忽略。<span class="Apple-converted-space">&nbsp;<br />　　4.lpThreadAttributes：<span class="Apple-converted-space">&nbsp;<br />　　指向一个SECURITY_ATTRIBUTES结构体，这个结构体决定是否返回的指向线程的句柄可以被子进程继承。如果lpThreadAttributes参数为空（NULL），那么句柄不能被继承。<span class="Apple-converted-space">&nbsp;<br />　　在Windows NT中，SECURITY_ATTRIBUTES结构的lpSecurityDescriptor成员指定了主线程的安全描述符，如果参数为空，主线程使用默认的安全描述符。<span class="Apple-converted-space">&nbsp;<br />　　在Windows95中：SECURITY_ATTRIBUTES结构的lpSecurityDescriptor成员被忽略。<span class="Apple-converted-space">&nbsp;<br />　　5.bInheritHandles：<span class="Apple-converted-space">&nbsp;<br />　　指示新进程是否从调用进程处继承了句柄。<span class="Apple-converted-space">&nbsp;<br />　　如果参数的值为真，调用进程中的每一个可继承的打开句柄都将被子进程继承。被继承的句柄与原进程拥有完全相同的值和访问权限。<span class="Apple-converted-space">&nbsp;<br />　　5.dwCreationFlags：<span class="Apple-converted-space">&nbsp;<br />　　指定附加的、用来控制优先类和进程的创建的标志。以下的创建标志可以以除下面列出的方式外的任何方式组合后指定。<span class="Apple-converted-space">&nbsp;<br />　　(1)值：CREATE_DEFAULT_ERROR_MODE<span class="Apple-converted-space">&nbsp;<br />　　含义：新的进程不继承调用进程的错误模式。CreateProcess函数赋予新进程当前的默认错误模式作为替代。应用程序可以调用SetErrorMode函数设置当前的默认错误模式。<span class="Apple-converted-space">&nbsp;<br />　　这个标志对于那些运行在没有硬件错误环境下的多线程外壳程序是十分有用的。<span class="Apple-converted-space">&nbsp;<br />　　对于CreateProcess函数，默认的行为是为新进程继承调用者的错误模式。设置这个标志以改变默认的处理方式。<span class="Apple-converted-space">&nbsp;<br />　　(2)值：CREATE_NEW_CONSOLE<span class="Apple-converted-space">&nbsp;<br />　　含义：新的进程将使用一个新的控制台，而不是继承父进程的控制台。这个标志不能与DETACHED_PROCESS标志一起使用。<span class="Apple-converted-space">&nbsp;<br />　　(3)值：CREATE_NEW_PROCESS_GROUP<span class="Apple-converted-space">&nbsp;<br />　　含义：新进程将使一个进程树的根进程。进程树种的全部进程都是根进程的子进程。新进程树的用户<a href="http://baike.baidu.com/view/390932.htm" target="_blank">标识符</a>与这个进程的标识符是相同的，由lpProcessInformation参数返回。进程树经常使用GenerateConsoleCtrlEvent函数允许发送CTRL+C或CTRL+BREAK信号到一组控制台进程。<span class="Apple-converted-space">&nbsp;<br />　　(4)值：CREATE_SEPARATE_WOW_VDM<span class="Apple-converted-space">&nbsp;<br />　　含义：（只适用于Windows NT）这个标志只有当运行一个16位的Windows应用程序时才是有效的。如果被设置，新进程将会在一个私有的虚拟DOS机（VDM）中运行。另外，默认情况下所有的16位Windows应用程序都会在同一个共享的VDM中以线程的方式运行。单独运行一个16位程序的优点是一个应用程序的崩溃只会结束这一个VDM的运行；其他那些在不同VDM中运行的程序会继续正常的运行。同样的，在不同VDM中运行的16位Windows应用程序拥有不同的输入队列，这意味着如果一个程序暂时失去响应，在独立的VDM中的应用程序能够继续获得输入。<span class="Apple-converted-space">&nbsp;<br />　　(5)值：CREATE_SHARED_WOW_VDM<span class="Apple-converted-space">&nbsp;<br />　　含义：（只适用于Windows NT）这个标志只有当运行一个16位的Windows应用程序时才是有效的。如果WIN.INI中的Windows段的DefaultSeparateVDM选项被设置为真，这个标识使得CreateProcess函数越过这个选项并在共享的虚拟DOS机中运行新进程。<span class="Apple-converted-space">&nbsp;<br />　　(6)值：CREATE_SUSPENDED<span class="Apple-converted-space">&nbsp;<br />　　含义：新进程的主线程会以暂停的状态被创建，直到调用<a href="http://baike.baidu.com/view/2469490.htm" target="_blank">ResumeThread</a>函数被调用时才运行。<span class="Apple-converted-space">&nbsp;<br />　　(7)值：CREATE_UNICODE_ENVIRONMENT<span class="Apple-converted-space">&nbsp;<br />　　含义：如果被设置，由lpEnvironment参数指定的环境块使用Unicode字符，如果为空，环境块使用ANSI字符。<span class="Apple-converted-space">&nbsp;<br />　　(8)值：DEBUG_PROCESS<span class="Apple-converted-space">&nbsp;<br />　　含义：如果这个标志被设置，调用进程将被当作一个调试程序，并且新进程会被当作被调试的进程。系统把被调试程序发生的所有调试事件通知给调试器。<span class="Apple-converted-space">&nbsp;<br />　　如果你使用这个标志创建进程，只有调用进程（调用CreateProcess函数的进程）可以调用WaitForDebugEvent函数。<span class="Apple-converted-space">&nbsp;<br />　　(9)值：DEBUG_ONLY_THIS_PROCESS<span class="Apple-converted-space">&nbsp;<br />　　含义：如果此标志没有被设置且调用进程正在被调试，新进程将成为调试调用进程的调试器的另一个调试对象。如果调用进程没有被调试，有关调试的行为就不会产生。<span class="Apple-converted-space">&nbsp;<br />　　(10)值：DETACHED_PROCESS<span class="Apple-converted-space">&nbsp;<br />　　含义：对于控制台进程，新进程没有访问父进程控制台的权限。新进程可以通过AllocConsole函数自己创建一个新的控制台。这个标志不可以与CREATE_NEW_CONSOLE标志一起使用。<span class="Apple-converted-space">&nbsp;<br />　　6.dwCreationFlags参数<span class="Apple-converted-space">&nbsp;<br />　　还用来控制新进程的优先类，优先类用来决定此进程的线程调度的优先级。如果下面的优先级类标志都没有被指定，那么默认的优先类是NORMAL_PRIORITY_CLASS，除非被创建的进程是IDLE_PRIORITY_CLASS。在这种情况下子进程的默认优先类是IDLE_PRIORITY_CLASS。<span class="Apple-converted-space">&nbsp;<br />　　可以下面的标志中的一个：<span class="Apple-converted-space">&nbsp;<br />　　优先级：HIGH_PRIORITY_CLASS<span class="Apple-converted-space">&nbsp;<br />　　含义：指示这个进程将执行时间临界的任务，所以它必须被立即运行以保证正确。这个优先级的程序优先于正常优先级或空闲优先级的程序。一个例子是Windows任务列表，为了保证当用户调用时可以立刻响应，放弃了对系统负荷的考虑。确保在使用高优先级时应该足够谨慎，因为一个高优先级的CPU关联应用程序可以占用几乎全部的CPU可用时间。<span class="Apple-converted-space">&nbsp;<br />　　优先级：IDLE_PRIORITY_CLASS<span class="Apple-converted-space">&nbsp;<br />　　含义：指示这个进程的线程只有在系统空闲时才会运行并且可以被任何高优先级的任务打断。例如<a href="http://baike.baidu.com/view/121502.htm" target="_blank">屏幕保护程序</a>。空闲优先级会被子进程继承。<span class="Apple-converted-space">&nbsp;<br />　　优先级：NORMAL_PRIORITY_CLASS<span class="Apple-converted-space">&nbsp;<br />　　含义：指示这个进程没有特殊的任务调度要求。<span class="Apple-converted-space">&nbsp;<br />　　优先级：REALTIME_PRIORITY_CLASS<span class="Apple-converted-space">&nbsp;<br />　　含义：指示这个进程拥有可用的最高优先级。一个拥有实时优先级的进程的线程可以打断所有其他进程线程的执行，包括正在执行重要任务的系统进程。例如，一个执行时间稍长一点的实时进程可能导致磁盘缓存不足或鼠标反映迟钝。<span class="Apple-converted-space">&nbsp;<br />　　7.lpEnvironment：<span class="Apple-converted-space">&nbsp;<br />　　指向一个新进程的环境块。如果此参数为空，新进程使用调用进程的环境。<span class="Apple-converted-space">&nbsp;<br />　　一个环境块存在于一个由以NULL结尾的字符串组成的块中，这个块也是以NULL结尾的。每个字符串都是name=value的形式。<span class="Apple-converted-space">&nbsp;<br />　　因为相等标志被当作分隔符，所以它不能被环境变量当作变量名。<span class="Apple-converted-space">&nbsp;<br />　　与其使用应用程序提供的环境块，不如直接把这个参数设为空，系统驱动器上的当前目录信息不会被自动传递给新创建的进程。对于这个情况的探讨和如何处理，请参见注释一节。<span class="Apple-converted-space">&nbsp;<br />　　环境块可以包含Unicode或ANSI字符。如果lpEnvironment指向的环境块包含Unicode字符，那么dwCreationFlags字段的CREATE_UNICODE_ENVIRONMENT标志将被设置。如果块包含ANSI字符，该标志将被清空。<span class="Apple-converted-space">&nbsp;<br />　　请注意一个ANSI环境块是由两个零字节结束的：一个是字符串的结尾，另一个用来结束这个快。一个Unicode环境块是由四个零字节结束的：两个代表字符串结束，另两个用来结束块。<span class="Apple-converted-space">&nbsp;<br />　　8.lpCurrentDirectory：<span class="Apple-converted-space">&nbsp;<br />　　指向一个以NULL结尾的字符串，这个字符串用来指定子进程的工作路径。这个字符串必须是一个包含驱动器名的绝对路径。如果这个参数为空，新进程将使用与调用进程相同的驱动器和目录。这个选项是一个需要启动启动应用程序并指定它们的驱动器和工作目录的外壳程序的主要条件。<span class="Apple-converted-space">&nbsp;<br />　　9.lpStartupInfo：<span class="Apple-converted-space">&nbsp;<br />　　指向一个用于决定新进程的主<a href="http://baike.baidu.com/view/230361.htm" target="_blank">窗体</a>如何显示的<a href="http://baike.baidu.com/view/2254534.htm" target="_blank">STARTUPINFO</a>结构体。<span class="Apple-converted-space">&nbsp;<br />　　10.lpProcessInformation：<span class="Apple-converted-space">&nbsp;<br />　　指向一个用来接收新进程的识别信息的<a href="http://baike.baidu.com/view/2421585.htm" target="_blank">PROCESS_INFORMATION</a>结构体。<span class="Apple-converted-space">&nbsp;<br /><a href="http://baike.baidu.com/view/697167.htm">编辑本段</a><a name="3"></a>返回值<br />　　如果函数执行成功，返回非零值。<span class="Apple-converted-space">&nbsp;<br />　　如果函数执行失败，返回零，可以使用GetLastError函数获得错误的附加信息。<span class="Apple-converted-space">&nbsp;<br />　　注释：<span class="Apple-converted-space">&nbsp;<br />　　CreateProcess函数用来运行一个新程序。<a href="http://baike.baidu.com/view/1286882.htm" target="_blank">WinExec</a>和<a href="http://baike.baidu.com/view/1286899.htm" target="_blank">LoadModule</a>函数依旧可用，但是它们同样通过调用CreateProcess函数实现。<span class="Apple-converted-space">&nbsp;<br />　　另外CreateProcess函数除了创建一个进程，还创建一个线程对象。这个线程将连同一个已初始化了的堆栈一起被创建，堆栈的大小由可执行文件的文件头中的描述决定。线程由文件头处开始执行。<span class="Apple-converted-space">&nbsp;<br />　　新进程和新线程的句柄被以全局访问权限创建。对于这两个句柄中的任一个，如果没有安全描述符，那么这个句柄就可以在任何需要句柄类型作为参数的函数中被使用。当提供安全描述符时，在接下来的时候当句柄被使用时，总是会先进行访问权限的检查，如果访问权限检查拒绝访问，请求的进程将不能使用这个句柄访问这个进程。<span class="Apple-converted-space">&nbsp;<br />　　这个进程会被分配给一个32位的进程标识符。直到进程中止这个标识符都是有效的。它可以被用来标识这个进程，或在<a href="http://baike.baidu.com/view/1280137.htm" target="_blank">OpenProcess</a>函数中被指定以打开这个进程的句柄。进程中被初始化了的线程一样会被分配一个32位的线程标识符。这个标识符直到县城中止都是有效的且可以用来在系统中唯一标识这个线程。这些标识符在PROCESS_INFORMATION结构体中返回。<span class="Apple-converted-space">&nbsp;<br />　　当在lpApplicationName或lpCommandLine参数中指定应用程序名时，应用程序名中是否包含扩展名都不会影响运行，只有一种情况例外：一个以.com为扩展名的MS-DOS程序或Windows程序必须包含.com扩展名。<span class="Apple-converted-space">&nbsp;<br />　　调用进程可以通过<a href="http://baike.baidu.com/view/4217373.htm" target="_blank">WaitForInputIdle</a>函数来等待新进程完成它的初始化并等待用户输入。这对于父进程和子进程之间的同步是极其有用的，因为CreateProcess函数不会等待新进程完成它的初始化工作。举例来说，在试图与新进程关联的窗口之前，进程应该先调用WaitForInputIdle。<span class="Apple-converted-space">&nbsp;<br />　　首选的结束一个进程的方式是调用<a href="http://baike.baidu.com/view/1285871.htm" target="_blank">ExitProcess</a>函数，因为这个函数通知这个进程的所有动态链接库（DLLs）程序已进入结束状态。其他的结束进程的方法不会通知关联的动态链接库。注意当一个进程调用ExitProcess时，这个进程的其他线程没有机会运行其他任何代码（包括关联动态链接库的终止代码）。<span class="Apple-converted-space">&nbsp;<br />　　ExitProcess,<span class="Apple-converted-space">&nbsp;<a href="http://baike.baidu.com/view/2031333.htm" target="_blank">ExitThread</a>,<span class="Apple-converted-space">&nbsp;<a href="http://baike.baidu.com/view/1191444.htm" target="_blank">CreateThread</a>,<span class="Apple-converted-space">&nbsp;<a href="http://baike.baidu.com/view/1748232.htm" target="_blank">CreateRemoteThread</a>，当一个进程启动时（调用了CreateProcess的结果）是在进程中序列化进行的。在一段地址空间中，同一时间内这些事件中只有一个可以发生。这意味着下面的限制将保留：<span class="Apple-converted-space">&nbsp;<br />　　*在进程启动和DLL初始化阶段，新的线程可以被创建，但是直到进程的DLL初始化完成前它们都不能开始运行。<span class="Apple-converted-space">&nbsp;<br />　　*在DLL初始化或卸下例程中进程中只能有一个线程。<span class="Apple-converted-space">&nbsp;<br />　　*直到所有的线程都完成DLL初始化或卸下后，ExitProcess函数才返回。<span class="Apple-converted-space">&nbsp;<br />　　在进程中的所有线程都终止且进程所有的句柄和它们的线程被通过调用<a href="http://baike.baidu.com/view/1288756.htm" target="_blank">CloseHandle</a>函数终止前，进程会留在系统中。进程和主线程的句柄都必须通过调用CloseHandle函数关闭。如果不再需要这些句柄，最好在创建进程后立刻关闭它们。<span class="Apple-converted-space">&nbsp;<br />　　当进程中最后一个线程终止时，下列的事件发生：<span class="Apple-converted-space">&nbsp;<br />　　*所有由进程打开的对象都会关闭。<span class="Apple-converted-space">&nbsp;<br />　　*进程的终止状态（由<a href="http://baike.baidu.com/view/1285903.htm" target="_blank">GetExitCodeProcess</a>函数返回）从它的初始值STILL_ACTIVE变为最后一个结束的线程的结束状态。<span class="Apple-converted-space">&nbsp;<br />　　*主线程的线程对象被设置为标志状态，供其他等待这个对象的线程使用。<span class="Apple-converted-space">&nbsp;<br />　　*进程对象被设置为标志状态，供其他等待这个对象的线程使用。<span class="Apple-converted-space">&nbsp;<br />　　假设当前在C盘上的目录是\MSVC\MFC且有一个环境变量叫做C:，它的值是C:\MSVC\MFC，就像前面lpEnvironment中提到过的那样，这样的系统驱动器上的目录信息在CreateProcess函数的lpEnvironment参数不为空时不会被自动传递到新进程里。一个应用程序必须手动地把当前目录信息传递到新的进程中。为了这样做，应用程序必须直接创建环境字符串，并把它们按字母顺序排列（因为Windows NT和Windows 95使用一种简略的环境变量），并把它们放进lpEnvironment中指定的环境块中。类似的，他们要找到环境块的开头，又要重复一次前面提到的环境块的排序。<span class="Apple-converted-space">&nbsp;<br />　　一种获得驱动器X的当前目录变量的方法是调用<a href="http://baike.baidu.com/view/1290383.htm" target="_blank">GetFullPathName</a>("x:",..)。这避免了一个应用程序必须去扫描环境块。如果返回的绝对路径是X:\，就不需要把这个值当作一个环境数据去传递了，因为根目录是驱动器X上的新进程的默认当前目录。<span class="Apple-converted-space">&nbsp;<br />　　由CreateProcess函数返回的句柄对于进程对象具有PROCESS_ALL_ACCESS的访问权限。<span class="Apple-converted-space">&nbsp;<br />　　由lpcurrentDirectory参数指定的当前目录室子进程对象的当前目录。lpCommandLine参数指定的第二个项目是父进程的当前目录。<span class="Apple-converted-space">&nbsp;<br />　　对于Windows NT，当一个进程在指定了CREATE_NEW_PROCESS_GROUP的情况下被创建时，一个对于SetConsoleCtrlHandler(NULL,True)的调用被用在新的进程上，这意味着对新进程来说CTRL+C是无效的。这使得上层的外科程序可以自己处理CTRL+C信息并有选择的把这些信号传递给子进程。CTRL+BREAK依旧有效，并可被用来中断进程/进程树的执行。<span class="Apple-converted-space">&nbsp;<br />　　安全注释：<span class="Apple-converted-space">&nbsp;<br />　　第一个参数lpApplicationName可能是空，这种情况下，可执行文件的名字必须在lpCommandLine中，lpCommandLine参数中可以包含空格。如果可执行文件或路径中包含空格，那么就会有执行不正确文件的风险，这是由于这个函数解析空格的方法引起的。例如：下边这个例子就很危险，因为它试图运行Program.exe文件，如果这个文件存在，它就会代替MyApp.exe文件的运行。<span class="Apple-converted-space">&nbsp;<br />　　CreateProcess(NULL，&rdquo;C:\\Program Files\\MyApp.exe&rdquo;，&hellip;&hellip;.)<span class="Apple-converted-space">&nbsp;<br />　　如果有恶意的用户在系统编写了一个名为Program.exe的文件，那么任何调用CreateProcess函数，且在文件路径中使用Program Files文件夹的参数，都有可能会运行Program.exe文件，而不是运行本来打算运行的文件。<span class="Apple-converted-space">&nbsp;<br />　　要避免这个问题，可以不要将NULL值传递给lpApplicationName参数，或者在lpCommandLine中使用双引号(转义符)括起可执行文件的全路径名，如下所示：<span class="Apple-converted-space">&nbsp;<br />　　CreateProcess(NULL,&rdquo;\&rdquo;C:\\Program Files\\MyApp.exe\&rdquo; -L -S&rdquo;,&hellip;&hellip;.)<span class="Apple-converted-space">&nbsp;<br />　　-L和-S是MyApp.exe可执行文件的参数。<span class="Apple-converted-space">&nbsp;<br />　　最后要说明的一点是：在lpApplicationName中的参数和lpCommandLine中的第一个参数是一样的，有人说显得有些重复，其实这样做纯粹是一种被公认化了习惯！<span class="Apple-converted-space">&nbsp;<br />　　参见<span class="Apple-converted-space">&nbsp;<br />　　AllocConsole, CloseHandle, CreateRemoteThread, CreateThread, ExitProcess, ExitThread, GenerateConsoleCtrlEvent, GetCommandLine,<span class="Apple-converted-space">&nbsp;<a href="http://baike.baidu.com/view/1228988.htm" target="_blank">GetEnvironmentStrings</a>, GetExitCodeProcess, GetFullPathName,<span class="Apple-converted-space">&nbsp;<a href="http://baike.baidu.com/view/1495671.htm" target="_blank">GetStartupInfo</a>, GetSystemDirectory, GetWindowsDirectory, LoadModule, OpenProcess, PROCESS_INFORMATION, ResumeThread, SECURITY_ATTRIBUTES, SetConsoleCtrlHandler, SetErrorMode, STARTUPINFO,<span class="Apple-converted-space">&nbsp;<a href="http://baike.baidu.com/view/1286885.htm" target="_blank">TerminateProcess</a>, WaitForInputIdle, WaitForDebugEvent, WinExec<span class="Apple-converted-space">&nbsp;<br />　　快捷信息：<span class="Apple-converted-space">&nbsp;<br />　　导入库：kernel32.lib<span class="Apple-converted-space">&nbsp;<br />　　头文件：Winbase.h<span class="Apple-converted-space">&nbsp;<br /><a href="http://baike.baidu.com/view/697167.htm">编辑本段</a><a name="4"></a>举例说明<br /><a name="4_1"></a>C代码<br />　　#include &lt;stdio.h&gt;<span class="Apple-converted-space">&nbsp;<br />　　#include &lt;windows.h&gt;<span class="Apple-converted-space">&nbsp;<br />　　int main(int argc, char *argv[])<span class="Apple-converted-space">&nbsp;<br />　　{<span class="Apple-converted-space">&nbsp;<br />　　char szCommandLine[] = "notepad";<span class="Apple-converted-space">&nbsp;<br />　　STARTUPINFO si = { sizeof(si) };<span class="Apple-converted-space">&nbsp;<br />　　PROCESS_INFORMATION pi;<span class="Apple-converted-space">&nbsp;<br />　　si.dwFlags = STARTF_USESHOWWINDOW; // 指定wShowWindow成员有效<span class="Apple-converted-space">&nbsp;<br />　　si.wShowWindow = TRUE; // 此成员设为TRUE的话则显示新建进程的主窗口<span class="Apple-converted-space">&nbsp;<br />　　BOOL bRet = CreateProcess (<span class="Apple-converted-space">&nbsp;<br />　　NULL, // 不在此指定可执行文件的文件名<span class="Apple-converted-space">&nbsp;<br />　　szCommandLine, // 命令行参数<span class="Apple-converted-space">&nbsp;<br />　　NULL, // 默认进程安全性<span class="Apple-converted-space">&nbsp;<br />　　NULL, // 默认进程安全性<span class="Apple-converted-space">&nbsp;<br />　　FALSE, // 指定当前进程内句柄不可以被子进程继承<span class="Apple-converted-space">&nbsp;<br />　　CREATE_NEW_CONSOLE, // 为新进程创建一个新的控制台窗口<span class="Apple-converted-space">&nbsp;<br />　　NULL, // 使用本进程的环境变量<span class="Apple-converted-space">&nbsp;<br />　　NULL, // 使用本进程的驱动器和目录<span class="Apple-converted-space">&nbsp;<br />　　&amp;si,<span class="Apple-converted-space">&nbsp;<br />　　&amp;pi) ;<span class="Apple-converted-space">&nbsp;<br />　　if(bRet)<span class="Apple-converted-space">&nbsp;<br />　　{<span class="Apple-converted-space">&nbsp;<br />　　// 不使用的句柄最好关掉<span class="Apple-converted-space">&nbsp;<br />　　CloseHandle(pi.hThread);<span class="Apple-converted-space">&nbsp;<br />　　CloseHandle(pi.hProcess);<span class="Apple-converted-space">&nbsp;<br />　　printf("新进程的ID号：%d\n",pi.dwProcessId);<span class="Apple-converted-space">&nbsp;<br />　　printf("新进程的主线程ID号：%d\n",pi.dwThreadId);<span class="Apple-converted-space">&nbsp;<br />　　}<span class="Apple-converted-space">&nbsp;<br />　　return 0;<span class="Apple-converted-space">&nbsp;<br />　　}<span class="Apple-converted-space">&nbsp;<br /><a name="4_2"></a>C++代码<br />　　#include &lt;iostream&gt;<span class="Apple-converted-space">&nbsp;<br />　　#include&lt;windows.h&gt;<span class="Apple-converted-space">&nbsp;<br />　　using namespace std;<span class="Apple-converted-space">&nbsp;<br />　　int main()<span class="Apple-converted-space">&nbsp;<br />　　{<span class="Apple-converted-space">&nbsp;<br />　　STARTUPINFO si; //一些必备参数设置<span class="Apple-converted-space">&nbsp;<br />　　memset(&amp;si, 0, sizeof(STARTUPINFO));<span class="Apple-converted-space">&nbsp;<br />　　si.cb = sizeof(STARTUPINFO);<span class="Apple-converted-space">&nbsp;<br />　　si.dwFlags = STARTF_USESHOWWINDOW;<span class="Apple-converted-space">&nbsp;<br />　　si.wShowWindow = SW_SHOW;<span class="Apple-converted-space">&nbsp;<br />　　PROCESS_INFORMATION pi; //必备参数设置结束<span class="Apple-converted-space">&nbsp;<br />　　if(!CreateProcess("c:\\windows\\system32\\notepad.exe",NULL,NULL,NULL,FALSE,0,NULL,NULL,&amp;si,&amp;pi))<span class="Apple-converted-space">&nbsp;<br />　　{<span class="Apple-converted-space">&nbsp;<br />　　cout&lt;&lt;"Create Fail!"&lt;&lt;endl;<span class="Apple-converted-space">&nbsp;<br />　　exit(1);<span class="Apple-converted-space">&nbsp;<br />　　}<span class="Apple-converted-space">&nbsp;<br />　　else<span class="Apple-converted-space">&nbsp;<br />　　{<span class="Apple-converted-space">&nbsp;<br />　　cout&lt;&lt;"Success!"&lt;&lt;endl;<span class="Apple-converted-space">&nbsp;<br />　　}<span class="Apple-converted-space">&nbsp;<br />　　return 0;<span class="Apple-converted-space">&nbsp;<br />　　}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>&nbsp;</p>
<p><span class="Apple-converted-space">转发于：<a href="https://www.cnblogs.com/ziliudi/p/5359333.html">https://www.cnblogs.com/ziliudi/p/5359333.html</a></span></p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>