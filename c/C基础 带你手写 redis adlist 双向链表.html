<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修C基础 带你手写 redis adlist 双向链表' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>C基础 带你手写 redis adlist 双向链表</center></div><div class='banquan'>原文出处:本文由博客园博主喜欢兰花山丘提供。<br/>
原文连接:https://www.cnblogs.com/life2refuel/p/11911839.html</div><br>
    <h2><span style="font-family: 'courier new', courier;">引言 - 导航栏目</span></h2>
<p><span style="font-family: 'courier new', courier;">　　有些朋友可能对 redis 充满着数不尽的求知欲, 也许是 redis 属于工作, 交流(面试)的大头戏,</span></p>
<p><span style="font-family: 'courier new', courier;">不得不 ...&nbsp;而自己当下对于 redis 只是停留在会用层面, 细节层面几乎没有涉猎. 为了更快的融于大</span></p>
<p><span style="font-family: 'courier new', courier;">家, 这里尝试抛砖引玉. 先带大家手写个 redis 中最简单的数据结构, adlist 双向链表. 让我们一</span></p>
<p><span style="font-family: 'courier new', courier;">起对 redis 有个初步的认知. 本文会从下面几个标题展开解读(吐槽), 欢迎交流和指正.</span></p>
<p><span style="font-size: 15px; font-family: 'courier new', courier;"><strong>　　1. redis adlist 解析</strong></span><br /><span style="font-size: 15px; font-family: 'courier new', courier;"><strong>　　2. redis config.h 分析</strong></span><br /><span style="font-size: 15px; font-family: 'courier new', courier;"><strong>　　3. redis setproctitle.c 分析</strong></span><br /><span style="font-size: 15px; font-family: 'courier new', courier;"><strong>　　4. redis atomicvar.h 分析</strong></span><br /><span style="font-size: 15px; font-family: 'courier new', courier;"><strong>　　5. redis zmalloc 分析</strong></span><br /><span style="font-size: 15px; font-family: 'courier new', courier;"><strong>　　6. redis Makefile 解析</strong></span></p>
<p><span style="font-family: 'courier new', courier;">redis 大头是 C 写的, 而 C 啥也不缺, 就缺手写, OK 开始废话手写之旅吧 :) </span></p>
<h2><span style="font-family: 'courier new', courier;">前言 - redis adlist　　　　　　</span></h2>
<p><span style="font-family: 'courier new', courier;">　　全篇示例代码都有手写过, 不过为了素材正规, 这里直接原封不动的引用&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;">github.com/antirez/redis&nbsp;中相关代码.</span></p>
<p><span style="font-family: 'courier new', courier;"><strong>1. redis adlist 解析</strong></span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;"> 1</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> adlist.h - A generic doubly linked list implementation
</span><span style="color: #008080;"> 2</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> * Copyright (c) 2006-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
</span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> * All rights reserved.
</span><span style="color: #008080;"> 5</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 6</span> <span style="color: #008000;"> * Redistribution and use in source and binary forms, with or without
</span><span style="color: #008080;"> 7</span> <span style="color: #008000;"> * modification, are permitted provided that the following conditions are met:
</span><span style="color: #008080;"> 8</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 9</span> <span style="color: #008000;"> *   * Redistributions of source code must retain the above copyright notice,
</span><span style="color: #008080;">10</span> <span style="color: #008000;"> *     this list of conditions and the following disclaimer.
</span><span style="color: #008080;">11</span> <span style="color: #008000;"> *   * Redistributions in binary form must reproduce the above copyright
</span><span style="color: #008080;">12</span> <span style="color: #008000;"> *     notice, this list of conditions and the following disclaimer in the
</span><span style="color: #008080;">13</span> <span style="color: #008000;"> *     documentation and/or other materials provided with the distribution.
</span><span style="color: #008080;">14</span> <span style="color: #008000;"> *   * Neither the name of Redis nor the names of its contributors may be used
</span><span style="color: #008080;">15</span> <span style="color: #008000;"> *     to endorse or promote products derived from this software without
</span><span style="color: #008080;">16</span> <span style="color: #008000;"> *     specific prior written permission.
</span><span style="color: #008080;">17</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">18</span> <span style="color: #008000;"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
</span><span style="color: #008080;">19</span> <span style="color: #008000;"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
</span><span style="color: #008080;">20</span> <span style="color: #008000;"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
</span><span style="color: #008080;">21</span> <span style="color: #008000;"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
</span><span style="color: #008080;">22</span> <span style="color: #008000;"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
</span><span style="color: #008080;">23</span> <span style="color: #008000;"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
</span><span style="color: #008080;">24</span> <span style="color: #008000;"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
</span><span style="color: #008080;">25</span> <span style="color: #008000;"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
</span><span style="color: #008080;">26</span> <span style="color: #008000;"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
</span><span style="color: #008080;">27</span> <span style="color: #008000;"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
</span><span style="color: #008080;">28</span> <span style="color: #008000;"> * POSSIBILITY OF SUCH DAMAGE.
</span><span style="color: #008080;">29</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span> <span style="color: #000000;">#ifndef __ADLIST_H__
</span><span style="color: #008080;">32</span> <span style="color: #0000ff;">#define</span> __ADLIST_H__
<span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Node, List, and Iterator are the only data structures used currently. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span> typedef <span style="color: #0000ff;">struct</span><span style="color: #000000;"> listNode {
</span><span style="color: #008080;">37</span>     <span style="color: #0000ff;">struct</span> listNode *<span style="color: #000000;">prev;
</span><span style="color: #008080;">38</span>     <span style="color: #0000ff;">struct</span> listNode *<span style="color: #000000;">next;
</span><span style="color: #008080;">39</span>     <span style="color: #0000ff;">void</span> *<span style="color: #000000;">value;
</span><span style="color: #008080;">40</span> <span style="color: #000000;">} listNode;
</span><span style="color: #008080;">41</span> 
<span style="color: #008080;">42</span> typedef <span style="color: #0000ff;">struct</span><span style="color: #000000;"> listIter {
</span><span style="color: #008080;">43</span>     listNode *<span style="color: #000000;">next;
</span><span style="color: #008080;">44</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> direction;
</span><span style="color: #008080;">45</span> <span style="color: #000000;">} listIter;
</span><span style="color: #008080;">46</span> 
<span style="color: #008080;">47</span> typedef <span style="color: #0000ff;">struct</span><span style="color: #000000;"> list {
</span><span style="color: #008080;">48</span>     listNode *<span style="color: #000000;">head;
</span><span style="color: #008080;">49</span>     listNode *<span style="color: #000000;">tail;
</span><span style="color: #008080;">50</span>     <span style="color: #0000ff;">void</span> *(*dup)(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;">51</span>     <span style="color: #0000ff;">void</span> (*<span style="color: #0000ff;">free</span>)(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;">52</span>     <span style="color: #0000ff;">int</span> (*match)(<span style="color: #0000ff;">void</span> *ptr, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">key);
</span><span style="color: #008080;">53</span>     unsigned <span style="color: #0000ff;">long</span><span style="color: #000000;"> len;
</span><span style="color: #008080;">54</span> <span style="color: #000000;">} list;
</span><span style="color: #008080;">55</span> 
<span style="color: #008080;">56</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Functions implemented as macros </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">57</span> <span style="color: #0000ff;">#define</span> listLength(l) ((l)-&gt;len)
<span style="color: #008080;">58</span> <span style="color: #0000ff;">#define</span> listFirst(l) ((l)-&gt;head)
<span style="color: #008080;">59</span> <span style="color: #0000ff;">#define</span> listLast(l) ((l)-&gt;tail)
<span style="color: #008080;">60</span> <span style="color: #0000ff;">#define</span> listPrevNode(n) ((n)-&gt;prev)
<span style="color: #008080;">61</span> <span style="color: #0000ff;">#define</span> listNextNode(n) ((n)-&gt;next)
<span style="color: #008080;">62</span> <span style="color: #0000ff;">#define</span> listNodeValue(n) ((n)-&gt;value)
<span style="color: #008080;">63</span> 
<span style="color: #008080;">64</span> <span style="color: #0000ff;">#define</span> listSetDupMethod(l,m) ((l)-&gt;dup = (m))
<span style="color: #008080;">65</span> <span style="color: #0000ff;">#define</span> listSetFreeMethod(l,m) ((l)-&gt;free = (m))
<span style="color: #008080;">66</span> <span style="color: #0000ff;">#define</span> listSetMatchMethod(l,m) ((l)-&gt;match = (m))
<span style="color: #008080;">67</span> 
<span style="color: #008080;">68</span> <span style="color: #0000ff;">#define</span> listGetDupMethod(l) ((l)-&gt;dup)
<span style="color: #008080;">69</span> <span style="color: #0000ff;">#define</span> listGetFreeMethod(l) ((l)-&gt;free)
<span style="color: #008080;">70</span> <span style="color: #0000ff;">#define</span> listGetMatchMethod(l) ((l)-&gt;match)
<span style="color: #008080;">71</span> 
<span style="color: #008080;">72</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Prototypes </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">73</span> list *listCreate(<span style="color: #0000ff;">void</span><span style="color: #000000;">);
</span><span style="color: #008080;">74</span> <span style="color: #0000ff;">void</span> listRelease(list *<span style="color: #000000;">list);
</span><span style="color: #008080;">75</span> <span style="color: #0000ff;">void</span> listEmpty(list *<span style="color: #000000;">list);
</span><span style="color: #008080;">76</span> list *listAddNodeHead(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">value);
</span><span style="color: #008080;">77</span> list *listAddNodeTail(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">value);
</span><span style="color: #008080;">78</span> list *listInsertNode(list *list, listNode *old_node, <span style="color: #0000ff;">void</span> *value, <span style="color: #0000ff;">int</span><span style="color: #000000;"> after);
</span><span style="color: #008080;">79</span> <span style="color: #0000ff;">void</span> listDelNode(list *list, listNode *<span style="color: #000000;">node);
</span><span style="color: #008080;">80</span> listIter *listGetIterator(list *list, <span style="color: #0000ff;">int</span><span style="color: #000000;"> direction);
</span><span style="color: #008080;">81</span> listNode *listNext(listIter *<span style="color: #000000;">iter);
</span><span style="color: #008080;">82</span> <span style="color: #0000ff;">void</span> listReleaseIterator(listIter *<span style="color: #000000;">iter);
</span><span style="color: #008080;">83</span> list *listDup(list *<span style="color: #000000;">orig);
</span><span style="color: #008080;">84</span> listNode *listSearchKey(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">key);
</span><span style="color: #008080;">85</span> listNode *listIndex(list *list, <span style="color: #0000ff;">long</span><span style="color: #000000;"> index);
</span><span style="color: #008080;">86</span> <span style="color: #0000ff;">void</span> listRewind(list *list, listIter *<span style="color: #000000;">li);
</span><span style="color: #008080;">87</span> <span style="color: #0000ff;">void</span> listRewindTail(list *list, listIter *<span style="color: #000000;">li);
</span><span style="color: #008080;">88</span> <span style="color: #0000ff;">void</span> listRotate(list *<span style="color: #000000;">list);
</span><span style="color: #008080;">89</span> <span style="color: #0000ff;">void</span> listJoin(list *l, list *<span style="color: #000000;">o);
</span><span style="color: #008080;">90</span> 
<span style="color: #008080;">91</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Directions for iterators </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">92</span> <span style="color: #0000ff;">#define</span> AL_START_HEAD 0
<span style="color: #008080;">93</span> <span style="color: #0000ff;">#define</span> AL_START_TAIL 1
<span style="color: #008080;">94</span> 
<span style="color: #008080;">95</span> <span style="color: #0000ff;">#endif</span> /* __ADLIST_H__ */</span></code></pre>

<p><span style="font-family: 'courier new', courier;">首先手写的是 adlist.h 双向链表的头文件, 对于这个头文件有几点要聊一聊的.&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;"><strong>1.1'</strong> redis 中<strong>头文件格式</strong>目前没有<strong>统一</strong></span></p>
<div class="cnblogs_code">
<pre><code><span style="color: #000000; font-family: 'courier new', courier;">#ifndef __ADLIST_H__    #endif
#ifndef __REDIS_HELP_H  #endif
#ifndef __ZMALLOC_H     #endif</span></code></pre>

<p><span style="font-family: 'courier new', courier;">可能也是, redis 这个项目维护和开发都十年多了. 代码风格在变(千奇百怪)也是正常.</span></p>
<p><span style="font-family: 'courier new', courier;">这里推荐第三种写法 -&gt; __{不带后缀文件名}_H</span></p>
<p><span style="font-family: 'courier new', courier;"><strong>1.2'</strong> adlist.h 中<strong>函数命名</strong>随意</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #0000ff;">void</span> listReleaseIterator(listIter *<span style="color: #000000;">iter);
list </span>*listDup(list *<span style="color: #000000;">orig);
listNode </span>*listSearchKey(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">key);
listNode </span>*listIndex(list *list, <span style="color: #0000ff;">long</span><span style="color: #000000;"> index);
</span><span style="color: #0000ff;">void</span> listRewind(list *list, listIter *<span style="color: #000000;">li);
</span><span style="color: #0000ff;">void</span> listRewindTail(list *list, listIter *<span style="color: #000000;">li);
</span><span style="color: #0000ff;">void</span> listRotate(list *<span style="color: #000000;">list);
</span><span style="color: #0000ff;">void</span> listJoin(list *l, list *o);</span></code></pre>

<p><span style="font-family: 'courier new', courier;">命名随意不是个好习惯, 推荐参数名强区分. 例如下面这样固定格式</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> listReleaseIterator(listIter *<span style="color: #000000;"> iter);
</span><span style="color: #0000ff;">extern</span> list * listDup(list *<span style="color: #000000;"> l);
</span><span style="color: #0000ff;">extern</span> listNode * listSearchKey(list * l, <span style="color: #0000ff;">void</span> *<span style="color: #000000;"> key);
</span><span style="color: #0000ff;">extern</span> listNode * listIndex(list * l, <span style="color: #0000ff;">long</span><span style="color: #000000;"> index);
</span><span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> listRewind(list * l, listIter *<span style="color: #000000;"> iter);
</span><span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> listRewindTail(list * l, listIter *<span style="color: #000000;"> iter);
</span><span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> listRotate(list *<span style="color: #000000;"> l);
</span><span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> listJoin(list * l, list * o);</span></code></pre>

<p><span style="font-family: 'courier new', courier;">写完 adlist.h 接口定义部分, 相信有些人对待实现的 adlist.c 也有了大致轮廓了吧 :)</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> adlist.c - A generic doubly linked list implementation
</span><span style="color: #008080;">  2</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  3</span> <span style="color: #008000;"> * Copyright (c) 2006-2010, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
</span><span style="color: #008080;">  4</span> <span style="color: #008000;"> * All rights reserved.
</span><span style="color: #008080;">  5</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  6</span> <span style="color: #008000;"> * Redistribution and use in source and binary forms, with or without
</span><span style="color: #008080;">  7</span> <span style="color: #008000;"> * modification, are permitted provided that the following conditions are met:
</span><span style="color: #008080;">  8</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  9</span> <span style="color: #008000;"> *   * Redistributions of source code must retain the above copyright notice,
</span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> *     this list of conditions and the following disclaimer.
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> *   * Redistributions in binary form must reproduce the above copyright
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> *     notice, this list of conditions and the following disclaimer in the
</span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> *     documentation and/or other materials provided with the distribution.
</span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> *   * Neither the name of Redis nor the names of its contributors may be used
</span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> *     to endorse or promote products derived from this software without
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> *     specific prior written permission.
</span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
</span><span style="color: #008080;"> 19</span> <span style="color: #008000;"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
</span><span style="color: #008080;"> 23</span> <span style="color: #008000;"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
</span><span style="color: #008080;"> 24</span> <span style="color: #008000;"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
</span><span style="color: #008080;"> 25</span> <span style="color: #008000;"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
</span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
</span><span style="color: #008080;"> 27</span> <span style="color: #008000;"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
</span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> * POSSIBILITY OF SUCH DAMAGE.
</span><span style="color: #008080;"> 29</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 30</span> 
<span style="color: #008080;"> 31</span> 
<span style="color: #008080;"> 32</span> #include &lt;stdlib.h&gt;
<span style="color: #008080;"> 33</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">adlist.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 34</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">zmalloc.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 35</span> 
<span style="color: #008080;"> 36</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Create a new list. The created list can be freed with
</span><span style="color: #008080;"> 37</span> <span style="color: #008000;"> * AlFreeList(), but private value of every node need to be freed
</span><span style="color: #008080;"> 38</span> <span style="color: #008000;"> * by the user before to call AlFreeList().
</span><span style="color: #008080;"> 39</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 40</span> <span style="color: #008000;"> * On error, NULL is returned. Otherwise the pointer to the new list. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 41</span> list *listCreate(<span style="color: #0000ff;">void</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 42</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">struct</span> list *<span style="color: #000000;">list;
</span><span style="color: #008080;"> 44</span> 
<span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">if</span> ((list = zmalloc(<span style="color: #0000ff;">sizeof</span>(*list))) ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 47</span>     list-&gt;head = list-&gt;tail =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 48</span>     list-&gt;len = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 49</span>     list-&gt;dup =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 50</span>     list-&gt;<span style="color: #0000ff;">free</span> =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 51</span>     list-&gt;match =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;
</span><span style="color: #008080;"> 53</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 54</span> 
<span style="color: #008080;"> 55</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Remove all the elements from the list without destroying the list itself. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 56</span> <span style="color: #0000ff;">void</span> listEmpty(list *<span style="color: #000000;">list)
</span><span style="color: #008080;"> 57</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 58</span>     unsigned <span style="color: #0000ff;">long</span><span style="color: #000000;"> len;
</span><span style="color: #008080;"> 59</span>     listNode *current, *<span style="color: #000000;">next;
</span><span style="color: #008080;"> 60</span> 
<span style="color: #008080;"> 61</span>     current = list-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;"> 62</span>     len = list-&gt;<span style="color: #000000;">len;
</span><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">while</span>(len--<span style="color: #000000;">) {
</span><span style="color: #008080;"> 64</span>         next = current-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">if</span> (list-&gt;<span style="color: #0000ff;">free</span>) list-&gt;<span style="color: #0000ff;">free</span>(current-&gt;<span style="color: #000000;">value);
</span><span style="color: #008080;"> 66</span> <span style="color: #000000;">        zfree(current);
</span><span style="color: #008080;"> 67</span>         current =<span style="color: #000000;"> next;
</span><span style="color: #008080;"> 68</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 69</span>     list-&gt;head = list-&gt;tail =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 70</span>     list-&gt;len = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 71</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 72</span> 
<span style="color: #008080;"> 73</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Free the whole list.
</span><span style="color: #008080;"> 74</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 75</span> <span style="color: #008000;"> * This function can't fail. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 76</span> <span style="color: #0000ff;">void</span> listRelease(list *<span style="color: #000000;">list)
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 78</span> <span style="color: #000000;">    listEmpty(list);
</span><span style="color: #008080;"> 79</span> <span style="color: #000000;">    zfree(list);
</span><span style="color: #008080;"> 80</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 81</span> 
<span style="color: #008080;"> 82</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Add a new node to the list, to head, containing the specified 'value'
</span><span style="color: #008080;"> 83</span> <span style="color: #008000;"> * pointer as value.
</span><span style="color: #008080;"> 84</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 85</span> <span style="color: #008000;"> * On error, NULL is returned and no operation is performed (i.e. the
</span><span style="color: #008080;"> 86</span> <span style="color: #008000;"> * list remains unaltered).
</span><span style="color: #008080;"> 87</span> <span style="color: #008000;"> * On success the 'list' pointer you pass to the function is returned. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 88</span> list *listAddNodeHead(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">value)
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 90</span>     listNode *<span style="color: #000000;">node;
</span><span style="color: #008080;"> 91</span> 
<span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">if</span> ((node = zmalloc(<span style="color: #0000ff;">sizeof</span>(*node))) ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 94</span>     node-&gt;value =<span style="color: #000000;"> value;
</span><span style="color: #008080;"> 95</span>     <span style="color: #0000ff;">if</span> (list-&gt;len == <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 96</span>         list-&gt;head = list-&gt;tail =<span style="color: #000000;"> node;
</span><span style="color: #008080;"> 97</span>         node-&gt;prev = node-&gt;next =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 98</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 99</span>         node-&gt;prev =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;">100</span>         node-&gt;next = list-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">101</span>         list-&gt;head-&gt;prev =<span style="color: #000000;"> node;
</span><span style="color: #008080;">102</span>         list-&gt;head =<span style="color: #000000;"> node;
</span><span style="color: #008080;">103</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">104</span>     list-&gt;len++<span style="color: #000000;">;
</span><span style="color: #008080;">105</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;
</span><span style="color: #008080;">106</span> <span style="color: #000000;">}
</span><span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Add a new node to the list, to tail, containing the specified 'value'
</span><span style="color: #008080;">109</span> <span style="color: #008000;"> * pointer as value.
</span><span style="color: #008080;">110</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">111</span> <span style="color: #008000;"> * On error, NULL is returned and no operation is performed (i.e. the
</span><span style="color: #008080;">112</span> <span style="color: #008000;"> * list remains unaltered).
</span><span style="color: #008080;">113</span> <span style="color: #008000;"> * On success the 'list' pointer you pass to the function is returned. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">114</span> list *listAddNodeTail(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">value)
</span><span style="color: #008080;">115</span> <span style="color: #000000;">{
</span><span style="color: #008080;">116</span>     listNode *<span style="color: #000000;">node;
</span><span style="color: #008080;">117</span> 
<span style="color: #008080;">118</span>     <span style="color: #0000ff;">if</span> ((node = zmalloc(<span style="color: #0000ff;">sizeof</span>(*node))) ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;">119</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">120</span>     node-&gt;value =<span style="color: #000000;"> value;
</span><span style="color: #008080;">121</span>     <span style="color: #0000ff;">if</span> (list-&gt;len == <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;">122</span>         list-&gt;head = list-&gt;tail =<span style="color: #000000;"> node;
</span><span style="color: #008080;">123</span>         node-&gt;prev = node-&gt;next =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;">124</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">125</span>         node-&gt;prev = list-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">126</span>         node-&gt;next =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;">127</span>         list-&gt;tail-&gt;next =<span style="color: #000000;"> node;
</span><span style="color: #008080;">128</span>         list-&gt;tail =<span style="color: #000000;"> node;
</span><span style="color: #008080;">129</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">130</span>     list-&gt;len++<span style="color: #000000;">;
</span><span style="color: #008080;">131</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;
</span><span style="color: #008080;">132</span> <span style="color: #000000;">}
</span><span style="color: #008080;">133</span> 
<span style="color: #008080;">134</span> list *listInsertNode(list *list, listNode *old_node, <span style="color: #0000ff;">void</span> *value, <span style="color: #0000ff;">int</span><span style="color: #000000;"> after) {
</span><span style="color: #008080;">135</span>     listNode *<span style="color: #000000;">node;
</span><span style="color: #008080;">136</span> 
<span style="color: #008080;">137</span>     <span style="color: #0000ff;">if</span> ((node = zmalloc(<span style="color: #0000ff;">sizeof</span>(*node))) ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">139</span>     node-&gt;value =<span style="color: #000000;"> value;
</span><span style="color: #008080;">140</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (after) {
</span><span style="color: #008080;">141</span>         node-&gt;prev =<span style="color: #000000;"> old_node;
</span><span style="color: #008080;">142</span>         node-&gt;next = old_node-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;">143</span>         <span style="color: #0000ff;">if</span> (list-&gt;tail ==<span style="color: #000000;"> old_node) {
</span><span style="color: #008080;">144</span>             list-&gt;tail =<span style="color: #000000;"> node;
</span><span style="color: #008080;">145</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">146</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">147</span>         node-&gt;next =<span style="color: #000000;"> old_node;
</span><span style="color: #008080;">148</span>         node-&gt;prev = old_node-&gt;<span style="color: #000000;">prev;
</span><span style="color: #008080;">149</span>         <span style="color: #0000ff;">if</span> (list-&gt;head ==<span style="color: #000000;"> old_node) {
</span><span style="color: #008080;">150</span>             list-&gt;head =<span style="color: #000000;"> node;
</span><span style="color: #008080;">151</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">152</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">153</span>     <span style="color: #0000ff;">if</span> (node-&gt;prev !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">154</span>         node-&gt;prev-&gt;next =<span style="color: #000000;"> node;
</span><span style="color: #008080;">155</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">156</span>     <span style="color: #0000ff;">if</span> (node-&gt;next !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">157</span>         node-&gt;next-&gt;prev =<span style="color: #000000;"> node;
</span><span style="color: #008080;">158</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">159</span>     list-&gt;len++<span style="color: #000000;">;
</span><span style="color: #008080;">160</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;
</span><span style="color: #008080;">161</span> <span style="color: #000000;">}
</span><span style="color: #008080;">162</span> 
<span style="color: #008080;">163</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Remove the specified node from the specified list.
</span><span style="color: #008080;">164</span> <span style="color: #008000;"> * It's up to the caller to free the private value of the node.
</span><span style="color: #008080;">165</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">166</span> <span style="color: #008000;"> * This function can't fail. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">167</span> <span style="color: #0000ff;">void</span> listDelNode(list *list, listNode *<span style="color: #000000;">node)
</span><span style="color: #008080;">168</span> <span style="color: #000000;">{
</span><span style="color: #008080;">169</span>     <span style="color: #0000ff;">if</span> (node-&gt;<span style="color: #000000;">prev)
</span><span style="color: #008080;">170</span>         node-&gt;prev-&gt;next = node-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;">171</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">172</span>         list-&gt;head = node-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;">173</span>     <span style="color: #0000ff;">if</span> (node-&gt;<span style="color: #000000;">next)
</span><span style="color: #008080;">174</span>         node-&gt;next-&gt;prev = node-&gt;<span style="color: #000000;">prev;
</span><span style="color: #008080;">175</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">176</span>         list-&gt;tail = node-&gt;<span style="color: #000000;">prev;
</span><span style="color: #008080;">177</span>     <span style="color: #0000ff;">if</span> (list-&gt;<span style="color: #0000ff;">free</span>) list-&gt;<span style="color: #0000ff;">free</span>(node-&gt;<span style="color: #000000;">value);
</span><span style="color: #008080;">178</span> <span style="color: #000000;">    zfree(node);
</span><span style="color: #008080;">179</span>     list-&gt;len--<span style="color: #000000;">;
</span><span style="color: #008080;">180</span> <span style="color: #000000;">}
</span><span style="color: #008080;">181</span> 
<span style="color: #008080;">182</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Returns a list iterator 'iter'. After the initialization every
</span><span style="color: #008080;">183</span> <span style="color: #008000;"> * call to listNext() will return the next element of the list.
</span><span style="color: #008080;">184</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">185</span> <span style="color: #008000;"> * This function can't fail. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">186</span> listIter *listGetIterator(list *list, <span style="color: #0000ff;">int</span><span style="color: #000000;"> direction)
</span><span style="color: #008080;">187</span> <span style="color: #000000;">{
</span><span style="color: #008080;">188</span>     listIter *<span style="color: #000000;">iter;
</span><span style="color: #008080;">189</span> 
<span style="color: #008080;">190</span>     <span style="color: #0000ff;">if</span> ((iter = zmalloc(<span style="color: #0000ff;">sizeof</span>(*iter))) == NULL) <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">191</span>     <span style="color: #0000ff;">if</span> (direction ==<span style="color: #000000;"> AL_START_HEAD)
</span><span style="color: #008080;">192</span>         iter-&gt;next = list-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">193</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">194</span>         iter-&gt;next = list-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">195</span>     iter-&gt;direction =<span style="color: #000000;"> direction;
</span><span style="color: #008080;">196</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> iter;
</span><span style="color: #008080;">197</span> <span style="color: #000000;">}
</span><span style="color: #008080;">198</span> 
<span style="color: #008080;">199</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Release the iterator memory </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">200</span> <span style="color: #0000ff;">void</span> listReleaseIterator(listIter *<span style="color: #000000;">iter) {
</span><span style="color: #008080;">201</span> <span style="color: #000000;">    zfree(iter);
</span><span style="color: #008080;">202</span> <span style="color: #000000;">}
</span><span style="color: #008080;">203</span> 
<span style="color: #008080;">204</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Create an iterator in the list private iterator structure </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">205</span> <span style="color: #0000ff;">void</span> listRewind(list *list, listIter *<span style="color: #000000;">li) {
</span><span style="color: #008080;">206</span>     li-&gt;next = list-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">207</span>     li-&gt;direction =<span style="color: #000000;"> AL_START_HEAD;
</span><span style="color: #008080;">208</span> <span style="color: #000000;">}
</span><span style="color: #008080;">209</span> 
<span style="color: #008080;">210</span> <span style="color: #0000ff;">void</span> listRewindTail(list *list, listIter *<span style="color: #000000;">li) {
</span><span style="color: #008080;">211</span>     li-&gt;next = list-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">212</span>     li-&gt;direction =<span style="color: #000000;"> AL_START_TAIL;
</span><span style="color: #008080;">213</span> <span style="color: #000000;">}
</span><span style="color: #008080;">214</span> 
<span style="color: #008080;">215</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Return the next element of an iterator.
</span><span style="color: #008080;">216</span> <span style="color: #008000;"> * It's valid to remove the currently returned element using
</span><span style="color: #008080;">217</span> <span style="color: #008000;"> * listDelNode(), but not to remove other elements.
</span><span style="color: #008080;">218</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">219</span> <span style="color: #008000;"> * The function returns a pointer to the next element of the list,
</span><span style="color: #008080;">220</span> <span style="color: #008000;"> * or NULL if there are no more elements, so the classical usage patter
</span><span style="color: #008080;">221</span> <span style="color: #008000;"> * is:
</span><span style="color: #008080;">222</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">223</span> <span style="color: #008000;"> * iter = listGetIterator(list,&lt;direction&gt;);
</span><span style="color: #008080;">224</span> <span style="color: #008000;"> * while ((node = listNext(iter)) != NULL) {
</span><span style="color: #008080;">225</span> <span style="color: #008000;"> *     doSomethingWith(listNodeValue(node));
</span><span style="color: #008080;">226</span> <span style="color: #008000;"> * }
</span><span style="color: #008080;">227</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">228</span> <span style="color: #008000;"> * </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">229</span> listNode *listNext(listIter *<span style="color: #000000;">iter)
</span><span style="color: #008080;">230</span> <span style="color: #000000;">{
</span><span style="color: #008080;">231</span>     listNode *current = iter-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;">232</span> 
<span style="color: #008080;">233</span>     <span style="color: #0000ff;">if</span> (current !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">234</span>         <span style="color: #0000ff;">if</span> (iter-&gt;direction ==<span style="color: #000000;"> AL_START_HEAD)
</span><span style="color: #008080;">235</span>             iter-&gt;next = current-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;">236</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">237</span>             iter-&gt;next = current-&gt;<span style="color: #000000;">prev;
</span><span style="color: #008080;">238</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">239</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> current;
</span><span style="color: #008080;">240</span> <span style="color: #000000;">}
</span><span style="color: #008080;">241</span> 
<span style="color: #008080;">242</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Duplicate the whole list. On out of memory NULL is returned.
</span><span style="color: #008080;">243</span> <span style="color: #008000;"> * On success a copy of the original list is returned.
</span><span style="color: #008080;">244</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">245</span> <span style="color: #008000;"> * The 'Dup' method set with listSetDupMethod() function is used
</span><span style="color: #008080;">246</span> <span style="color: #008000;"> * to copy the node value. Otherwise the same pointer value of
</span><span style="color: #008080;">247</span> <span style="color: #008000;"> * the original node is used as value of the copied node.
</span><span style="color: #008080;">248</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">249</span> <span style="color: #008000;"> * The original list both on success or error is never modified. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">250</span> list *listDup(list *<span style="color: #000000;">orig)
</span><span style="color: #008080;">251</span> <span style="color: #000000;">{
</span><span style="color: #008080;">252</span>     list *<span style="color: #000000;">copy;
</span><span style="color: #008080;">253</span> <span style="color: #000000;">    listIter iter;
</span><span style="color: #008080;">254</span>     listNode *<span style="color: #000000;">node;
</span><span style="color: #008080;">255</span> 
<span style="color: #008080;">256</span>     <span style="color: #0000ff;">if</span> ((copy = listCreate()) ==<span style="color: #000000;"> NULL)
</span><span style="color: #008080;">257</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">258</span>     copy-&gt;dup = orig-&gt;<span style="color: #000000;">dup;
</span><span style="color: #008080;">259</span>     copy-&gt;<span style="color: #0000ff;">free</span> = orig-&gt;<span style="color: #0000ff;">free</span><span style="color: #000000;">;
</span><span style="color: #008080;">260</span>     copy-&gt;match = orig-&gt;<span style="color: #000000;">match;
</span><span style="color: #008080;">261</span>     listRewind(orig, &amp;<span style="color: #000000;">iter);
</span><span style="color: #008080;">262</span>     <span style="color: #0000ff;">while</span>((node = listNext(&amp;iter)) !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">263</span>         <span style="color: #0000ff;">void</span> *<span style="color: #000000;">value;
</span><span style="color: #008080;">264</span> 
<span style="color: #008080;">265</span>         <span style="color: #0000ff;">if</span> (copy-&gt;<span style="color: #000000;">dup) {
</span><span style="color: #008080;">266</span>             value = copy-&gt;dup(node-&gt;<span style="color: #000000;">value);
</span><span style="color: #008080;">267</span>             <span style="color: #0000ff;">if</span> (value ==<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">268</span> <span style="color: #000000;">                listRelease(copy);
</span><span style="color: #008080;">269</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">270</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">271</span>         } <span style="color: #0000ff;">else</span>
<span style="color: #008080;">272</span>             value = node-&gt;<span style="color: #000000;">value;
</span><span style="color: #008080;">273</span>         <span style="color: #0000ff;">if</span> (listAddNodeTail(copy, value) ==<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">274</span> <span style="color: #000000;">            listRelease(copy);
</span><span style="color: #008080;">275</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">276</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">277</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">278</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> copy;
</span><span style="color: #008080;">279</span> <span style="color: #000000;">}
</span><span style="color: #008080;">280</span> 
<span style="color: #008080;">281</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Search the list for a node matching a given key.
</span><span style="color: #008080;">282</span> <span style="color: #008000;"> * The match is performed using the 'match' method
</span><span style="color: #008080;">283</span> <span style="color: #008000;"> * set with listSetMatchMethod(). If no 'match' method
</span><span style="color: #008080;">284</span> <span style="color: #008000;"> * is set, the 'value' pointer of every node is directly
</span><span style="color: #008080;">285</span> <span style="color: #008000;"> * compared with the 'key' pointer.
</span><span style="color: #008080;">286</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">287</span> <span style="color: #008000;"> * On success the first matching node pointer is returned
</span><span style="color: #008080;">288</span> <span style="color: #008000;"> * (search starts from head). If no matching node exists
</span><span style="color: #008080;">289</span> <span style="color: #008000;"> * NULL is returned. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">290</span> listNode *listSearchKey(list *list, <span style="color: #0000ff;">void</span> *<span style="color: #000000;">key)
</span><span style="color: #008080;">291</span> <span style="color: #000000;">{
</span><span style="color: #008080;">292</span> <span style="color: #000000;">    listIter iter;
</span><span style="color: #008080;">293</span>     listNode *<span style="color: #000000;">node;
</span><span style="color: #008080;">294</span> 
<span style="color: #008080;">295</span>     listRewind(list, &amp;<span style="color: #000000;">iter);
</span><span style="color: #008080;">296</span>     <span style="color: #0000ff;">while</span>((node = listNext(&amp;iter)) !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">297</span>         <span style="color: #0000ff;">if</span> (list-&gt;<span style="color: #000000;">match) {
</span><span style="color: #008080;">298</span>             <span style="color: #0000ff;">if</span> (list-&gt;match(node-&gt;<span style="color: #000000;">value, key)) {
</span><span style="color: #008080;">299</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> node;
</span><span style="color: #008080;">300</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">301</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">302</span>             <span style="color: #0000ff;">if</span> (key == node-&gt;<span style="color: #000000;">value) {
</span><span style="color: #008080;">303</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> node;
</span><span style="color: #008080;">304</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">305</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">306</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">307</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">308</span> <span style="color: #000000;">}
</span><span style="color: #008080;">309</span> 
<span style="color: #008080;">310</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Return the element at the specified zero-based index
</span><span style="color: #008080;">311</span> <span style="color: #008000;"> * where 0 is the head, 1 is the element next to head
</span><span style="color: #008080;">312</span> <span style="color: #008000;"> * and so on. Negative integers are used in order to count
</span><span style="color: #008080;">313</span> <span style="color: #008000;"> * from the tail, -1 is the last element, -2 the penultimate
</span><span style="color: #008080;">314</span> <span style="color: #008000;"> * and so on. If the index is out of range NULL is returned. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">315</span> listNode *listIndex(list *list, <span style="color: #0000ff;">long</span><span style="color: #000000;"> index) {
</span><span style="color: #008080;">316</span>     listNode *<span style="color: #000000;">n;
</span><span style="color: #008080;">317</span> 
<span style="color: #008080;">318</span>     <span style="color: #0000ff;">if</span> (index &lt; <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;">319</span>         index = (-index)-<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">320</span>         n = list-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">321</span>         <span style="color: #0000ff;">while</span>(index-- &amp;&amp; n) n = n-&gt;<span style="color: #000000;">prev;
</span><span style="color: #008080;">322</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">323</span>         n = list-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">324</span>         <span style="color: #0000ff;">while</span>(index-- &amp;&amp; n) n = n-&gt;<span style="color: #000000;">next;
</span><span style="color: #008080;">325</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">326</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> n;
</span><span style="color: #008080;">327</span> <span style="color: #000000;">}
</span><span style="color: #008080;">328</span> 
<span style="color: #008080;">329</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Rotate the list removing the tail node and inserting it to the head. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">330</span> <span style="color: #0000ff;">void</span> listRotate(list *<span style="color: #000000;">list) {
</span><span style="color: #008080;">331</span>     listNode *tail = list-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">332</span> 
<span style="color: #008080;">333</span>     <span style="color: #0000ff;">if</span> (listLength(list) &lt;= <span style="color: #800080;">1</span>) <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">334</span> 
<span style="color: #008080;">335</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Detach current tail </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">336</span>     list-&gt;tail = tail-&gt;<span style="color: #000000;">prev;
</span><span style="color: #008080;">337</span>     list-&gt;tail-&gt;next =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;">338</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Move it as head </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">339</span>     list-&gt;head-&gt;prev =<span style="color: #000000;"> tail;
</span><span style="color: #008080;">340</span>     tail-&gt;prev =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;">341</span>     tail-&gt;next = list-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">342</span>     list-&gt;head =<span style="color: #000000;"> tail;
</span><span style="color: #008080;">343</span> <span style="color: #000000;">}
</span><span style="color: #008080;">344</span> 
<span style="color: #008080;">345</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Add all the elements of the list 'o' at the end of the
</span><span style="color: #008080;">346</span> <span style="color: #008000;"> * list 'l'. The list 'other' remains empty but otherwise valid. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">347</span> <span style="color: #0000ff;">void</span> listJoin(list *l, list *<span style="color: #000000;">o) {
</span><span style="color: #008080;">348</span>     <span style="color: #0000ff;">if</span> (o-&gt;<span style="color: #000000;">head)
</span><span style="color: #008080;">349</span>         o-&gt;head-&gt;prev = l-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">350</span> 
<span style="color: #008080;">351</span>     <span style="color: #0000ff;">if</span> (l-&gt;<span style="color: #000000;">tail)
</span><span style="color: #008080;">352</span>         l-&gt;tail-&gt;next = o-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">353</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">354</span>         l-&gt;head = o-&gt;<span style="color: #000000;">head;
</span><span style="color: #008080;">355</span> 
<span style="color: #008080;">356</span>     <span style="color: #0000ff;">if</span> (o-&gt;tail) l-&gt;tail = o-&gt;<span style="color: #000000;">tail;
</span><span style="color: #008080;">357</span>     l-&gt;len += o-&gt;<span style="color: #000000;">len;
</span><span style="color: #008080;">358</span> 
<span style="color: #008080;">359</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Setup other as an empty list. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">360</span>     o-&gt;head = o-&gt;tail =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;">361</span>     o-&gt;len = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">362</span> }</span></code></pre>

<p><span style="font-family: 'courier new', courier;">是的, 就是这样, 就是这样简单.&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;">我们稍微多讲点, 其实对于 listCreate 可以写的更加简约, 不是吗?&nbsp;</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #0000ff;">struct</span> list * listCreate(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
    </span><span style="color: #0000ff;">return</span> zcalloc(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">struct</span><span style="color: #000000;"> list));  
}</span></span></code></pre>

<p><span style="font-family: 'courier new', courier;">好了, 那我们继续交流(吐槽)吧.</span></p>
<p><span style="font-family: 'courier new', courier;">&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;"><strong>1.3' 代码括号 { } 位置随意</strong></span></p>
<p><span style="font-family: 'courier new', courier;">这不是个好习惯, 毕竟谁也不喜欢两面派. 大项目还是得需要在大方向上统一风格和约束.</span></p>
<p><span style="font-family: 'courier new', courier;">&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;"><strong>1.4'</strong>&nbsp;<strong>struct listIter::direction</strong> 不一定是个很好的设计</span></p>
<p><span style="font-family: 'courier new', courier;">direction 通过与 AL_START_HEAD or AL_START_TAIL 宏进行运行时比对, 来区分遍历的方向.&nbsp;觉得</span></p>
<p><span style="font-family: 'courier new', courier;">有点浪费.&nbsp;内心更倾向于干掉运行时比对, 从一开始用户就应该知道该怎么遍历更好,&nbsp;毕竟这是所有数据结构</span></p>
<p><span style="font-family: 'courier new', courier;">的标杆.&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;">&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;">❤ 恭喜大家, 到这我们关于 redis adlist 最基础最简单的数据结构已经手写分析完毕, 后面可以不用看了.</span></p>
<p><span style="font-family: 'courier new', courier;">谢谢大家捧场 ~&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;">&nbsp;</span></p>
<h2><span style="font-family: 'courier new', courier;">正文 - adlist 周边</span></h2>
<p><span style="font-family: 'courier new', courier;">　　 简单愉快的背后总会有些更深的不可捉摸. 离开了奶头乐, 我们将从 adlist.c 中一行代码, 正式开启</span></p>
<p><span style="font-family: 'courier new', courier;">我们此次探险之旅.</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #000000;">#include </span><span style="color: #800000;">"</span><span style="color: #800000;">zmalloc.h</span><span style="color: #800000;">"</span></span></code></pre>

<p><span style="font-family: 'courier new', courier; font-size: 15px;"><strong>2. redis config.h 分析</strong></span></p>
<p><span style="font-family: 'courier new', courier;">　　同样在 zmallo.c 中我们发现了如下两行代码, 这就是我们要说的一个主体之一 config.h</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;">#include <span style="color: #800000;">"</span><span style="color: #800000;">config.h</span><span style="color: #800000;">"</span><span style="color: #000000;">
#include </span><span style="color: #800000;">"</span><span style="color: #800000;">atomicvar.h</span><span style="color: #800000;">"</span></span></code></pre>

<p><span style="font-family: 'courier new', courier;">config.h 主要作用是用于确定程序的运行环境, 例如是什么操作系统, 是什么字节序, 要不要启用某些功能</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008000;">/*</span><span style="color: #008000;">
 * Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *   * Redistributions of source code must retain the above copyright notice,
 *     this list of conditions and the following disclaimer.
 *   * Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 *   * Neither the name of Redis nor the names of its contributors may be used
 *     to endorse or promote products derived from this software without
 *     specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 </span><span style="color: #008000;">*/</span><span style="color: #000000;">

#ifndef __CONFIG_H
</span><span style="color: #0000ff;">#define</span> __CONFIG_H<span style="color: #000000;">

#ifdef __APPLE__
#include </span>&lt;AvailabilityMacros.h&gt;
<span style="color: #0000ff;">#endif</span><span style="color: #000000;">

#ifdef __linux__
#include </span>&lt;linux/version.h&gt;<span style="color: #000000;">
#include </span>&lt;features.h&gt;
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Define redis_fstat to fstat or fstat64() </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#if</span> defined(__APPLE__) &amp;&amp; !defined(MAC_OS_X_VERSION_10_6)
<span style="color: #0000ff;">#define</span> redis_fstat fstat64
<span style="color: #0000ff;">#define</span> redis_stat stat64
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#define</span> redis_fstat fstat
<span style="color: #0000ff;">#define</span> redis_stat stat
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Test for proc filesystem </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifdef __linux__
</span><span style="color: #0000ff;">#define</span> HAVE_PROC_STAT 1
<span style="color: #0000ff;">#define</span> HAVE_PROC_MAPS 1
<span style="color: #0000ff;">#define</span> HAVE_PROC_SMAPS 1
<span style="color: #0000ff;">#define</span> HAVE_PROC_SOMAXCONN 1
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Test for task_info() </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#if</span> defined(__APPLE__)
<span style="color: #0000ff;">#define</span> HAVE_TASKINFO 1
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Test for backtrace() </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#if</span> defined(__APPLE__) || (defined(__linux__) &amp;&amp; defined(__GLIBC__)) || \<span style="color: #000000;">
    defined(__FreeBSD__) </span>|| (defined(__OpenBSD__) &amp;&amp;<span style="color: #000000;"> defined(USE_BACKTRACE))\
 </span>||<span style="color: #000000;"> defined(__DragonFly__)
</span><span style="color: #0000ff;">#define</span> HAVE_BACKTRACE 1
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> MSG_NOSIGNAL. </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifdef __linux__
</span><span style="color: #0000ff;">#define</span> HAVE_MSG_NOSIGNAL 1
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Test for polling API </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifdef __linux__
</span><span style="color: #0000ff;">#define</span> HAVE_EPOLL 1
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#if</span> (defined(__APPLE__) &amp;&amp; defined(MAC_OS_X_VERSION_10_6)) || defined(__FreeBSD__) || defined(__OpenBSD__) || defined (__NetBSD__)
<span style="color: #0000ff;">#define</span> HAVE_KQUEUE 1
<span style="color: #0000ff;">#endif</span><span style="color: #000000;">

#ifdef __sun
#include </span>&lt;sys/feature_tests.h&gt;<span style="color: #000000;">
#ifdef _DTRACE_VERSION
</span><span style="color: #0000ff;">#define</span> HAVE_EVPORT 1
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Define redis_fsync to fdatasync() in Linux and fsync() for all the rest </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifdef __linux__
</span><span style="color: #0000ff;">#define</span> redis_fsync fdatasync
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#define</span> redis_fsync fsync
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Define rdb_fsync_range to sync_file_range() on Linux, otherwise we use
 * the plain fsync() call. </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifdef __linux__
</span><span style="color: #0000ff;">#if</span> defined(__GLIBC__) &amp;&amp; defined(__GLIBC_PREREQ)
<span style="color: #0000ff;">#if</span> (LINUX_VERSION_CODE &gt;= 0x020611 &amp;&amp; __GLIBC_PREREQ(2, 6))
<span style="color: #0000ff;">#define</span> HAVE_SYNC_FILE_RANGE 1
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#if</span> (LINUX_VERSION_CODE &gt;= 0x020611)
<span style="color: #0000ff;">#define</span> HAVE_SYNC_FILE_RANGE 1
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span><span style="color: #000000;">

#ifdef HAVE_SYNC_FILE_RANGE
</span><span style="color: #0000ff;">#define</span> rdb_fsync_range(fd,off,size) sync_file_range(fd,off,size,SYNC_FILE_RANGE_WAIT_BEFORE|SYNC_FILE_RANGE_WRITE)
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#define</span> rdb_fsync_range(fd,off,size) fsync(fd)
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Check if we can use setproctitle().
 * BSD systems have support for it, we provide an implementation for
 * Linux and osx. </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#if</span> (defined __NetBSD__ || defined __FreeBSD__ || defined __OpenBSD__)
<span style="color: #0000ff;">#define</span> USE_SETPROCTITLE
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#if</span> ((defined __linux &amp;&amp; defined(__GLIBC__)) || defined __APPLE__)
<span style="color: #0000ff;">#define</span> USE_SETPROCTITLE
<span style="color: #0000ff;">#define</span> INIT_SETPROCTITLE_REPLACEMENT
<span style="color: #0000ff;">void</span> spt_init(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> *<span style="color: #000000;">argv[]);
</span><span style="color: #0000ff;">void</span> setproctitle(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">fmt, ...);
</span><span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Byte ordering detection </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#include </span>&lt;sys/types.h&gt; <span style="color: #008000;">/*</span><span style="color: #008000;"> This will likely define BYTE_ORDER </span><span style="color: #008000;">*/</span><span style="color: #000000;">

#ifndef BYTE_ORDER
</span><span style="color: #0000ff;">#if</span> (BSD &gt;= 199103)<span style="color: #000000;">
# include </span>&lt;machine/endian.h&gt;
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#if</span> defined(linux) || defined(__linux__)<span style="color: #000000;">
# include </span>&lt;endian.h&gt;
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#define</span>    LITTLE_ENDIAN    1234    /* least-significant byte first (vax, pc) */
<span style="color: #0000ff;">#define</span>    BIG_ENDIAN    4321    /* most-significant byte first (IBM, net) */
<span style="color: #0000ff;">#define</span>    PDP_ENDIAN    3412    /* LSB first in word, MSW first in long (pdp)*/

<span style="color: #0000ff;">#if</span> defined(__i386__) || defined(__x86_64__) || defined(__amd64__) || \<span style="color: #000000;">
   defined(vax) </span>|| defined(ns32000) || defined(sun386) ||<span style="color: #000000;"> \
   defined(MIPSEL) </span>|| defined(_MIPSEL) || defined(BIT_ZERO_ON_RIGHT) ||<span style="color: #000000;"> \
   defined(__alpha__) </span>||<span style="color: #000000;"> defined(__alpha)
</span><span style="color: #0000ff;">#define</span> BYTE_ORDER    LITTLE_ENDIAN
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#if</span> defined(sel) || defined(pyr) || defined(mc68000) || defined(sparc) || \<span style="color: #000000;">
    defined(is68k) </span>|| defined(tahoe) || defined(ibm032) || defined(ibm370) ||<span style="color: #000000;"> \
    defined(MIPSEB) </span>|| defined(_MIPSEB) || defined(_IBMR2) || defined(DGUX) ||<span style="color: #000000;">\
    defined(apollo) </span>|| defined(__convex__) || defined(_CRAY) ||<span style="color: #000000;"> \
    defined(__hppa) </span>|| defined(__hp9000) ||<span style="color: #000000;"> \
    defined(__hp9000s300) </span>|| defined(__hp9000s700) ||<span style="color: #000000;"> \
    defined (BIT_ZERO_ON_LEFT) </span>|| defined(m68k) ||<span style="color: #000000;"> defined(__sparc)
</span><span style="color: #0000ff;">#define</span> BYTE_ORDER    BIG_ENDIAN
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span> /* linux */
<span style="color: #0000ff;">#endif</span> /* BSD */
<span style="color: #0000ff;">#endif</span> /* BYTE_ORDER */

<span style="color: #008000;">/*</span><span style="color: #008000;"> Sometimes after including an OS-specific header that defines the
 * endianess we end with __BYTE_ORDER but not with BYTE_ORDER that is what
 * the Redis code uses. In this case let's define everything without the
 * underscores. </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifndef BYTE_ORDER
#ifdef __BYTE_ORDER
</span><span style="color: #0000ff;">#if</span> defined(__LITTLE_ENDIAN) &amp;&amp; defined(__BIG_ENDIAN)<span style="color: #000000;">
#ifndef LITTLE_ENDIAN
</span><span style="color: #0000ff;">#define</span> LITTLE_ENDIAN __LITTLE_ENDIAN
<span style="color: #0000ff;">#endif</span><span style="color: #000000;">
#ifndef BIG_ENDIAN
</span><span style="color: #0000ff;">#define</span> BIG_ENDIAN __BIG_ENDIAN
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#if</span> (__BYTE_ORDER == __LITTLE_ENDIAN)
<span style="color: #0000ff;">#define</span> BYTE_ORDER LITTLE_ENDIAN
<span style="color: #0000ff;">#else</span>
<span style="color: #0000ff;">#define</span> BYTE_ORDER BIG_ENDIAN
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#if</span> !defined(BYTE_ORDER) || \<span style="color: #000000;">
    (BYTE_ORDER </span>!= BIG_ENDIAN &amp;&amp; BYTE_ORDER !=<span style="color: #000000;"> LITTLE_ENDIAN)
    </span><span style="color: #008000;">/*</span><span style="color: #008000;"> you must determine what the correct bit order is for
     * your compiler - the next line is an intentional error
     * which will force your compiles to bomb until you fix
     * the above macros.
     </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#error</span> "Undefined or invalid BYTE_ORDER"
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#if</span> (__i386 || __amd64 || __powerpc__) &amp;&amp; __GNUC__
<span style="color: #0000ff;">#define</span> GNUC_VERSION (__GNUC__ * 10000 + __GNUC_MINOR__ * 100 + __GNUC_PATCHLEVEL__)
<span style="color: #0000ff;">#if</span> defined(__clang__)
<span style="color: #0000ff;">#define</span> HAVE_ATOMIC
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#if</span> (defined(__GLIBC__) &amp;&amp; defined(__GLIBC_PREREQ))
<span style="color: #0000ff;">#if</span> (GNUC_VERSION &gt;= 40100 &amp;&amp; __GLIBC_PREREQ(2, 6))
<span style="color: #0000ff;">#define</span> HAVE_ATOMIC
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Make sure we can test for ARM just checking for __arm__, since sometimes
 * __arm is defined but __arm__ is not. </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#if</span> defined(__arm) &amp;&amp; !defined(__arm__)
<span style="color: #0000ff;">#define</span> __arm__
<span style="color: #0000ff;">#endif</span>
<span style="color: #0000ff;">#if</span> defined (__aarch64__) &amp;&amp; !defined(__arm64__)
<span style="color: #0000ff;">#define</span> __arm64__
<span style="color: #0000ff;">#endif</span>

<span style="color: #008000;">/*</span><span style="color: #008000;"> Make sure we can test for SPARC just checking for __sparc__. </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">#if</span> defined(__sparc) &amp;&amp; !defined(__sparc__)
<span style="color: #0000ff;">#define</span> __sparc__
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#if</span> defined(__sparc__) || defined(__arm__)
<span style="color: #0000ff;">#define</span> USE_ALIGNED_ACCESS
<span style="color: #0000ff;">#endif</span>

<span style="color: #0000ff;">#endif</span></span></code></pre>

<p><span style="font-family: 'courier new', courier;">从宏定义中可以看出来, redis 依赖 linux unix 类型的操作系统. 如果当时 redis 一心只为 </span></p>
<p><span style="font-family: 'courier new', courier;">linux 服务,&nbsp;预计开发和维护的心智负担会小很多(纯属意淫). 那开始扯皮吧.</span></p>
<p><span style="font-family: 'courier new', courier;"><strong>2.1'</strong> <strong>宏排版</strong>差评, 写起来辣眼睛</span></p>
<p><span style="font-family: 'courier new', courier;">我们以 BYTE_ORDER 为例子, 不放给其排排版, 对对齐, 方便肉眼阅读.</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008000;">//</span><span style="color: #008000;"> Sometimes after including an OS-specific header that defines the
</span><span style="color: #008000;">//</span><span style="color: #008000;"> endianess we end with __BYTE_ORDER but not with BYTE_ORDER that is what
</span><span style="color: #008000;">//</span><span style="color: #008000;"> the Redis code uses. In this case let's define everything without the
</span><span style="color: #008000;">//</span><span style="color: #008000;"> underscores. </span>
<span style="color: #000000;">#ifndef BYTE_ORDER
#  ifdef __BYTE_ORDER

#    </span><span style="color: #0000ff;">if</span> defined __LITTLE_ENDIAN &amp;&amp;<span style="color: #000000;"> defined __BIG_ENDIAN

#      ifndef LITTLE_ENDIAN
#        define LITTLE_ENGIAN __LITTLE_ENDIAN
#      endif

#      ifndef BIG_ENDIAN
#        define BIG_ENGIAN __BIG_ENGIAN
#      endif

#     </span><span style="color: #0000ff;">if</span> __BYTE_ORDER ==<span style="color: #000000;"> __LITTLE_ENGIAN
#       define BYTE_ORDER LITTLE_ENGIAN
#     </span><span style="color: #0000ff;">else</span><span style="color: #000000;">
#       define BYTE_ORDER BIG_ENGIAN
#     endif

#   endif

#  endif
</span><span style="color: #0000ff;">#endif</span></span></code></pre>

<p><span style="font-family: 'courier new', courier;">大家看看这样, 是不是清爽了很多.&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;">而对于 config.h 我们不继续展开 config.c 了, 因为项目运行起点的就是 config. 这要再深入下去</span></p>
<p><span style="font-family: 'courier new', courier;">基本就 redis all in 了. 附赠聊聊边角料 setproctitle 设置进程标题的话题.</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #0000ff;">#if</span> (defined __linux &amp;&amp; defined __GLIBC__) || (defined __APPLE__)

<span style="color: #0000ff;">#define</span> USE_SETPROCTITLE

<span style="color: #0000ff;">#define</span> INIT_SETPROCTITLE_REPLACEMENT

<span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> spt_init(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> *<span style="color: #000000;"> argv[]);
</span><span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">void</span> setproctitle(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;"> fmt, ...);

</span><span style="color: #0000ff;">#endif</span></span></code></pre>

<p><span style="font-family: 'courier new', courier; font-size: 15px;"><strong>3. redis setproctitle.c 分析</strong></span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> ==========================================================================
</span><span style="color: #008080;">  2</span> <span style="color: #008000;"> * setproctitle.c - Linux/Darwin setproctitle.
</span><span style="color: #008080;">  3</span> <span style="color: #008000;"> * --------------------------------------------------------------------------
</span><span style="color: #008080;">  4</span> <span style="color: #008000;"> * Copyright (C) 2010  William Ahern
</span><span style="color: #008080;">  5</span> <span style="color: #008000;"> * Copyright (C) 2013  Salvatore Sanfilippo
</span><span style="color: #008080;">  6</span> <span style="color: #008000;"> * Copyright (C) 2013  Stam He
</span><span style="color: #008080;">  7</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  8</span> <span style="color: #008000;"> * Permission is hereby granted, free of charge, to any person obtaining a
</span><span style="color: #008080;">  9</span> <span style="color: #008000;"> * copy of this software and associated documentation files (the
</span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> * "Software"), to deal in the Software without restriction, including
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> * without limitation the rights to use, copy, modify, merge, publish,
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> * distribute, sublicense, and/or sell copies of the Software, and to permit
</span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> * persons to whom the Software is furnished to do so, subject to the
</span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> * following conditions:
</span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> * The above copyright notice and this permission notice shall be included
</span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> * in all copies or substantial portions of the Software.
</span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 19</span> <span style="color: #008000;"> * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
</span><span style="color: #008080;"> 23</span> <span style="color: #008000;"> * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
</span><span style="color: #008080;"> 24</span> <span style="color: #008000;"> * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
</span><span style="color: #008080;"> 25</span> <span style="color: #008000;"> * USE OR OTHER DEALINGS IN THE SOFTWARE.
</span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> * ==========================================================================
</span><span style="color: #008080;"> 27</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 28</span> <span style="color: #000000;">#ifndef _GNU_SOURCE
</span><span style="color: #008080;"> 29</span> <span style="color: #0000ff;">#define</span> _GNU_SOURCE
<span style="color: #008080;"> 30</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 31</span> 
<span style="color: #008080;"> 32</span> #include &lt;stddef.h&gt;    <span style="color: #008000;">/*</span><span style="color: #008000;"> NULL size_t </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 33</span> #include &lt;stdarg.h&gt;    <span style="color: #008000;">/*</span><span style="color: #008000;"> va_list va_start va_end </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 34</span> #include &lt;stdlib.h&gt;    <span style="color: #008000;">/*</span><span style="color: #008000;"> malloc(3) setenv(3) clearenv(3) setproctitle(3) getprogname(3) </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 35</span> #include &lt;stdio.h&gt;    <span style="color: #008000;">/*</span><span style="color: #008000;"> vsnprintf(3) snprintf(3) </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 36</span> 
<span style="color: #008080;"> 37</span> #include &lt;<span style="color: #0000ff;">string</span>.h&gt;    <span style="color: #008000;">/*</span><span style="color: #008000;"> strlen(3) strchr(3) strdup(3) memset(3) memcpy(3) </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span> #include &lt;errno.h&gt;    <span style="color: #008000;">/*</span><span style="color: #008000;"> errno program_invocation_name program_invocation_short_name </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 40</span> 
<span style="color: #008080;"> 41</span> <span style="color: #0000ff;">#if</span> !defined(HAVE_SETPROCTITLE)
<span style="color: #008080;"> 42</span> <span style="color: #0000ff;">#if</span> (defined __NetBSD__ || defined __FreeBSD__ || defined __OpenBSD__ || defined __DragonFly__)
<span style="color: #008080;"> 43</span> <span style="color: #0000ff;">#define</span> HAVE_SETPROCTITLE 1
<span style="color: #008080;"> 44</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;"> 45</span> <span style="color: #0000ff;">#define</span> HAVE_SETPROCTITLE 0
<span style="color: #008080;"> 46</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 47</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 48</span> 
<span style="color: #008080;"> 49</span> 
<span style="color: #008080;"> 50</span> <span style="color: #0000ff;">#if</span> !HAVE_SETPROCTITLE
<span style="color: #008080;"> 51</span> <span style="color: #0000ff;">#if</span> (defined __linux || defined __APPLE__)
<span style="color: #008080;"> 52</span> 
<span style="color: #008080;"> 53</span> <span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">char</span> **<span style="color: #000000;">environ;
</span><span style="color: #008080;"> 54</span> 
<span style="color: #008080;"> 55</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 56</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> original value </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">arg0;
</span><span style="color: #008080;"> 58</span> 
<span style="color: #008080;"> 59</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> title space available </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">char</span> *<span style="color: #0000ff;">base</span>, *<span style="color: #000000;">end;
</span><span style="color: #008080;"> 61</span> 
<span style="color: #008080;"> 62</span>      <span style="color: #008000;">/*</span><span style="color: #008000;"> pointer to original nul character within base </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">char</span> *<span style="color: #000000;">nul;
</span><span style="color: #008080;"> 64</span> 
<span style="color: #008080;"> 65</span> <span style="color: #000000;">    _Bool reset;
</span><span style="color: #008080;"> 66</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> error;
</span><span style="color: #008080;"> 67</span> <span style="color: #000000;">} SPT;
</span><span style="color: #008080;"> 68</span> 
<span style="color: #008080;"> 69</span> 
<span style="color: #008080;"> 70</span> <span style="color: #000000;">#ifndef SPT_MIN
</span><span style="color: #008080;"> 71</span> <span style="color: #0000ff;">#define</span> SPT_MIN(a, b) (((a) &lt; (b))? (a) : (b))
<span style="color: #008080;"> 72</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 73</span> 
<span style="color: #008080;"> 74</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> inline size_t spt_min(size_t a, size_t b) {
</span><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> SPT_MIN(a, b);
</span><span style="color: #008080;"> 76</span> } <span style="color: #008000;">/*</span><span style="color: #008000;"> spt_min() </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 77</span> 
<span style="color: #008080;"> 78</span> 
<span style="color: #008080;"> 79</span> <span style="color: #008000;">/*</span>
<span style="color: #008080;"> 80</span> <span style="color: #008000;"> * For discussion on the portability of the various methods, see
</span><span style="color: #008080;"> 81</span> <span style="color: #008000;"> * </span><span style="color: #008000; text-decoration: underline;">http://lists.freebsd.org/pipermail/freebsd-stable/2008-June/043136.html</span>
<span style="color: #008080;"> 82</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 83</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> spt_clearenv(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 84</span> <span style="color: #0000ff;">#if</span> __GLIBC__
<span style="color: #008080;"> 85</span> <span style="color: #000000;">    clearenv();
</span><span style="color: #008080;"> 86</span> 
<span style="color: #008080;"> 87</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 88</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;"> 89</span>     <span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">char</span> **<span style="color: #000000;">environ;
</span><span style="color: #008080;"> 90</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">char</span> **<span style="color: #000000;">tmp;
</span><span style="color: #008080;"> 91</span> 
<span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">if</span> (!(tmp = <span style="color: #0000ff;">malloc</span>(<span style="color: #0000ff;">sizeof</span> *<span style="color: #000000;">tmp)))
</span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> errno;
</span><span style="color: #008080;"> 94</span> 
<span style="color: #008080;"> 95</span>     tmp[<span style="color: #800080;">0</span>]  =<span style="color: #000000;"> NULL;
</span><span style="color: #008080;"> 96</span>     environ =<span style="color: #000000;"> tmp;
</span><span style="color: #008080;"> 97</span> 
<span style="color: #008080;"> 98</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 99</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">100</span> } <span style="color: #008000;">/*</span><span style="color: #008000;"> spt_clearenv() </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">101</span> 
<span style="color: #008080;">102</span> 
<span style="color: #008080;">103</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> spt_copyenv(<span style="color: #0000ff;">char</span> *<span style="color: #000000;">oldenv[]) {
</span><span style="color: #008080;">104</span>     <span style="color: #0000ff;">extern</span> <span style="color: #0000ff;">char</span> **<span style="color: #000000;">environ;
</span><span style="color: #008080;">105</span>     <span style="color: #0000ff;">char</span> *<span style="color: #000000;">eq;
</span><span style="color: #008080;">106</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> i, error;
</span><span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span>     <span style="color: #0000ff;">if</span> (environ !=<span style="color: #000000;"> oldenv)
</span><span style="color: #008080;">109</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">110</span> 
<span style="color: #008080;">111</span>     <span style="color: #0000ff;">if</span> ((error =<span style="color: #000000;"> spt_clearenv()))
</span><span style="color: #008080;">112</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> error;
</span><span style="color: #008080;">113</span> 
<span style="color: #008080;">114</span>     <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; oldenv[i]; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">if</span> (!(eq = strchr(oldenv[i], <span style="color: #800000;">'</span><span style="color: #800000;">=</span><span style="color: #800000;">'</span><span style="color: #000000;">)))
</span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">117</span> 
<span style="color: #008080;">118</span>         *eq = <span style="color: #800000;">'</span><span style="color: #800000;">\0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">119</span>         error = (<span style="color: #800080;">0</span> != setenv(oldenv[i], eq + <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>))? errno : <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">120</span>         *eq = <span style="color: #800000;">'</span><span style="color: #800000;">=</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">121</span> 
<span style="color: #008080;">122</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (error)
</span><span style="color: #008080;">123</span>             <span style="color: #0000ff;">goto</span><span style="color: #000000;"> error;
</span><span style="color: #008080;">124</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">125</span> 
<span style="color: #008080;">126</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">127</span> <span style="color: #000000;">error:
</span><span style="color: #008080;">128</span>     environ =<span style="color: #000000;"> oldenv;
</span><span style="color: #008080;">129</span> 
<span style="color: #008080;">130</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> error;
</span><span style="color: #008080;">131</span> } <span style="color: #008000;">/*</span><span style="color: #008000;"> spt_copyenv() </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">132</span> 
<span style="color: #008080;">133</span> 
<span style="color: #008080;">134</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> spt_copyargs(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> *<span style="color: #000000;">argv[]) {
</span><span style="color: #008080;">135</span>     <span style="color: #0000ff;">char</span> *<span style="color: #000000;">tmp;
</span><span style="color: #008080;">136</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> i;
</span><span style="color: #008080;">137</span> 
<span style="color: #008080;">138</span>     <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">1</span>; i &lt; argc || (i &gt;= argc &amp;&amp; argv[i]); i++<span style="color: #000000;">) {
</span><span style="color: #008080;">139</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">argv[i])
</span><span style="color: #008080;">140</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">141</span> 
<span style="color: #008080;">142</span>         <span style="color: #0000ff;">if</span> (!(tmp =<span style="color: #000000;"> strdup(argv[i])))
</span><span style="color: #008080;">143</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> errno;
</span><span style="color: #008080;">144</span> 
<span style="color: #008080;">145</span>         argv[i] =<span style="color: #000000;"> tmp;
</span><span style="color: #008080;">146</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">147</span> 
<span style="color: #008080;">148</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">149</span> } <span style="color: #008000;">/*</span><span style="color: #008000;"> spt_copyargs() </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">150</span> 
<span style="color: #008080;">151</span> 
<span style="color: #008080;">152</span> <span style="color: #0000ff;">void</span> spt_init(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> *<span style="color: #000000;">argv[]) {
</span><span style="color: #008080;">153</span>         <span style="color: #0000ff;">char</span> **envp =<span style="color: #000000;"> environ;
</span><span style="color: #008080;">154</span>     <span style="color: #0000ff;">char</span> *<span style="color: #0000ff;">base</span>, *end, *nul, *<span style="color: #000000;">tmp;
</span><span style="color: #008080;">155</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> i, error;
</span><span style="color: #008080;">156</span> 
<span style="color: #008080;">157</span>     <span style="color: #0000ff;">if</span> (!(<span style="color: #0000ff;">base</span> = argv[<span style="color: #800080;">0</span><span style="color: #000000;">]))
</span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">159</span> 
<span style="color: #008080;">160</span>     nul = &amp;<span style="color: #0000ff;">base</span>[strlen(<span style="color: #0000ff;">base</span><span style="color: #000000;">)];
</span><span style="color: #008080;">161</span>     end = nul + <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">162</span> 
<span style="color: #008080;">163</span>     <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; i &lt; argc || (i &gt;= argc &amp;&amp; argv[i]); i++<span style="color: #000000;">) {
</span><span style="color: #008080;">164</span>         <span style="color: #0000ff;">if</span> (!argv[i] || argv[i] &lt;<span style="color: #000000;"> end)
</span><span style="color: #008080;">165</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">166</span> 
<span style="color: #008080;">167</span>         end = argv[i] + strlen(argv[i]) + <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">168</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">169</span> 
<span style="color: #008080;">170</span>     <span style="color: #0000ff;">for</span> (i = <span style="color: #800080;">0</span>; envp[i]; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">171</span>         <span style="color: #0000ff;">if</span> (envp[i] &lt;<span style="color: #000000;"> end)
</span><span style="color: #008080;">172</span>             <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">173</span> 
<span style="color: #008080;">174</span>         end = envp[i] + strlen(envp[i]) + <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">175</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">176</span> 
<span style="color: #008080;">177</span>     <span style="color: #0000ff;">if</span> (!(SPT.arg0 = strdup(argv[<span style="color: #800080;">0</span><span style="color: #000000;">])))
</span><span style="color: #008080;">178</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> syerr;
</span><span style="color: #008080;">179</span> 
<span style="color: #008080;">180</span> <span style="color: #0000ff;">#if</span> __GLIBC__
<span style="color: #008080;">181</span>     <span style="color: #0000ff;">if</span> (!(tmp =<span style="color: #000000;"> strdup(program_invocation_name)))
</span><span style="color: #008080;">182</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> syerr;
</span><span style="color: #008080;">183</span> 
<span style="color: #008080;">184</span>     program_invocation_name =<span style="color: #000000;"> tmp;
</span><span style="color: #008080;">185</span> 
<span style="color: #008080;">186</span>     <span style="color: #0000ff;">if</span> (!(tmp =<span style="color: #000000;"> strdup(program_invocation_short_name)))
</span><span style="color: #008080;">187</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> syerr;
</span><span style="color: #008080;">188</span> 
<span style="color: #008080;">189</span>     program_invocation_short_name =<span style="color: #000000;"> tmp;
</span><span style="color: #008080;">190</span> <span style="color: #0000ff;">#elif</span> __APPLE__
<span style="color: #008080;">191</span>     <span style="color: #0000ff;">if</span> (!(tmp =<span style="color: #000000;"> strdup(getprogname())))
</span><span style="color: #008080;">192</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> syerr;
</span><span style="color: #008080;">193</span> 
<span style="color: #008080;">194</span> <span style="color: #000000;">    setprogname(tmp);
</span><span style="color: #008080;">195</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">196</span> 
<span style="color: #008080;">197</span> 
<span style="color: #008080;">198</span>     <span style="color: #0000ff;">if</span> ((error =<span style="color: #000000;"> spt_copyenv(envp)))
</span><span style="color: #008080;">199</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> error;
</span><span style="color: #008080;">200</span> 
<span style="color: #008080;">201</span>     <span style="color: #0000ff;">if</span> ((error =<span style="color: #000000;"> spt_copyargs(argc, argv)))
</span><span style="color: #008080;">202</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> error;
</span><span style="color: #008080;">203</span> 
<span style="color: #008080;">204</span>     SPT.nul  =<span style="color: #000000;"> nul;
</span><span style="color: #008080;">205</span>     SPT.<span style="color: #0000ff;">base</span> = <span style="color: #0000ff;">base</span><span style="color: #000000;">;
</span><span style="color: #008080;">206</span>     SPT.end  =<span style="color: #000000;"> end;
</span><span style="color: #008080;">207</span> 
<span style="color: #008080;">208</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">209</span> <span style="color: #000000;">syerr:
</span><span style="color: #008080;">210</span>     error =<span style="color: #000000;"> errno;
</span><span style="color: #008080;">211</span> <span style="color: #000000;">error:
</span><span style="color: #008080;">212</span>     SPT.error =<span style="color: #000000;"> error;
</span><span style="color: #008080;">213</span> } <span style="color: #008000;">/*</span><span style="color: #008000;"> spt_init() </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">214</span> 
<span style="color: #008080;">215</span> 
<span style="color: #008080;">216</span> <span style="color: #000000;">#ifndef SPT_MAXTITLE
</span><span style="color: #008080;">217</span> <span style="color: #0000ff;">#define</span> SPT_MAXTITLE 255
<span style="color: #008080;">218</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">219</span> 
<span style="color: #008080;">220</span> <span style="color: #0000ff;">void</span> setproctitle(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">fmt, ...) {
</span><span style="color: #008080;">221</span>     <span style="color: #0000ff;">char</span> buf[SPT_MAXTITLE + <span style="color: #800080;">1</span>]; <span style="color: #008000;">/*</span><span style="color: #008000;"> use buffer in case argv[0] is passed </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">222</span> <span style="color: #000000;">    va_list ap;
</span><span style="color: #008080;">223</span>     <span style="color: #0000ff;">char</span> *<span style="color: #000000;">nul;
</span><span style="color: #008080;">224</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> len, error;
</span><span style="color: #008080;">225</span> 
<span style="color: #008080;">226</span>     <span style="color: #0000ff;">if</span> (!SPT.<span style="color: #0000ff;">base</span><span style="color: #000000;">)
</span><span style="color: #008080;">227</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">228</span> 
<span style="color: #008080;">229</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (fmt) {
</span><span style="color: #008080;">230</span> <span style="color: #000000;">        va_start(ap, fmt);
</span><span style="color: #008080;">231</span>         len = vsnprintf(buf, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;"> buf, fmt, ap);
</span><span style="color: #008080;">232</span> <span style="color: #000000;">        va_end(ap);
</span><span style="color: #008080;">233</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">234</span>         len = snprintf(buf, <span style="color: #0000ff;">sizeof</span> buf, <span style="color: #800000;">"</span><span style="color: #800000;">%s</span><span style="color: #800000;">"</span><span style="color: #000000;">, SPT.arg0);
</span><span style="color: #008080;">235</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">236</span> 
<span style="color: #008080;">237</span>     <span style="color: #0000ff;">if</span> (len &lt;= <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">238</span>         { error = errno; <span style="color: #0000ff;">goto</span><span style="color: #000000;"> error; }
</span><span style="color: #008080;">239</span> 
<span style="color: #008080;">240</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">SPT.reset) {
</span><span style="color: #008080;">241</span>         memset(SPT.<span style="color: #0000ff;">base</span>, <span style="color: #800080;">0</span>, SPT.end - SPT.<span style="color: #0000ff;">base</span><span style="color: #000000;">);
</span><span style="color: #008080;">242</span>         SPT.reset = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">243</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">244</span>         memset(SPT.<span style="color: #0000ff;">base</span>, <span style="color: #800080;">0</span>, spt_min(<span style="color: #0000ff;">sizeof</span> buf, SPT.end - SPT.<span style="color: #0000ff;">base</span><span style="color: #000000;">));
</span><span style="color: #008080;">245</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">246</span> 
<span style="color: #008080;">247</span>     len = spt_min(len, spt_min(<span style="color: #0000ff;">sizeof</span> buf, SPT.end - SPT.<span style="color: #0000ff;">base</span>) - <span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">248</span>     memcpy(SPT.<span style="color: #0000ff;">base</span><span style="color: #000000;">, buf, len);
</span><span style="color: #008080;">249</span>     nul = &amp;SPT.<span style="color: #0000ff;">base</span><span style="color: #000000;">[len];
</span><span style="color: #008080;">250</span> 
<span style="color: #008080;">251</span>     <span style="color: #0000ff;">if</span> (nul &lt;<span style="color: #000000;"> SPT.nul) {
</span><span style="color: #008080;">252</span>         *SPT.nul = <span style="color: #800000;">'</span><span style="color: #800000;">.</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">253</span>     } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (nul == SPT.nul &amp;&amp; &amp;nul[<span style="color: #800080;">1</span>] &lt;<span style="color: #000000;"> SPT.end) {
</span><span style="color: #008080;">254</span>         *SPT.nul = <span style="color: #800000;">'</span> <span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">255</span>         *++nul = <span style="color: #800000;">'</span><span style="color: #800000;">\0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">256</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">257</span> 
<span style="color: #008080;">258</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">259</span> <span style="color: #000000;">error:
</span><span style="color: #008080;">260</span>     SPT.error =<span style="color: #000000;"> error;
</span><span style="color: #008080;">261</span> } <span style="color: #008000;">/*</span><span style="color: #008000;"> setproctitle() </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">262</span> 
<span style="color: #008080;">263</span> 
<span style="color: #008080;">264</span> <span style="color: #0000ff;">#endif</span> /* __linux || __APPLE__ */
<span style="color: #008080;">265</span> <span style="color: #0000ff;">#endif</span> /* !HAVE_SETPROCTITLE */</span></code></pre>

<p><span style="font-family: 'courier new', courier;">3.1'&nbsp;spt_clearenv -&gt; spt_copyenv -&gt; setenv -&gt; goto error -&gt; environ = oldenv&nbsp;&nbsp;memory leak</span></p>
<p><span style="font-family: 'courier new', courier;"><a href="https://github.com/antirez/redis/pull/6588/commits/ec5405b7ccf809929ff105aeb14d9854896f9d68">https://github.com/antirez/redis/pull/6588/commits/ec5405b7ccf809929ff105aeb14d9854896f9d68</a>　　</span></p>
<p><span style="font-family: 'courier new', courier;">感兴趣的朋友可以一块交流. 想了解更多也可以参阅我和这个博主之间的交互(设置进程名称)</span></p>
<p><span style="font-family: 'courier new', courier;"><a href="https://www.cnblogs.com/imlgc/p/3823990.html#4428962">https://www.cnblogs.com/imlgc/p/3823990.html#4428962</a></span></p>
<p><span style="font-family: 'courier new', courier; font-size: 15px;"><strong>4. redis atomicvar.h 分析</strong></span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> This file implements atomic counters using __atomic or __sync macros if
</span><span style="color: #008080;">  2</span> <span style="color: #008000;"> * available, otherwise synchronizing different threads using a mutex.
</span><span style="color: #008080;">  3</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  4</span> <span style="color: #008000;"> * The exported interface is composed of three macros:
</span><span style="color: #008080;">  5</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  6</span> <span style="color: #008000;"> * atomicIncr(var,count) -- Increment the atomic counter
</span><span style="color: #008080;">  7</span> <span style="color: #008000;"> * atomicGetIncr(var,oldvalue_var,count) -- Get and increment the atomic counter
</span><span style="color: #008080;">  8</span> <span style="color: #008000;"> * atomicDecr(var,count) -- Decrement the atomic counter
</span><span style="color: #008080;">  9</span> <span style="color: #008000;"> * atomicGet(var,dstvar) -- Fetch the atomic counter value
</span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> * atomicSet(var,value)  -- Set the atomic counter value
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> * The variable 'var' should also have a declared mutex with the same
</span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> * name and the "_mutex" postfix, for instance:
</span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> *  long myvar;
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> *  pthread_mutex_t myvar_mutex;
</span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> *  atomicSet(myvar,12345);
</span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 19</span> <span style="color: #008000;"> * If atomic primitives are available (tested in config.h) the mutex
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * is not used.
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * Never use return value from the macros, instead use the AtomicGetIncr()
</span><span style="color: #008080;"> 23</span> <span style="color: #008000;"> * if you need to get the current value and increment it atomically, like
</span><span style="color: #008080;"> 24</span> <span style="color: #008000;"> * in the followign example:
</span><span style="color: #008080;"> 25</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> *  long oldvalue;
</span><span style="color: #008080;"> 27</span> <span style="color: #008000;"> *  atomicGetIncr(myvar,oldvalue,1);
</span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> *  doSomethingWith(oldvalue);
</span><span style="color: #008080;"> 29</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 30</span> <span style="color: #008000;"> * ----------------------------------------------------------------------------
</span><span style="color: #008080;"> 31</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 32</span> <span style="color: #008000;"> * Copyright (c) 2015, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
</span><span style="color: #008080;"> 33</span> <span style="color: #008000;"> * All rights reserved.
</span><span style="color: #008080;"> 34</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 35</span> <span style="color: #008000;"> * Redistribution and use in source and binary forms, with or without
</span><span style="color: #008080;"> 36</span> <span style="color: #008000;"> * modification, are permitted provided that the following conditions are met:
</span><span style="color: #008080;"> 37</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 38</span> <span style="color: #008000;"> *   * Redistributions of source code must retain the above copyright notice,
</span><span style="color: #008080;"> 39</span> <span style="color: #008000;"> *     this list of conditions and the following disclaimer.
</span><span style="color: #008080;"> 40</span> <span style="color: #008000;"> *   * Redistributions in binary form must reproduce the above copyright
</span><span style="color: #008080;"> 41</span> <span style="color: #008000;"> *     notice, this list of conditions and the following disclaimer in the
</span><span style="color: #008080;"> 42</span> <span style="color: #008000;"> *     documentation and/or other materials provided with the distribution.
</span><span style="color: #008080;"> 43</span> <span style="color: #008000;"> *   * Neither the name of Redis nor the names of its contributors may be used
</span><span style="color: #008080;"> 44</span> <span style="color: #008000;"> *     to endorse or promote products derived from this software without
</span><span style="color: #008080;"> 45</span> <span style="color: #008000;"> *     specific prior written permission.
</span><span style="color: #008080;"> 46</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 47</span> <span style="color: #008000;"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
</span><span style="color: #008080;"> 48</span> <span style="color: #008000;"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
</span><span style="color: #008080;"> 49</span> <span style="color: #008000;"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
</span><span style="color: #008080;"> 50</span> <span style="color: #008000;"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
</span><span style="color: #008080;"> 51</span> <span style="color: #008000;"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
</span><span style="color: #008080;"> 52</span> <span style="color: #008000;"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
</span><span style="color: #008080;"> 53</span> <span style="color: #008000;"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
</span><span style="color: #008080;"> 54</span> <span style="color: #008000;"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
</span><span style="color: #008080;"> 55</span> <span style="color: #008000;"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
</span><span style="color: #008080;"> 56</span> <span style="color: #008000;"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
</span><span style="color: #008080;"> 57</span> <span style="color: #008000;"> * POSSIBILITY OF SUCH DAMAGE.
</span><span style="color: #008080;"> 58</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 59</span> 
<span style="color: #008080;"> 60</span> #include &lt;pthread.h&gt;
<span style="color: #008080;"> 61</span> 
<span style="color: #008080;"> 62</span> <span style="color: #000000;">#ifndef __ATOMIC_VAR_H
</span><span style="color: #008080;"> 63</span> <span style="color: #0000ff;">#define</span> __ATOMIC_VAR_H
<span style="color: #008080;"> 64</span> 
<span style="color: #008080;"> 65</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> To test Redis with Helgrind (a Valgrind tool) it is useful to define
</span><span style="color: #008080;"> 66</span> <span style="color: #008000;"> * the following macro, so that __sync macros are used: those can be detected
</span><span style="color: #008080;"> 67</span> <span style="color: #008000;"> * by Helgrind (even if they are less efficient) so that no false positive
</span><span style="color: #008080;"> 68</span> <span style="color: #008000;"> * is reported. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 69</span> <span style="color: #008000;">//</span><span style="color: #008000;"> #define __ATOMIC_VAR_FORCE_SYNC_MACROS</span>
<span style="color: #008080;"> 70</span> 
<span style="color: #008080;"> 71</span> <span style="color: #0000ff;">#if</span> !defined(__ATOMIC_VAR_FORCE_SYNC_MACROS) &amp;&amp; defined(__ATOMIC_RELAXED) &amp;&amp; !defined(__sun) &amp;&amp; (!defined(__clang__) || !defined(__APPLE__) || __apple_build_version__ &gt; 4210057)
<span style="color: #008080;"> 72</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Implementation using __atomic macros. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 73</span> 
<span style="color: #008080;"> 74</span> <span style="color: #0000ff;">#define</span> atomicIncr(var,count) __atomic_add_fetch(&amp;var,(count),__ATOMIC_RELAXED)
<span style="color: #008080;"> 75</span> <span style="color: #0000ff;">#define</span> atomicGetIncr(var,oldvalue_var,count) do { \
<span style="color: #008080;"> 76</span>     oldvalue_var = __atomic_fetch_add(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;">,(count),__ATOMIC_RELAXED); \
</span><span style="color: #008080;"> 77</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 78</span> <span style="color: #0000ff;">#define</span> atomicDecr(var,count) __atomic_sub_fetch(&amp;var,(count),__ATOMIC_RELAXED)
<span style="color: #008080;"> 79</span> <span style="color: #0000ff;">#define</span> atomicGet(var,dstvar) do { \
<span style="color: #008080;"> 80</span>     dstvar = __atomic_load_n(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;">,__ATOMIC_RELAXED); \
</span><span style="color: #008080;"> 81</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 82</span> <span style="color: #0000ff;">#define</span> atomicSet(var,value) __atomic_store_n(&amp;var,value,__ATOMIC_RELAXED)
<span style="color: #008080;"> 83</span> <span style="color: #0000ff;">#define</span> REDIS_ATOMIC_API "atomic-builtin"
<span style="color: #008080;"> 84</span> 
<span style="color: #008080;"> 85</span> <span style="color: #0000ff;">#elif</span> defined(HAVE_ATOMIC)
<span style="color: #008080;"> 86</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Implementation using __sync macros. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 87</span> 
<span style="color: #008080;"> 88</span> <span style="color: #0000ff;">#define</span> atomicIncr(var,count) __sync_add_and_fetch(&amp;var,(count))
<span style="color: #008080;"> 89</span> <span style="color: #0000ff;">#define</span> atomicGetIncr(var,oldvalue_var,count) do { \
<span style="color: #008080;"> 90</span>     oldvalue_var = __sync_fetch_and_add(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;">,(count)); \
</span><span style="color: #008080;"> 91</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 92</span> <span style="color: #0000ff;">#define</span> atomicDecr(var,count) __sync_sub_and_fetch(&amp;var,(count))
<span style="color: #008080;"> 93</span> <span style="color: #0000ff;">#define</span> atomicGet(var,dstvar) do { \
<span style="color: #008080;"> 94</span>     dstvar = __sync_sub_and_fetch(&amp;<span style="color: #0000ff;">var</span>,<span style="color: #800080;">0</span><span style="color: #000000;">); \
</span><span style="color: #008080;"> 95</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 96</span> <span style="color: #0000ff;">#define</span> atomicSet(var,value) do { \
<span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">while</span>(!__sync_bool_compare_and_swap(&amp;<span style="color: #0000ff;">var</span>,<span style="color: #0000ff;">var</span><span style="color: #000000;">,value)); \
</span><span style="color: #008080;"> 98</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 99</span> <span style="color: #0000ff;">#define</span> REDIS_ATOMIC_API "sync-builtin"
<span style="color: #008080;">100</span> 
<span style="color: #008080;">101</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">102</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Implementation using pthread mutex. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">103</span> 
<span style="color: #008080;">104</span> <span style="color: #0000ff;">#define</span> atomicIncr(var,count) do { \
<span style="color: #008080;">105</span>     pthread_mutex_lock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">106</span>     <span style="color: #0000ff;">var</span> +=<span style="color: #000000;"> (count); \
</span><span style="color: #008080;">107</span>     pthread_mutex_unlock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">108</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">109</span> <span style="color: #0000ff;">#define</span> atomicGetIncr(var,oldvalue_var,count) do { \
<span style="color: #008080;">110</span>     pthread_mutex_lock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">111</span>     oldvalue_var = <span style="color: #0000ff;">var</span><span style="color: #000000;">; \
</span><span style="color: #008080;">112</span>     <span style="color: #0000ff;">var</span> +=<span style="color: #000000;"> (count); \
</span><span style="color: #008080;">113</span>     pthread_mutex_unlock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">114</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">115</span> <span style="color: #0000ff;">#define</span> atomicDecr(var,count) do { \
<span style="color: #008080;">116</span>     pthread_mutex_lock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">117</span>     <span style="color: #0000ff;">var</span> -=<span style="color: #000000;"> (count); \
</span><span style="color: #008080;">118</span>     pthread_mutex_unlock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">119</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">120</span> <span style="color: #0000ff;">#define</span> atomicGet(var,dstvar) do { \
<span style="color: #008080;">121</span>     pthread_mutex_lock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">122</span>     dstvar = <span style="color: #0000ff;">var</span><span style="color: #000000;">; \
</span><span style="color: #008080;">123</span>     pthread_mutex_unlock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">124</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">125</span> <span style="color: #0000ff;">#define</span> atomicSet(var,value) do { \
<span style="color: #008080;">126</span>     pthread_mutex_lock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">127</span>     <span style="color: #0000ff;">var</span> =<span style="color: #000000;"> value; \
</span><span style="color: #008080;">128</span>     pthread_mutex_unlock(&amp;<span style="color: #0000ff;">var</span><span style="color: #000000;"> ## _mutex); \
</span><span style="color: #008080;">129</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">130</span> <span style="color: #0000ff;">#define</span> REDIS_ATOMIC_API "pthread-mutex"
<span style="color: #008080;">131</span> 
<span style="color: #008080;">132</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">133</span> <span style="color: #0000ff;">#endif</span> /* __ATOMIC_VAR_H */</span></code></pre>

<p><span style="font-family: 'courier new', courier;">atomicvar.h 原子库操作封装思路有三种, C11 stdatomic.h 和 GCC sync 操作, 还有 POSIX pthread.h . 不过使用</span></p>
<p><span style="font-family: 'courier new', courier;"> pthread.h&nbsp;封装的"原子操作", 不是那么通用, 因为和业务强绑定. 只能在 redis 项目下用. 原因是它依赖事先定义</span></p>
<p><span style="font-family: 'courier new', courier;">好变量&nbsp;&nbsp;var##_mutex</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;">pthread_mutex_lock(&amp;<span style="color: #0000ff;">var</span> ## _mutex); \</span></code></pre>

<p><span style="font-family: 'courier new', courier;">可以找到例子, 例如 src/lazyfree.c 中有段代码如下</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;">#include <span style="color: #800000;">"</span><span style="color: #800000;">server.h</span><span style="color: #800000;">"</span><span style="color: #000000;">
#include </span><span style="color: #800000;">"</span><span style="color: #800000;">bio.h</span><span style="color: #800000;">"</span><span style="color: #000000;">
#include </span><span style="color: #800000;">"</span><span style="color: #800000;">atomicvar.h</span><span style="color: #800000;">"</span><span style="color: #000000;">
#include </span><span style="color: #800000;">"</span><span style="color: #800000;">cluster.h</span><span style="color: #800000;">"</span>

<span style="color: #0000ff;">static</span> size_t lazyfree_objects = <span style="color: #800080;">0</span><span style="color: #000000;">;
pthread_mutex_t lazyfree_objects_mutex </span>= PTHREAD_MUTEX_INITIALIZER;</span></code></pre>

<p><span style="font-family: 'courier new', courier;">事先定义&nbsp;&nbsp;lazyfree_objects 和&nbsp;&nbsp;lazyfree_objects_mutex 才能使用 pthread 封装的原子操作宏.&nbsp;&nbsp;额外的优化</span></p>
<p><span style="font-family: 'courier new', courier;">可以通过&nbsp;__sync_lock_test_and_set 替代 while&nbsp;__sync_bool_compare_and_swap 费力操作</span></p>
<p><span style="font-family: 'courier new', courier;"><a href="https://github.com/antirez/redis/pull/6567/commits/dc1e369d6c12df73f128822b7ba30cdc4dd4357a">https://github.com/antirez/redis/pull/6567/commits/dc1e369d6c12df73f128822b7ba30cdc4dd4357a</a></span></p>
<p><span style="font-family: 'courier new', courier; font-size: 15px;"><strong>5. redis zmalloc 分析</strong></span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> zmalloc - total amount of allocated memory aware version of malloc()
</span><span style="color: #008080;">  2</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  3</span> <span style="color: #008000;"> * Copyright (c) 2009-2010, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
</span><span style="color: #008080;">  4</span> <span style="color: #008000;"> * All rights reserved.
</span><span style="color: #008080;">  5</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  6</span> <span style="color: #008000;"> * Redistribution and use in source and binary forms, with or without
</span><span style="color: #008080;">  7</span> <span style="color: #008000;"> * modification, are permitted provided that the following conditions are met:
</span><span style="color: #008080;">  8</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  9</span> <span style="color: #008000;"> *   * Redistributions of source code must retain the above copyright notice,
</span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> *     this list of conditions and the following disclaimer.
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> *   * Redistributions in binary form must reproduce the above copyright
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> *     notice, this list of conditions and the following disclaimer in the
</span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> *     documentation and/or other materials provided with the distribution.
</span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> *   * Neither the name of Redis nor the names of its contributors may be used
</span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> *     to endorse or promote products derived from this software without
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> *     specific prior written permission.
</span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
</span><span style="color: #008080;"> 19</span> <span style="color: #008000;"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
</span><span style="color: #008080;"> 23</span> <span style="color: #008000;"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
</span><span style="color: #008080;"> 24</span> <span style="color: #008000;"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
</span><span style="color: #008080;"> 25</span> <span style="color: #008000;"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
</span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
</span><span style="color: #008080;"> 27</span> <span style="color: #008000;"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
</span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> * POSSIBILITY OF SUCH DAMAGE.
</span><span style="color: #008080;"> 29</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 30</span> 
<span style="color: #008080;"> 31</span> <span style="color: #000000;">#ifndef __ZMALLOC_H
</span><span style="color: #008080;"> 32</span> <span style="color: #0000ff;">#define</span> __ZMALLOC_H
<span style="color: #008080;"> 33</span> 
<span style="color: #008080;"> 34</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Double expansion needed for stringification of macro values. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 35</span> <span style="color: #0000ff;">#define</span> __xstr(s) __str(s)
<span style="color: #008080;"> 36</span> <span style="color: #0000ff;">#define</span> __str(s) #s
<span style="color: #008080;"> 37</span> 
<span style="color: #008080;"> 38</span> <span style="color: #0000ff;">#if</span> defined(USE_TCMALLOC)
<span style="color: #008080;"> 39</span> <span style="color: #0000ff;">#define</span> ZMALLOC_LIB ("tcmalloc-" __xstr(TC_VERSION_MAJOR) "." __xstr(TC_VERSION_MINOR))
<span style="color: #008080;"> 40</span> #include &lt;google/tcmalloc.h&gt;
<span style="color: #008080;"> 41</span> <span style="color: #0000ff;">#if</span> (TC_VERSION_MAJOR == 1 &amp;&amp; TC_VERSION_MINOR &gt;= 6) || (TC_VERSION_MAJOR &gt; 1)
<span style="color: #008080;"> 42</span> <span style="color: #0000ff;">#define</span> HAVE_MALLOC_SIZE 1
<span style="color: #008080;"> 43</span> <span style="color: #0000ff;">#define</span> zmalloc_size(p) tc_malloc_size(p)
<span style="color: #008080;"> 44</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;"> 45</span> <span style="color: #0000ff;">#error</span> "Newer version of tcmalloc required"
<span style="color: #008080;"> 46</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 47</span> 
<span style="color: #008080;"> 48</span> <span style="color: #0000ff;">#elif</span> defined(USE_JEMALLOC)
<span style="color: #008080;"> 49</span> <span style="color: #0000ff;">#define</span> ZMALLOC_LIB ("jemalloc-" __xstr(JEMALLOC_VERSION_MAJOR) "." __xstr(JEMALLOC_VERSION_MINOR) "." __xstr(JEMALLOC_VERSION_BUGFIX))
<span style="color: #008080;"> 50</span> #include &lt;jemalloc/jemalloc.h&gt;
<span style="color: #008080;"> 51</span> <span style="color: #0000ff;">#if</span> (JEMALLOC_VERSION_MAJOR == 2 &amp;&amp; JEMALLOC_VERSION_MINOR &gt;= 1) || (JEMALLOC_VERSION_MAJOR &gt; 2)
<span style="color: #008080;"> 52</span> <span style="color: #0000ff;">#define</span> HAVE_MALLOC_SIZE 1
<span style="color: #008080;"> 53</span> <span style="color: #0000ff;">#define</span> zmalloc_size(p) je_malloc_usable_size(p)
<span style="color: #008080;"> 54</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;"> 55</span> <span style="color: #0000ff;">#error</span> "Newer version of jemalloc required"
<span style="color: #008080;"> 56</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span> <span style="color: #0000ff;">#elif</span> defined(__APPLE__)
<span style="color: #008080;"> 59</span> #include &lt;<span style="color: #0000ff;">malloc</span>/<span style="color: #0000ff;">malloc</span>.h&gt;
<span style="color: #008080;"> 60</span> <span style="color: #0000ff;">#define</span> HAVE_MALLOC_SIZE 1
<span style="color: #008080;"> 61</span> <span style="color: #0000ff;">#define</span> zmalloc_size(p) malloc_size(p)
<span style="color: #008080;"> 62</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 63</span> 
<span style="color: #008080;"> 64</span> <span style="color: #000000;">#ifndef ZMALLOC_LIB
</span><span style="color: #008080;"> 65</span> <span style="color: #0000ff;">#define</span> ZMALLOC_LIB "libc"
<span style="color: #008080;"> 66</span> <span style="color: #000000;">#ifdef __GLIBC__
</span><span style="color: #008080;"> 67</span> #include &lt;<span style="color: #0000ff;">malloc</span>.h&gt;
<span style="color: #008080;"> 68</span> <span style="color: #0000ff;">#define</span> HAVE_MALLOC_SIZE 1
<span style="color: #008080;"> 69</span> <span style="color: #0000ff;">#define</span> zmalloc_size(p) malloc_usable_size(p)
<span style="color: #008080;"> 70</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 71</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 72</span> 
<span style="color: #008080;"> 73</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> We can enable the Redis defrag capabilities only if we are using Jemalloc
</span><span style="color: #008080;"> 74</span> <span style="color: #008000;"> * and the version used is our special version modified for Redis having
</span><span style="color: #008080;"> 75</span> <span style="color: #008000;"> * the ability to return per-allocation fragmentation hints. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 76</span> <span style="color: #0000ff;">#if</span> defined(USE_JEMALLOC) &amp;&amp; defined(JEMALLOC_FRAG_HINT)
<span style="color: #008080;"> 77</span> <span style="color: #0000ff;">#define</span> HAVE_DEFRAG
<span style="color: #008080;"> 78</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 79</span> 
<span style="color: #008080;"> 80</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">zmalloc(size_t size);
</span><span style="color: #008080;"> 81</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">zcalloc(size_t size);
</span><span style="color: #008080;"> 82</span> <span style="color: #0000ff;">void</span> *zrealloc(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr, size_t size);
</span><span style="color: #008080;"> 83</span> <span style="color: #0000ff;">void</span> zfree(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;"> 84</span> <span style="color: #0000ff;">char</span> *zstrdup(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">s);
</span><span style="color: #008080;"> 85</span> size_t zmalloc_used_memory(<span style="color: #0000ff;">void</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 86</span> <span style="color: #0000ff;">void</span> zmalloc_set_oom_handler(<span style="color: #0000ff;">void</span> (*<span style="color: #000000;">oom_handler)(size_t));
</span><span style="color: #008080;"> 87</span> size_t zmalloc_get_rss(<span style="color: #0000ff;">void</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 88</span> <span style="color: #0000ff;">int</span> zmalloc_get_allocator_info(size_t *allocated, size_t *active, size_t *<span style="color: #000000;">resident);
</span><span style="color: #008080;"> 89</span> <span style="color: #0000ff;">void</span> set_jemalloc_bg_thread(<span style="color: #0000ff;">int</span><span style="color: #000000;"> enable);
</span><span style="color: #008080;"> 90</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> jemalloc_purge();
</span><span style="color: #008080;"> 91</span> size_t zmalloc_get_private_dirty(<span style="color: #0000ff;">long</span><span style="color: #000000;"> pid);
</span><span style="color: #008080;"> 92</span> size_t zmalloc_get_smap_bytes_by_field(<span style="color: #0000ff;">char</span> *field, <span style="color: #0000ff;">long</span><span style="color: #000000;"> pid);
</span><span style="color: #008080;"> 93</span> size_t zmalloc_get_memory_size(<span style="color: #0000ff;">void</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 94</span> <span style="color: #0000ff;">void</span> zlibc_free(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;"> 95</span> 
<span style="color: #008080;"> 96</span> <span style="color: #000000;">#ifdef HAVE_DEFRAG
</span><span style="color: #008080;"> 97</span> <span style="color: #0000ff;">void</span> zfree_no_tcache(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;"> 98</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">zmalloc_no_tcache(size_t size);
</span><span style="color: #008080;"> 99</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">100</span> 
<span style="color: #008080;">101</span> <span style="color: #000000;">#ifndef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">102</span> size_t zmalloc_size(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;">103</span> size_t zmalloc_usable(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr);
</span><span style="color: #008080;">104</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">105</span> <span style="color: #0000ff;">#define</span> zmalloc_usable(p) zmalloc_size(p)
<span style="color: #008080;">106</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span> <span style="color: #000000;">#ifdef REDIS_TEST
</span><span style="color: #008080;">109</span> <span style="color: #0000ff;">int</span> zmalloc_test(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> **<span style="color: #000000;">argv);
</span><span style="color: #008080;">110</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">111</span> 
<span style="color: #008080;">112</span> <span style="color: #0000ff;">#endif</span> /* __ZMALLOC_H */</span></code></pre>

<p><span style="font-family: 'courier new', courier;">内存模块支持外部库丰富, 自然写的就有点啰嗦. 我们这里有个诀窍, 我们假定只使用&nbsp;&nbsp;USE_JEMALLOC ,&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;"> 然后代码一路走下去, 是不是吼方便呢.&nbsp;&nbsp;</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;">  1</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> zmalloc - total amount of allocated memory aware version of malloc()
</span><span style="color: #008080;">  2</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  3</span> <span style="color: #008000;"> * Copyright (c) 2009-2010, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
</span><span style="color: #008080;">  4</span> <span style="color: #008000;"> * All rights reserved.
</span><span style="color: #008080;">  5</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  6</span> <span style="color: #008000;"> * Redistribution and use in source and binary forms, with or without
</span><span style="color: #008080;">  7</span> <span style="color: #008000;"> * modification, are permitted provided that the following conditions are met:
</span><span style="color: #008080;">  8</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">  9</span> <span style="color: #008000;"> *   * Redistributions of source code must retain the above copyright notice,
</span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> *     this list of conditions and the following disclaimer.
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> *   * Redistributions in binary form must reproduce the above copyright
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> *     notice, this list of conditions and the following disclaimer in the
</span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> *     documentation and/or other materials provided with the distribution.
</span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> *   * Neither the name of Redis nor the names of its contributors may be used
</span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> *     to endorse or promote products derived from this software without
</span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> *     specific prior written permission.
</span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> *
</span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
</span><span style="color: #008080;"> 19</span> <span style="color: #008000;"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
</span><span style="color: #008080;"> 23</span> <span style="color: #008000;"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
</span><span style="color: #008080;"> 24</span> <span style="color: #008000;"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
</span><span style="color: #008080;"> 25</span> <span style="color: #008000;"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
</span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
</span><span style="color: #008080;"> 27</span> <span style="color: #008000;"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
</span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> * POSSIBILITY OF SUCH DAMAGE.
</span><span style="color: #008080;"> 29</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 30</span> 
<span style="color: #008080;"> 31</span> #include &lt;stdio.h&gt;
<span style="color: #008080;"> 32</span> #include &lt;stdlib.h&gt;
<span style="color: #008080;"> 33</span> #include &lt;stdint.h&gt;
<span style="color: #008080;"> 34</span> 
<span style="color: #008080;"> 35</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> This function provide us access to the original libc free(). This is useful
</span><span style="color: #008080;"> 36</span> <span style="color: #008000;"> * for instance to free results obtained by backtrace_symbols(). We need
</span><span style="color: #008080;"> 37</span> <span style="color: #008000;"> * to define this function before including zmalloc.h that may shadow the
</span><span style="color: #008080;"> 38</span> <span style="color: #008000;"> * free implementation if we use jemalloc or another non standard allocator. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 39</span> <span style="color: #0000ff;">void</span> zlibc_free(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr) {
</span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">free</span><span style="color: #000000;">(ptr);
</span><span style="color: #008080;"> 41</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 42</span> 
<span style="color: #008080;"> 43</span> #include &lt;<span style="color: #0000ff;">string</span>.h&gt;
<span style="color: #008080;"> 44</span> #include &lt;pthread.h&gt;
<span style="color: #008080;"> 45</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">config.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 46</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">zmalloc.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 47</span> #include <span style="color: #800000;">"</span><span style="color: #800000;">atomicvar.h</span><span style="color: #800000;">"</span>
<span style="color: #008080;"> 48</span> 
<span style="color: #008080;"> 49</span> <span style="color: #000000;">#ifdef HAVE_MALLOC_SIZE
</span><span style="color: #008080;"> 50</span> <span style="color: #0000ff;">#define</span> PREFIX_SIZE (0)
<span style="color: #008080;"> 51</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;"> 52</span> <span style="color: #0000ff;">#if</span> defined(__sun) || defined(__sparc) || defined(__sparc__)
<span style="color: #008080;"> 53</span> <span style="color: #0000ff;">#define</span> PREFIX_SIZE (sizeof(long long))
<span style="color: #008080;"> 54</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;"> 55</span> <span style="color: #0000ff;">#define</span> PREFIX_SIZE (sizeof(size_t))
<span style="color: #008080;"> 56</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 57</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 58</span> 
<span style="color: #008080;"> 59</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Explicitly override malloc/free etc when using tcmalloc. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 60</span> <span style="color: #0000ff;">#if</span> defined(USE_TCMALLOC)
<span style="color: #008080;"> 61</span> <span style="color: #0000ff;">#define</span> malloc(size) tc_malloc(size)
<span style="color: #008080;"> 62</span> <span style="color: #0000ff;">#define</span> calloc(count,size) tc_calloc(count,size)
<span style="color: #008080;"> 63</span> <span style="color: #0000ff;">#define</span> realloc(ptr,size) tc_realloc(ptr,size)
<span style="color: #008080;"> 64</span> <span style="color: #0000ff;">#define</span> free(ptr) tc_free(ptr)
<span style="color: #008080;"> 65</span> <span style="color: #0000ff;">#elif</span> defined(USE_JEMALLOC)
<span style="color: #008080;"> 66</span> <span style="color: #0000ff;">#define</span> malloc(size) je_malloc(size)
<span style="color: #008080;"> 67</span> <span style="color: #0000ff;">#define</span> calloc(count,size) je_calloc(count,size)
<span style="color: #008080;"> 68</span> <span style="color: #0000ff;">#define</span> realloc(ptr,size) je_realloc(ptr,size)
<span style="color: #008080;"> 69</span> <span style="color: #0000ff;">#define</span> free(ptr) je_free(ptr)
<span style="color: #008080;"> 70</span> <span style="color: #0000ff;">#define</span> mallocx(size,flags) je_mallocx(size,flags)
<span style="color: #008080;"> 71</span> <span style="color: #0000ff;">#define</span> dallocx(ptr,flags) je_dallocx(ptr,flags)
<span style="color: #008080;"> 72</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;"> 73</span> 
<span style="color: #008080;"> 74</span> <span style="color: #0000ff;">#define</span> update_zmalloc_stat_alloc(__n) do { \
<span style="color: #008080;"> 75</span>     size_t _n =<span style="color: #000000;"> (__n); \
</span><span style="color: #008080;"> 76</span>     <span style="color: #0000ff;">if</span> (_n&amp;(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-<span style="color: #800080;">1</span>)) _n += <span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-(_n&amp;(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-<span style="color: #800080;">1</span><span style="color: #000000;">)); \
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">    atomicIncr(used_memory,__n); \
</span><span style="color: #008080;"> 78</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 79</span> 
<span style="color: #008080;"> 80</span> <span style="color: #0000ff;">#define</span> update_zmalloc_stat_free(__n) do { \
<span style="color: #008080;"> 81</span>     size_t _n =<span style="color: #000000;"> (__n); \
</span><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">if</span> (_n&amp;(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-<span style="color: #800080;">1</span>)) _n += <span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-(_n&amp;(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-<span style="color: #800080;">1</span><span style="color: #000000;">)); \
</span><span style="color: #008080;"> 83</span> <span style="color: #000000;">    atomicDecr(used_memory,__n); \
</span><span style="color: #008080;"> 84</span> } <span style="color: #0000ff;">while</span>(<span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 85</span> 
<span style="color: #008080;"> 86</span> <span style="color: #0000ff;">static</span> size_t used_memory = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 87</span> pthread_mutex_t used_memory_mutex =<span style="color: #000000;"> PTHREAD_MUTEX_INITIALIZER;
</span><span style="color: #008080;"> 88</span> 
<span style="color: #008080;"> 89</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> zmalloc_default_oom(size_t size) {
</span><span style="color: #008080;"> 90</span>     fprintf(stderr, <span style="color: #800000;">"</span><span style="color: #800000;">zmalloc: Out of memory trying to allocate %zu bytes\n</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 91</span> <span style="color: #000000;">        size);
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    fflush(stderr);
</span><span style="color: #008080;"> 93</span> <span style="color: #000000;">    abort();
</span><span style="color: #008080;"> 94</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 95</span> 
<span style="color: #008080;"> 96</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> (*zmalloc_oom_handler)(size_t) =<span style="color: #000000;"> zmalloc_default_oom;
</span><span style="color: #008080;"> 97</span> 
<span style="color: #008080;"> 98</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">zmalloc(size_t size) {
</span><span style="color: #008080;"> 99</span>     <span style="color: #0000ff;">void</span> *ptr = <span style="color: #0000ff;">malloc</span>(size+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">100</span> 
<span style="color: #008080;">101</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">ptr) zmalloc_oom_handler(size);
</span><span style="color: #008080;">102</span> <span style="color: #000000;">#ifdef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">103</span> <span style="color: #000000;">    update_zmalloc_stat_alloc(zmalloc_size(ptr));
</span><span style="color: #008080;">104</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ptr;
</span><span style="color: #008080;">105</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">106</span>     *((size_t*)ptr) =<span style="color: #000000;"> size;
</span><span style="color: #008080;">107</span>     update_zmalloc_stat_alloc(size+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">108</span>     <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">char</span>*)ptr+<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">109</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">110</span> <span style="color: #000000;">}
</span><span style="color: #008080;">111</span> 
<span style="color: #008080;">112</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Allocation and free functions that bypass the thread cache
</span><span style="color: #008080;">113</span> <span style="color: #008000;"> * and go straight to the allocator arena bins.
</span><span style="color: #008080;">114</span> <span style="color: #008000;"> * Currently implemented only for jemalloc. Used for online defragmentation. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">115</span> <span style="color: #000000;">#ifdef HAVE_DEFRAG
</span><span style="color: #008080;">116</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">zmalloc_no_tcache(size_t size) {
</span><span style="color: #008080;">117</span>     <span style="color: #0000ff;">void</span> *ptr = mallocx(size+<span style="color: #000000;">PREFIX_SIZE, MALLOCX_TCACHE_NONE);
</span><span style="color: #008080;">118</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">ptr) zmalloc_oom_handler(size);
</span><span style="color: #008080;">119</span> <span style="color: #000000;">    update_zmalloc_stat_alloc(zmalloc_size(ptr));
</span><span style="color: #008080;">120</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ptr;
</span><span style="color: #008080;">121</span> <span style="color: #000000;">}
</span><span style="color: #008080;">122</span> 
<span style="color: #008080;">123</span> <span style="color: #0000ff;">void</span> zfree_no_tcache(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr) {
</span><span style="color: #008080;">124</span>     <span style="color: #0000ff;">if</span> (ptr == NULL) <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">125</span> <span style="color: #000000;">    update_zmalloc_stat_free(zmalloc_size(ptr));
</span><span style="color: #008080;">126</span> <span style="color: #000000;">    dallocx(ptr, MALLOCX_TCACHE_NONE);
</span><span style="color: #008080;">127</span> <span style="color: #000000;">}
</span><span style="color: #008080;">128</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">129</span> 
<span style="color: #008080;">130</span> <span style="color: #0000ff;">void</span> *<span style="color: #000000;">zcalloc(size_t size) {
</span><span style="color: #008080;">131</span>     <span style="color: #0000ff;">void</span> *ptr = <span style="color: #0000ff;">calloc</span>(<span style="color: #800080;">1</span>, size+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">132</span> 
<span style="color: #008080;">133</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">ptr) zmalloc_oom_handler(size);
</span><span style="color: #008080;">134</span> <span style="color: #000000;">#ifdef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">135</span> <span style="color: #000000;">    update_zmalloc_stat_alloc(zmalloc_size(ptr));
</span><span style="color: #008080;">136</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> ptr;
</span><span style="color: #008080;">137</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">138</span>     *((size_t*)ptr) =<span style="color: #000000;"> size;
</span><span style="color: #008080;">139</span>     update_zmalloc_stat_alloc(size+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">140</span>     <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">char</span>*)ptr+<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">141</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">142</span> <span style="color: #000000;">}
</span><span style="color: #008080;">143</span> 
<span style="color: #008080;">144</span> <span style="color: #0000ff;">void</span> *zrealloc(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr, size_t size) {
</span><span style="color: #008080;">145</span> <span style="color: #000000;">#ifndef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">146</span>     <span style="color: #0000ff;">void</span> *<span style="color: #000000;">realptr;
</span><span style="color: #008080;">147</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">148</span> <span style="color: #000000;">    size_t oldsize;
</span><span style="color: #008080;">149</span>     <span style="color: #0000ff;">void</span> *<span style="color: #000000;">newptr;
</span><span style="color: #008080;">150</span> 
<span style="color: #008080;">151</span>     <span style="color: #0000ff;">if</span> (size == <span style="color: #800080;">0</span> &amp;&amp; ptr !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">152</span> <span style="color: #000000;">        zfree(ptr);
</span><span style="color: #008080;">153</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> NULL;
</span><span style="color: #008080;">154</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">155</span>     <span style="color: #0000ff;">if</span> (ptr == NULL) <span style="color: #0000ff;">return</span><span style="color: #000000;"> zmalloc(size);
</span><span style="color: #008080;">156</span> <span style="color: #000000;">#ifdef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">157</span>     oldsize =<span style="color: #000000;"> zmalloc_size(ptr);
</span><span style="color: #008080;">158</span>     newptr = <span style="color: #0000ff;">realloc</span><span style="color: #000000;">(ptr,size);
</span><span style="color: #008080;">159</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">newptr) zmalloc_oom_handler(size);
</span><span style="color: #008080;">160</span> 
<span style="color: #008080;">161</span> <span style="color: #000000;">    update_zmalloc_stat_free(oldsize);
</span><span style="color: #008080;">162</span> <span style="color: #000000;">    update_zmalloc_stat_alloc(zmalloc_size(newptr));
</span><span style="color: #008080;">163</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> newptr;
</span><span style="color: #008080;">164</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">165</span>     realptr = (<span style="color: #0000ff;">char</span>*)ptr-<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">166</span>     oldsize = *((size_t*<span style="color: #000000;">)realptr);
</span><span style="color: #008080;">167</span>     newptr = <span style="color: #0000ff;">realloc</span>(realptr,size+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">168</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">newptr) zmalloc_oom_handler(size);
</span><span style="color: #008080;">169</span> 
<span style="color: #008080;">170</span>     *((size_t*)newptr) =<span style="color: #000000;"> size;
</span><span style="color: #008080;">171</span>     update_zmalloc_stat_free(oldsize+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">172</span>     update_zmalloc_stat_alloc(size+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">173</span>     <span style="color: #0000ff;">return</span> (<span style="color: #0000ff;">char</span>*)newptr+<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">174</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">175</span> <span style="color: #000000;">}
</span><span style="color: #008080;">176</span> 
<span style="color: #008080;">177</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Provide zmalloc_size() for systems where this function is not provided by
</span><span style="color: #008080;">178</span> <span style="color: #008000;"> * malloc itself, given that in that case we store a header with this
</span><span style="color: #008080;">179</span> <span style="color: #008000;"> * information as the first bytes of every allocation. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">180</span> <span style="color: #000000;">#ifndef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">181</span> size_t zmalloc_size(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr) {
</span><span style="color: #008080;">182</span>     <span style="color: #0000ff;">void</span> *realptr = (<span style="color: #0000ff;">char</span>*)ptr-<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">183</span>     size_t size = *((size_t*<span style="color: #000000;">)realptr);
</span><span style="color: #008080;">184</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Assume at least that all the allocations are padded at sizeof(long) by
</span><span style="color: #008080;">185</span> <span style="color: #008000;">     * the underlying allocator. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">186</span>     <span style="color: #0000ff;">if</span> (size&amp;(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-<span style="color: #800080;">1</span>)) size += <span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-(size&amp;(<span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">long</span>)-<span style="color: #800080;">1</span><span style="color: #000000;">));
</span><span style="color: #008080;">187</span>     <span style="color: #0000ff;">return</span> size+<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">188</span> <span style="color: #000000;">}
</span><span style="color: #008080;">189</span> size_t zmalloc_usable(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr) {
</span><span style="color: #008080;">190</span>     <span style="color: #0000ff;">return</span> zmalloc_size(ptr)-<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">191</span> <span style="color: #000000;">}
</span><span style="color: #008080;">192</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">193</span> 
<span style="color: #008080;">194</span> <span style="color: #0000ff;">void</span> zfree(<span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr) {
</span><span style="color: #008080;">195</span> <span style="color: #000000;">#ifndef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">196</span>     <span style="color: #0000ff;">void</span> *<span style="color: #000000;">realptr;
</span><span style="color: #008080;">197</span> <span style="color: #000000;">    size_t oldsize;
</span><span style="color: #008080;">198</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">199</span> 
<span style="color: #008080;">200</span>     <span style="color: #0000ff;">if</span> (ptr == NULL) <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">201</span> <span style="color: #000000;">#ifdef HAVE_MALLOC_SIZE
</span><span style="color: #008080;">202</span> <span style="color: #000000;">    update_zmalloc_stat_free(zmalloc_size(ptr));
</span><span style="color: #008080;">203</span>     <span style="color: #0000ff;">free</span><span style="color: #000000;">(ptr);
</span><span style="color: #008080;">204</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">205</span>     realptr = (<span style="color: #0000ff;">char</span>*)ptr-<span style="color: #000000;">PREFIX_SIZE;
</span><span style="color: #008080;">206</span>     oldsize = *((size_t*<span style="color: #000000;">)realptr);
</span><span style="color: #008080;">207</span>     update_zmalloc_stat_free(oldsize+<span style="color: #000000;">PREFIX_SIZE);
</span><span style="color: #008080;">208</span>     <span style="color: #0000ff;">free</span><span style="color: #000000;">(realptr);
</span><span style="color: #008080;">209</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">210</span> <span style="color: #000000;">}
</span><span style="color: #008080;">211</span> 
<span style="color: #008080;">212</span> <span style="color: #0000ff;">char</span> *zstrdup(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">s) {
</span><span style="color: #008080;">213</span>     size_t l = strlen(s)+<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">214</span>     <span style="color: #0000ff;">char</span> *p =<span style="color: #000000;"> zmalloc(l);
</span><span style="color: #008080;">215</span> 
<span style="color: #008080;">216</span> <span style="color: #000000;">    memcpy(p,s,l);
</span><span style="color: #008080;">217</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> p;
</span><span style="color: #008080;">218</span> <span style="color: #000000;">}
</span><span style="color: #008080;">219</span> 
<span style="color: #008080;">220</span> size_t zmalloc_used_memory(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;">221</span> <span style="color: #000000;">    size_t um;
</span><span style="color: #008080;">222</span> <span style="color: #000000;">    atomicGet(used_memory,um);
</span><span style="color: #008080;">223</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> um;
</span><span style="color: #008080;">224</span> <span style="color: #000000;">}
</span><span style="color: #008080;">225</span> 
<span style="color: #008080;">226</span> <span style="color: #0000ff;">void</span> zmalloc_set_oom_handler(<span style="color: #0000ff;">void</span> (*<span style="color: #000000;">oom_handler)(size_t)) {
</span><span style="color: #008080;">227</span>     zmalloc_oom_handler =<span style="color: #000000;"> oom_handler;
</span><span style="color: #008080;">228</span> <span style="color: #000000;">}
</span><span style="color: #008080;">229</span> 
<span style="color: #008080;">230</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Get the RSS information in an OS-specific way.
</span><span style="color: #008080;">231</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">232</span> <span style="color: #008000;"> * WARNING: the function zmalloc_get_rss() is not designed to be fast
</span><span style="color: #008080;">233</span> <span style="color: #008000;"> * and may not be called in the busy loops where Redis tries to release
</span><span style="color: #008080;">234</span> <span style="color: #008000;"> * memory expiring or swapping out objects.
</span><span style="color: #008080;">235</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">236</span> <span style="color: #008000;"> * For this kind of "fast RSS reporting" usages use instead the
</span><span style="color: #008080;">237</span> <span style="color: #008000;"> * function RedisEstimateRSS() that is a much faster (and less precise)
</span><span style="color: #008080;">238</span> <span style="color: #008000;"> * version of the function. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">239</span> 
<span style="color: #008080;">240</span> <span style="color: #0000ff;">#if</span> defined(HAVE_PROC_STAT)
<span style="color: #008080;">241</span> #include &lt;unistd.h&gt;
<span style="color: #008080;">242</span> #include &lt;sys/types.h&gt;
<span style="color: #008080;">243</span> #include &lt;sys/stat.h&gt;
<span style="color: #008080;">244</span> #include &lt;fcntl.h&gt;
<span style="color: #008080;">245</span> 
<span style="color: #008080;">246</span> size_t zmalloc_get_rss(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;">247</span>     <span style="color: #0000ff;">int</span> page =<span style="color: #000000;"> sysconf(_SC_PAGESIZE);
</span><span style="color: #008080;">248</span> <span style="color: #000000;">    size_t rss;
</span><span style="color: #008080;">249</span>     <span style="color: #0000ff;">char</span> buf[<span style="color: #800080;">4096</span><span style="color: #000000;">];
</span><span style="color: #008080;">250</span>     <span style="color: #0000ff;">char</span> filename[<span style="color: #800080;">256</span><span style="color: #000000;">];
</span><span style="color: #008080;">251</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> fd, count;
</span><span style="color: #008080;">252</span>     <span style="color: #0000ff;">char</span> *p, *<span style="color: #000000;">x;
</span><span style="color: #008080;">253</span> 
<span style="color: #008080;">254</span>     snprintf(filename,<span style="color: #800080;">256</span>,<span style="color: #800000;">"</span><span style="color: #800000;">/proc/%d/stat</span><span style="color: #800000;">"</span><span style="color: #000000;">,getpid());
</span><span style="color: #008080;">255</span>     <span style="color: #0000ff;">if</span> ((fd = open(filename,O_RDONLY)) == -<span style="color: #800080;">1</span>) <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">256</span>     <span style="color: #0000ff;">if</span> (read(fd,buf,<span style="color: #800080;">4096</span>) &lt;= <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;">257</span> <span style="color: #000000;">        close(fd);
</span><span style="color: #008080;">258</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">259</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">260</span> <span style="color: #000000;">    close(fd);
</span><span style="color: #008080;">261</span> 
<span style="color: #008080;">262</span>     p =<span style="color: #000000;"> buf;
</span><span style="color: #008080;">263</span>     count = <span style="color: #800080;">23</span>; <span style="color: #008000;">/*</span><span style="color: #008000;"> RSS is the 24th field in /proc/&lt;pid&gt;/stat </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">264</span>     <span style="color: #0000ff;">while</span>(p &amp;&amp; count--<span style="color: #000000;">) {
</span><span style="color: #008080;">265</span>         p = strchr(p,<span style="color: #800000;">'</span> <span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">266</span>         <span style="color: #0000ff;">if</span> (p) p++<span style="color: #000000;">;
</span><span style="color: #008080;">267</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">268</span>     <span style="color: #0000ff;">if</span> (!p) <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">269</span>     x = strchr(p,<span style="color: #800000;">'</span> <span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">270</span>     <span style="color: #0000ff;">if</span> (!x) <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">271</span>     *x = <span style="color: #800000;">'</span><span style="color: #800000;">\0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">272</span> 
<span style="color: #008080;">273</span>     rss = strtoll(p,NULL,<span style="color: #800080;">10</span><span style="color: #000000;">);
</span><span style="color: #008080;">274</span>     rss *=<span style="color: #000000;"> page;
</span><span style="color: #008080;">275</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> rss;
</span><span style="color: #008080;">276</span> <span style="color: #000000;">}
</span><span style="color: #008080;">277</span> <span style="color: #0000ff;">#elif</span> defined(HAVE_TASKINFO)
<span style="color: #008080;">278</span> #include &lt;unistd.h&gt;
<span style="color: #008080;">279</span> #include &lt;stdio.h&gt;
<span style="color: #008080;">280</span> #include &lt;stdlib.h&gt;
<span style="color: #008080;">281</span> #include &lt;sys/types.h&gt;
<span style="color: #008080;">282</span> #include &lt;sys/sysctl.h&gt;
<span style="color: #008080;">283</span> #include &lt;mach/task.h&gt;
<span style="color: #008080;">284</span> #include &lt;mach/mach_init.h&gt;
<span style="color: #008080;">285</span> 
<span style="color: #008080;">286</span> size_t zmalloc_get_rss(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;">287</span>     task_t task =<span style="color: #000000;"> MACH_PORT_NULL;
</span><span style="color: #008080;">288</span>     <span style="color: #0000ff;">struct</span><span style="color: #000000;"> task_basic_info t_info;
</span><span style="color: #008080;">289</span>     mach_msg_type_number_t t_info_count =<span style="color: #000000;"> TASK_BASIC_INFO_COUNT;
</span><span style="color: #008080;">290</span> 
<span style="color: #008080;">291</span>     <span style="color: #0000ff;">if</span> (task_for_pid(current_task(), getpid(), &amp;task) !=<span style="color: #000000;"> KERN_SUCCESS)
</span><span style="color: #008080;">292</span>         <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">293</span>     task_info(task, TASK_BASIC_INFO, (task_info_t)&amp;t_info, &amp;<span style="color: #000000;">t_info_count);
</span><span style="color: #008080;">294</span> 
<span style="color: #008080;">295</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> t_info.resident_size;
</span><span style="color: #008080;">296</span> <span style="color: #000000;">}
</span><span style="color: #008080;">297</span> <span style="color: #0000ff;">#elif</span> defined(__FreeBSD__)
<span style="color: #008080;">298</span> #include &lt;sys/types.h&gt;
<span style="color: #008080;">299</span> #include &lt;sys/sysctl.h&gt;
<span style="color: #008080;">300</span> #include &lt;sys/user.h&gt;
<span style="color: #008080;">301</span> #include &lt;unistd.h&gt;
<span style="color: #008080;">302</span> 
<span style="color: #008080;">303</span> size_t zmalloc_get_rss(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;">304</span>     <span style="color: #0000ff;">struct</span><span style="color: #000000;"> kinfo_proc info;
</span><span style="color: #008080;">305</span>     size_t infolen = <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(info);
</span><span style="color: #008080;">306</span>     <span style="color: #0000ff;">int</span> mib[<span style="color: #800080;">4</span><span style="color: #000000;">];
</span><span style="color: #008080;">307</span>     mib[<span style="color: #800080;">0</span>] =<span style="color: #000000;"> CTL_KERN;
</span><span style="color: #008080;">308</span>     mib[<span style="color: #800080;">1</span>] =<span style="color: #000000;"> KERN_PROC;
</span><span style="color: #008080;">309</span>     mib[<span style="color: #800080;">2</span>] =<span style="color: #000000;"> KERN_PROC_PID;
</span><span style="color: #008080;">310</span>     mib[<span style="color: #800080;">3</span>] =<span style="color: #000000;"> getpid();
</span><span style="color: #008080;">311</span> 
<span style="color: #008080;">312</span>     <span style="color: #0000ff;">if</span> (sysctl(mib, <span style="color: #800080;">4</span>, &amp;info, &amp;infolen, NULL, <span style="color: #800080;">0</span>) == <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">313</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (size_t)info.ki_rssize;
</span><span style="color: #008080;">314</span> 
<span style="color: #008080;">315</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0L</span><span style="color: #000000;">;
</span><span style="color: #008080;">316</span> <span style="color: #000000;">}
</span><span style="color: #008080;">317</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">318</span> size_t zmalloc_get_rss(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;">319</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> If we can't get the RSS in an OS-specific way for this system just
</span><span style="color: #008080;">320</span> <span style="color: #008000;">     * return the memory usage we estimated in zmalloc()..
</span><span style="color: #008080;">321</span> <span style="color: #008000;">     *
</span><span style="color: #008080;">322</span> <span style="color: #008000;">     * Fragmentation will appear to be always 1 (no fragmentation)
</span><span style="color: #008080;">323</span> <span style="color: #008000;">     * of course... </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">324</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> zmalloc_used_memory();
</span><span style="color: #008080;">325</span> <span style="color: #000000;">}
</span><span style="color: #008080;">326</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">327</span> 
<span style="color: #008080;">328</span> <span style="color: #0000ff;">#if</span> defined(USE_JEMALLOC)
<span style="color: #008080;">329</span> 
<span style="color: #008080;">330</span> <span style="color: #0000ff;">int</span> zmalloc_get_allocator_info(size_t *<span style="color: #000000;">allocated,
</span><span style="color: #008080;">331</span>                                size_t *<span style="color: #000000;">active,
</span><span style="color: #008080;">332</span>                                size_t *<span style="color: #000000;">resident) {
</span><span style="color: #008080;">333</span>     uint64_t epoch = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">334</span> <span style="color: #000000;">    size_t sz;
</span><span style="color: #008080;">335</span>     *allocated = *resident = *active = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">336</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Update the statistics cached by mallctl. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">337</span>     sz = <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(epoch);
</span><span style="color: #008080;">338</span>     je_mallctl(<span style="color: #800000;">"</span><span style="color: #800000;">epoch</span><span style="color: #800000;">"</span>, &amp;epoch, &amp;sz, &amp;<span style="color: #000000;">epoch, sz);
</span><span style="color: #008080;">339</span>     sz = <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(size_t);
</span><span style="color: #008080;">340</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Unlike RSS, this does not include RSS from shared libraries and other non
</span><span style="color: #008080;">341</span> <span style="color: #008000;">     * heap mappings. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">342</span>     je_mallctl(<span style="color: #800000;">"</span><span style="color: #800000;">stats.resident</span><span style="color: #800000;">"</span>, resident, &amp;sz, NULL, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">343</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Unlike resident, this doesn't not include the pages jemalloc reserves
</span><span style="color: #008080;">344</span> <span style="color: #008000;">     * for re-use (purge will clean that). </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">345</span>     je_mallctl(<span style="color: #800000;">"</span><span style="color: #800000;">stats.active</span><span style="color: #800000;">"</span>, active, &amp;sz, NULL, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">346</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> Unlike zmalloc_used_memory, this matches the stats.resident by taking
</span><span style="color: #008080;">347</span> <span style="color: #008000;">     * into account all allocations done by this process (not only zmalloc). </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">348</span>     je_mallctl(<span style="color: #800000;">"</span><span style="color: #800000;">stats.allocated</span><span style="color: #800000;">"</span>, allocated, &amp;sz, NULL, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">349</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">350</span> <span style="color: #000000;">}
</span><span style="color: #008080;">351</span> 
<span style="color: #008080;">352</span> <span style="color: #0000ff;">void</span> set_jemalloc_bg_thread(<span style="color: #0000ff;">int</span><span style="color: #000000;"> enable) {
</span><span style="color: #008080;">353</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> let jemalloc do purging asynchronously, required when there's no traffic 
</span><span style="color: #008080;">354</span> <span style="color: #008000;">     * after flushdb </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">355</span>     <span style="color: #0000ff;">char</span> val = !!<span style="color: #000000;">enable;
</span><span style="color: #008080;">356</span>     je_mallctl(<span style="color: #800000;">"</span><span style="color: #800000;">background_thread</span><span style="color: #800000;">"</span>, NULL, <span style="color: #800080;">0</span>, &amp;val, <span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;">357</span> <span style="color: #000000;">}
</span><span style="color: #008080;">358</span> 
<span style="color: #008080;">359</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> jemalloc_purge() {
</span><span style="color: #008080;">360</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> return all unused (reserved) pages to the OS </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">361</span>     <span style="color: #0000ff;">char</span> tmp[<span style="color: #800080;">32</span><span style="color: #000000;">];
</span><span style="color: #008080;">362</span>     unsigned narenas = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">363</span>     size_t sz = <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(unsigned);
</span><span style="color: #008080;">364</span>     <span style="color: #0000ff;">if</span> (!je_mallctl(<span style="color: #800000;">"</span><span style="color: #800000;">arenas.narenas</span><span style="color: #800000;">"</span>, &amp;narenas, &amp;sz, NULL, <span style="color: #800080;">0</span><span style="color: #000000;">)) {
</span><span style="color: #008080;">365</span>         sprintf(tmp, <span style="color: #800000;">"</span><span style="color: #800000;">arena.%d.purge</span><span style="color: #800000;">"</span><span style="color: #000000;">, narenas);
</span><span style="color: #008080;">366</span>         <span style="color: #0000ff;">if</span> (!je_mallctl(tmp, NULL, <span style="color: #800080;">0</span>, NULL, <span style="color: #800080;">0</span><span style="color: #000000;">))
</span><span style="color: #008080;">367</span>             <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">368</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">369</span>     <span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">370</span> <span style="color: #000000;">}
</span><span style="color: #008080;">371</span> 
<span style="color: #008080;">372</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">373</span> 
<span style="color: #008080;">374</span> <span style="color: #0000ff;">int</span> zmalloc_get_allocator_info(size_t *<span style="color: #000000;">allocated,
</span><span style="color: #008080;">375</span>                                size_t *<span style="color: #000000;">active,
</span><span style="color: #008080;">376</span>                                size_t *<span style="color: #000000;">resident) {
</span><span style="color: #008080;">377</span>     *allocated = *resident = *active = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">378</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">379</span> <span style="color: #000000;">}
</span><span style="color: #008080;">380</span> 
<span style="color: #008080;">381</span> <span style="color: #0000ff;">void</span> set_jemalloc_bg_thread(<span style="color: #0000ff;">int</span><span style="color: #000000;"> enable) {
</span><span style="color: #008080;">382</span>     ((<span style="color: #0000ff;">void</span><span style="color: #000000;">)(enable));
</span><span style="color: #008080;">383</span> <span style="color: #000000;">}
</span><span style="color: #008080;">384</span> 
<span style="color: #008080;">385</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> jemalloc_purge() {
</span><span style="color: #008080;">386</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">387</span> <span style="color: #000000;">}
</span><span style="color: #008080;">388</span> 
<span style="color: #008080;">389</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">390</span> 
<span style="color: #008080;">391</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Get the sum of the specified field (converted form kb to bytes) in
</span><span style="color: #008080;">392</span> <span style="color: #008000;"> * /proc/self/smaps. The field must be specified with trailing ":" as it
</span><span style="color: #008080;">393</span> <span style="color: #008000;"> * apperas in the smaps output.
</span><span style="color: #008080;">394</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">395</span> <span style="color: #008000;"> * If a pid is specified, the information is extracted for such a pid,
</span><span style="color: #008080;">396</span> <span style="color: #008000;"> * otherwise if pid is -1 the information is reported is about the
</span><span style="color: #008080;">397</span> <span style="color: #008000;"> * current process.
</span><span style="color: #008080;">398</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">399</span> <span style="color: #008000;"> * Example: zmalloc_get_smap_bytes_by_field("Rss:",-1);
</span><span style="color: #008080;">400</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">401</span> <span style="color: #0000ff;">#if</span> defined(HAVE_PROC_SMAPS)
<span style="color: #008080;">402</span> size_t zmalloc_get_smap_bytes_by_field(<span style="color: #0000ff;">char</span> *field, <span style="color: #0000ff;">long</span><span style="color: #000000;"> pid) {
</span><span style="color: #008080;">403</span>     <span style="color: #0000ff;">char</span> line[<span style="color: #800080;">1024</span><span style="color: #000000;">];
</span><span style="color: #008080;">404</span>     size_t bytes = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">405</span>     <span style="color: #0000ff;">int</span> flen =<span style="color: #000000;"> strlen(field);
</span><span style="color: #008080;">406</span>     FILE *<span style="color: #000000;">fp;
</span><span style="color: #008080;">407</span> 
<span style="color: #008080;">408</span>     <span style="color: #0000ff;">if</span> (pid == -<span style="color: #800080;">1</span><span style="color: #000000;">) {
</span><span style="color: #008080;">409</span>         fp = fopen(<span style="color: #800000;">"</span><span style="color: #800000;">/proc/self/smaps</span><span style="color: #800000;">"</span>,<span style="color: #800000;">"</span><span style="color: #800000;">r</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">410</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">411</span>         <span style="color: #0000ff;">char</span> filename[<span style="color: #800080;">128</span><span style="color: #000000;">];
</span><span style="color: #008080;">412</span>         snprintf(filename,<span style="color: #0000ff;">sizeof</span>(filename),<span style="color: #800000;">"</span><span style="color: #800000;">/proc/%ld/smaps</span><span style="color: #800000;">"</span><span style="color: #000000;">,pid);
</span><span style="color: #008080;">413</span>         fp = fopen(filename,<span style="color: #800000;">"</span><span style="color: #800000;">r</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">414</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">415</span> 
<span style="color: #008080;">416</span>     <span style="color: #0000ff;">if</span> (!fp) <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">417</span>     <span style="color: #0000ff;">while</span>(fgets(line,<span style="color: #0000ff;">sizeof</span>(line),fp) !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">418</span>         <span style="color: #0000ff;">if</span> (strncmp(line,field,flen) == <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;">419</span>             <span style="color: #0000ff;">char</span> *p = strchr(line,<span style="color: #800000;">'</span><span style="color: #800000;">k</span><span style="color: #800000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">420</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (p) {
</span><span style="color: #008080;">421</span>                 *p = <span style="color: #800000;">'</span><span style="color: #800000;">\0</span><span style="color: #800000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">422</span>                 bytes += strtol(line+flen,NULL,<span style="color: #800080;">10</span>) * <span style="color: #800080;">1024</span><span style="color: #000000;">;
</span><span style="color: #008080;">423</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">424</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">425</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">426</span> <span style="color: #000000;">    fclose(fp);
</span><span style="color: #008080;">427</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> bytes;
</span><span style="color: #008080;">428</span> <span style="color: #000000;">}
</span><span style="color: #008080;">429</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">430</span> size_t zmalloc_get_smap_bytes_by_field(<span style="color: #0000ff;">char</span> *field, <span style="color: #0000ff;">long</span><span style="color: #000000;"> pid) {
</span><span style="color: #008080;">431</span>     ((<span style="color: #0000ff;">void</span><span style="color: #000000;">) field);
</span><span style="color: #008080;">432</span>     ((<span style="color: #0000ff;">void</span><span style="color: #000000;">) pid);
</span><span style="color: #008080;">433</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">434</span> <span style="color: #000000;">}
</span><span style="color: #008080;">435</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">436</span> 
<span style="color: #008080;">437</span> size_t zmalloc_get_private_dirty(<span style="color: #0000ff;">long</span><span style="color: #000000;"> pid) {
</span><span style="color: #008080;">438</span>     <span style="color: #0000ff;">return</span> zmalloc_get_smap_bytes_by_field(<span style="color: #800000;">"</span><span style="color: #800000;">Private_Dirty:</span><span style="color: #800000;">"</span><span style="color: #000000;">,pid);
</span><span style="color: #008080;">439</span> <span style="color: #000000;">}
</span><span style="color: #008080;">440</span> 
<span style="color: #008080;">441</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> Returns the size of physical memory (RAM) in bytes.
</span><span style="color: #008080;">442</span> <span style="color: #008000;"> * It looks ugly, but this is the cleanest way to achieve cross platform results.
</span><span style="color: #008080;">443</span> <span style="color: #008000;"> * Cleaned up from:
</span><span style="color: #008080;">444</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">445</span> <span style="color: #008000;"> * </span><span style="color: #008000; text-decoration: underline;">http://nadeausoftware.com/articles/2012/09/c_c_tip_how_get_physical_memory_size_system</span>
<span style="color: #008080;">446</span> <span style="color: #008000;"> *
</span><span style="color: #008080;">447</span> <span style="color: #008000;"> * Note that this function:
</span><span style="color: #008080;">448</span> <span style="color: #008000;"> * 1) Was released under the following CC attribution license:
</span><span style="color: #008080;">449</span> <span style="color: #008000;"> *    </span><span style="color: #008000; text-decoration: underline;">http://creativecommons.org/licenses/by/3.0/deed.en_US.</span>
<span style="color: #008080;">450</span> <span style="color: #008000;"> * 2) Was originally implemented by David Robert Nadeau.
</span><span style="color: #008080;">451</span> <span style="color: #008000;"> * 3) Was modified for Redis by Matt Stancliff.
</span><span style="color: #008080;">452</span> <span style="color: #008000;"> * 4) This note exists in order to comply with the original license.
</span><span style="color: #008080;">453</span>  <span style="color: #008000;">*/</span>
<span style="color: #008080;">454</span> size_t zmalloc_get_memory_size(<span style="color: #0000ff;">void</span><span style="color: #000000;">) {
</span><span style="color: #008080;">455</span> <span style="color: #0000ff;">#if</span> defined(__unix__) || defined(__unix) || defined(unix) || \
<span style="color: #008080;">456</span>     (defined(__APPLE__) &amp;&amp;<span style="color: #000000;"> defined(__MACH__))
</span><span style="color: #008080;">457</span> <span style="color: #0000ff;">#if</span> defined(CTL_HW) &amp;&amp; (defined(HW_MEMSIZE) || defined(HW_PHYSMEM64))
<span style="color: #008080;">458</span>     <span style="color: #0000ff;">int</span> mib[<span style="color: #800080;">2</span><span style="color: #000000;">];
</span><span style="color: #008080;">459</span>     mib[<span style="color: #800080;">0</span>] =<span style="color: #000000;"> CTL_HW;
</span><span style="color: #008080;">460</span> <span style="color: #0000ff;">#if</span> defined(HW_MEMSIZE)
<span style="color: #008080;">461</span>     mib[<span style="color: #800080;">1</span>] = HW_MEMSIZE;            <span style="color: #008000;">/*</span><span style="color: #008000;"> OSX. --------------------- </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">462</span> <span style="color: #0000ff;">#elif</span> defined(HW_PHYSMEM64)
<span style="color: #008080;">463</span>     mib[<span style="color: #800080;">1</span>] = HW_PHYSMEM64;          <span style="color: #008000;">/*</span><span style="color: #008000;"> NetBSD, OpenBSD. --------- </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">464</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">465</span>     int64_t size = <span style="color: #800080;">0</span>;               <span style="color: #008000;">/*</span><span style="color: #008000;"> 64-bit </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">466</span>     size_t len = <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(size);
</span><span style="color: #008080;">467</span>     <span style="color: #0000ff;">if</span> (sysctl( mib, <span style="color: #800080;">2</span>, &amp;size, &amp;len, NULL, <span style="color: #800080;">0</span>) == <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">468</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (size_t)size;
</span><span style="color: #008080;">469</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0L</span>;          <span style="color: #008000;">/*</span><span style="color: #008000;"> Failed? </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">470</span> 
<span style="color: #008080;">471</span> <span style="color: #0000ff;">#elif</span> defined(_SC_PHYS_PAGES) &amp;&amp; defined(_SC_PAGESIZE)
<span style="color: #008080;">472</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> FreeBSD, Linux, OpenBSD, and Solaris. -------------------- </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">473</span>     <span style="color: #0000ff;">return</span> (size_t)sysconf(_SC_PHYS_PAGES) *<span style="color: #000000;"> (size_t)sysconf(_SC_PAGESIZE);
</span><span style="color: #008080;">474</span> 
<span style="color: #008080;">475</span> <span style="color: #0000ff;">#elif</span> defined(CTL_HW) &amp;&amp; (defined(HW_PHYSMEM) || defined(HW_REALMEM))
<span style="color: #008080;">476</span>     <span style="color: #008000;">/*</span><span style="color: #008000;"> DragonFly BSD, FreeBSD, NetBSD, OpenBSD, and OSX. -------- </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">477</span>     <span style="color: #0000ff;">int</span> mib[<span style="color: #800080;">2</span><span style="color: #000000;">];
</span><span style="color: #008080;">478</span>     mib[<span style="color: #800080;">0</span>] =<span style="color: #000000;"> CTL_HW;
</span><span style="color: #008080;">479</span> <span style="color: #0000ff;">#if</span> defined(HW_REALMEM)
<span style="color: #008080;">480</span>     mib[<span style="color: #800080;">1</span>] = HW_REALMEM;        <span style="color: #008000;">/*</span><span style="color: #008000;"> FreeBSD. ----------------- </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">481</span> <span style="color: #0000ff;">#elif</span> defined(HW_PHYSMEM)
<span style="color: #008080;">482</span>     mib[<span style="color: #800080;">1</span>] = HW_PHYSMEM;        <span style="color: #008000;">/*</span><span style="color: #008000;"> Others. ------------------ </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">483</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">484</span>     unsigned <span style="color: #0000ff;">int</span> size = <span style="color: #800080;">0</span>;      <span style="color: #008000;">/*</span><span style="color: #008000;"> 32-bit </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">485</span>     size_t len = <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(size);
</span><span style="color: #008080;">486</span>     <span style="color: #0000ff;">if</span> (sysctl(mib, <span style="color: #800080;">2</span>, &amp;size, &amp;len, NULL, <span style="color: #800080;">0</span>) == <span style="color: #800080;">0</span><span style="color: #000000;">)
</span><span style="color: #008080;">487</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (size_t)size;
</span><span style="color: #008080;">488</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0L</span>;          <span style="color: #008000;">/*</span><span style="color: #008000;"> Failed? </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">489</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">490</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0L</span>;          <span style="color: #008000;">/*</span><span style="color: #008000;"> Unknown method to get the data. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">491</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">492</span> <span style="color: #0000ff;">#else</span>
<span style="color: #008080;">493</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0L</span>;          <span style="color: #008000;">/*</span><span style="color: #008000;"> Unknown OS. </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">494</span> <span style="color: #0000ff;">#endif</span>
<span style="color: #008080;">495</span> <span style="color: #000000;">}
</span><span style="color: #008080;">496</span> 
<span style="color: #008080;">497</span> <span style="color: #000000;">#ifdef REDIS_TEST
</span><span style="color: #008080;">498</span> <span style="color: #0000ff;">#define</span> UNUSED(x) ((void)(x))
<span style="color: #008080;">499</span> <span style="color: #0000ff;">int</span> zmalloc_test(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> **<span style="color: #000000;">argv) {
</span><span style="color: #008080;">500</span>     <span style="color: #0000ff;">void</span> *<span style="color: #000000;">ptr;
</span><span style="color: #008080;">501</span> 
<span style="color: #008080;">502</span> <span style="color: #000000;">    UNUSED(argc);
</span><span style="color: #008080;">503</span> <span style="color: #000000;">    UNUSED(argv);
</span><span style="color: #008080;">504</span>     printf(<span style="color: #800000;">"</span><span style="color: #800000;">Initial used memory: %zu\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, zmalloc_used_memory());
</span><span style="color: #008080;">505</span>     ptr = zmalloc(<span style="color: #800080;">123</span><span style="color: #000000;">);
</span><span style="color: #008080;">506</span>     printf(<span style="color: #800000;">"</span><span style="color: #800000;">Allocated 123 bytes; used: %zu\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, zmalloc_used_memory());
</span><span style="color: #008080;">507</span>     ptr = zrealloc(ptr, <span style="color: #800080;">456</span><span style="color: #000000;">);
</span><span style="color: #008080;">508</span>     printf(<span style="color: #800000;">"</span><span style="color: #800000;">Reallocated to 456 bytes; used: %zu\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, zmalloc_used_memory());
</span><span style="color: #008080;">509</span> <span style="color: #000000;">    zfree(ptr);
</span><span style="color: #008080;">510</span>     printf(<span style="color: #800000;">"</span><span style="color: #800000;">Freed pointer; used: %zu\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, zmalloc_used_memory());
</span><span style="color: #008080;">511</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">512</span> <span style="color: #000000;">}
</span><span style="color: #008080;">513</span> <span style="color: #0000ff;">#endif</span></span></code></pre>

<p><span style="font-family: 'courier new', courier;">这里提了一个优化, 减少代码的无效操作.&nbsp;</span></p>
<p><span style="font-family: 'courier new', courier;"><a href="https://github.com/antirez/redis/pull/6591/commits/ddeece5d690ec41af051a842afe20a3e0ba25d37">https://github.com/antirez/redis/pull/6591/commits/ddeece5d690ec41af051a842afe20a3e0ba25d37</a></span></p>
<p><span style="font-family: 'courier new', courier;">整体代码非常简单. PREFIX_SIZE 用于记录申请内存块大小用的,&nbsp; 额外的, 写写, 自然就全明白了.&nbsp; 相比其它</span></p>
<p><span style="font-family: 'courier new', courier;">模块多了 zmalloc_test 单元测试. 调用的地方可以看 src/server.c&nbsp;</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #0000ff;">void</span> _serverPanic(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *file, <span style="color: #0000ff;">int</span> line, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">msg, ...) {
    va_list ap;
    va_start(ap,msg);
    </span><span style="color: #0000ff;">char</span> fmtmsg[<span style="color: #800080;">256</span><span style="color: #000000;">];
    vsnprintf(fmtmsg,</span><span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(fmtmsg),msg,ap);
    va_end(ap);

    bugReportStart();
    serverLog(LL_WARNING,</span><span style="color: #800000;">"</span><span style="color: #800000;">------------------------------------------------</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    serverLog(LL_WARNING,</span><span style="color: #800000;">"</span><span style="color: #800000;">!!! Software Failure. Press left mouse button to continue</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    serverLog(LL_WARNING,</span><span style="color: #800000;">"</span><span style="color: #800000;">Guru Meditation: %s #%s:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">,fmtmsg,file,line);
#ifdef HAVE_BACKTRACE
    serverLog(LL_WARNING,</span><span style="color: #800000;">"</span><span style="color: #800000;">(forcing SIGSEGV in order to print the stack trace)</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #0000ff;">#endif</span><span style="color: #000000;">
    serverLog(LL_WARNING,</span><span style="color: #800000;">"</span><span style="color: #800000;">------------------------------------------------</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    </span>*((<span style="color: #0000ff;">char</span>*)-<span style="color: #800080;">1</span>) = <span style="color: #800000;">'</span><span style="color: #800000;">x</span><span style="color: #800000;">'</span><span style="color: #000000;">;
}

</span><span style="color: #0000ff;">#define</span> serverPanic(...) _serverPanic(__FILE__,__LINE__,__VA_ARGS__),_exit(1)

<span style="color: #0000ff;">void</span><span style="color: #000000;"> redisOutOfMemoryHandler(size_t allocation_size) {
    serverLog(LL_WARNING,</span><span style="color: #800000;">"</span><span style="color: #800000;">Out Of Memory allocating %zu bytes!</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        allocation_size);
    serverPanic(</span><span style="color: #800000;">"</span><span style="color: #800000;">Redis aborting for OUT OF MEMORY</span><span style="color: #800000;">"</span><span style="color: #000000;">);
}

</span><span style="color: #0000ff;">void</span> redisSetProcTitle(<span style="color: #0000ff;">char</span> *<span style="color: #000000;">title) {
#ifdef USE_SETPROCTITLE
    </span><span style="color: #0000ff;">char</span> *server_mode = <span style="color: #800000;">""</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">if</span> (server.cluster_enabled) server_mode = <span style="color: #800000;">"</span><span style="color: #800000;"> [cluster]</span><span style="color: #800000;">"</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (server.sentinel_mode) server_mode = <span style="color: #800000;">"</span><span style="color: #800000;"> [sentinel]</span><span style="color: #800000;">"</span><span style="color: #000000;">;

    setproctitle(</span><span style="color: #800000;">"</span><span style="color: #800000;">%s %s:%d%s</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        title,
        server.bindaddr_count </span>? server.bindaddr[<span style="color: #800080;">0</span>] : <span style="color: #800000;">"</span><span style="color: #800000;">*</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        server.port </span>?<span style="color: #000000;"> server.port : server.tls_port,
        server_mode);
</span><span style="color: #0000ff;">#else</span><span style="color: #000000;">
    UNUSED(title);
</span><span style="color: #0000ff;">#endif</span><span style="color: #000000;">
}

</span><span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span> **<span style="color: #000000;">argv) {
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> timeval tv;
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> j;

#ifdef REDIS_TEST
    </span><span style="color: #0000ff;">if</span> (argc == <span style="color: #800080;">3</span> &amp;&amp; !strcasecmp(argv[<span style="color: #800080;">1</span>], <span style="color: #800000;">"</span><span style="color: #800000;">test</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
        </span><span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">ziplist</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ziplistTest(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">quicklist</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            quicklistTest(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">intset</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> intsetTest(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">zipmap</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> zipmapTest(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">sha1test</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> sha1Test(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">util</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> utilTest(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">endianconv</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> endianconvTest(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">crc64</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> crc64Test(argc, argv);
        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (!strcasecmp(argv[<span style="color: #800080;">2</span>], <span style="color: #800000;">"</span><span style="color: #800000;">zmalloc</span><span style="color: #800000;">"</span><span style="color: #000000;">)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> zmalloc_test(argc, argv);
        }

        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span>; <span style="color: #008000;">/*</span><span style="color: #008000;"> test not found </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    }
</span><span style="color: #0000ff;">#endif</span>

    <span style="color: #008000;">/*</span><span style="color: #008000;"> We need to initialize our libraries, and the server configuration. </span><span style="color: #008000;">*/</span><span style="color: #000000;">
#ifdef INIT_SETPROCTITLE_REPLACEMENT
    spt_init(argc, argv);
</span><span style="color: #0000ff;">#endif</span><span style="color: #000000;">
    setlocale(LC_COLLATE,</span><span style="color: #800000;">""</span><span style="color: #000000;">);
    tzset(); </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Populates 'timezone' global. </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    zmalloc_set_oom_handler(redisOutOfMemoryHandler);
    srand(time(NULL)</span>^<span style="color: #000000;">getpid());
    gettimeofday(</span>&amp;tv,NULL);</span><br /><span style="font-family: 'courier new', courier;">    ...</span><br /><span style="font-family: 'courier new', courier;">    ..</span><br /><span style="font-family: 'courier new', courier;">    .</span></code></pre>

<p><span style="font-family: 'courier new', courier;">通过这些预计你也看出点门道了吧. 关于 adlist 代码应该也了解七七八八了.&nbsp;最后我们进入操练编译环节,</span></p>
<p><span style="font-family: 'courier new', courier;">打通边角最后的一公里.</span></p>
<p><span style="font-family: 'courier new', courier; font-size: 15px;"><strong>6. redis Makefile 解析</strong></span></p>
<p><span style="font-family: 'courier new', courier;">加了注释, 方便大家自行逐个阅读 mkreleasehdr.sh 和 Makefile, 感悟编译的不容易.</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #0000ff;">sh</span>
<span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #000000;"># git log 第一个八位hash 值
</span><span style="color: #008080;"> 4</span> GIT_SHA1=`(git show-ref --<span style="color: #0000ff;">head</span> --hash=<span style="color: #800080;">8</span> <span style="color: #800080;">2</span>&gt;/dev/<span style="color: #0000ff;">null</span> || <span style="color: #0000ff;">echo</span> <span style="color: #800080;">00000000</span>) | <span style="color: #0000ff;">head</span> -<span style="color: #000000;">n1`
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> # 显示提交, 提交和工作树等之间的变化, 禁止外部差异驱动程序. 系统默认的 git <span style="color: #0000ff;">diff</span>
<span style="color: #008080;"> 7</span> GIT_DIRTY=`git <span style="color: #0000ff;">diff</span> --no-ext-<span style="color: #0000ff;">diff</span> <span style="color: #800080;">2</span>&gt;/dev/<span style="color: #0000ff;">null</span> | <span style="color: #0000ff;">wc</span> -<span style="color: #000000;">l`
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span> # {网络节点上的主机名}-<span style="color: #000000;">{时间戳}
</span><span style="color: #008080;">10</span> BUILD_ID=`<span style="color: #0000ff;">uname</span> -n`<span style="color: #800000;">"</span><span style="color: #800000;">-</span><span style="color: #800000;">"</span>`<span style="color: #0000ff;">date</span> +%<span style="color: #000000;">s`
</span><span style="color: #008080;">11</span> # -n 判断 <span style="color: #800000;">"</span><span style="color: #800000;">$SOURCE_DATE_EPOCH</span><span style="color: #800000;">"</span><span style="color: #000000;"> 是否不是空串, 不是为真
</span><span style="color: #008080;">12</span> <span style="color: #0000ff;">if</span> [ -n <span style="color: #800000;">"</span><span style="color: #800000;">$SOURCE_DATE_EPOCH</span><span style="color: #800000;">"</span> ] <span style="color: #0000ff;">then</span>
<span style="color: #008080;">13</span>     # SOURCE_DATE_EPOCH=<span style="color: #800080;">1574154953</span> -&gt; <span style="color: #0000ff;">date</span> -u -d <span style="color: #800000;">"</span><span style="color: #800000;">@1574154953</span><span style="color: #800000;">"</span> +%s -&gt; <span style="color: #800080;">1574154953</span><span style="color: #000000;"> 还是传入的时间戳
</span><span style="color: #008080;">14</span>     # SOURCE_DATE_EPOCH=src -&gt; <span style="color: #0000ff;">date</span> -u -r <span style="color: #800000;">"</span><span style="color: #800000;">src</span><span style="color: #800000;">"</span> +%s -&gt; <span style="color: #800080;">1574153469</span><span style="color: #000000;"> 显示指定文件的最后修改时间
</span><span style="color: #008080;">15</span>     # <span style="color: #0000ff;">date</span> -u +%s -&gt; <span style="color: #800080;">1574155246</span> -&gt;<span style="color: #000000;"> 输出或者设置协调的通用时间
</span><span style="color: #008080;">16</span>     BUILD_ID=$(<span style="color: #0000ff;">date</span> -u -d <span style="color: #800000;">"</span><span style="color: #800000;">@$SOURCE_DATE_EPOCH</span><span style="color: #800000;">"</span> +%s <span style="color: #800080;">2</span>&gt;/dev/<span style="color: #0000ff;">null</span> || <span style="color: #0000ff;">date</span> -u -r <span style="color: #800000;">"</span><span style="color: #800000;">$SOURCE_DATE_EPOCH</span><span style="color: #800000;">"</span> +%s <span style="color: #800080;">2</span>&gt;/dev/<span style="color: #0000ff;">null</span> || <span style="color: #0000ff;">date</span> -u +%<span style="color: #000000;">s)
</span><span style="color: #008080;">17</span> <span style="color: #0000ff;">fi</span>
<span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span> <span style="color: #000000;"># 测试 release.h 文件是否存在, 不存在就创建
</span><span style="color: #008080;">20</span> test -f release.h || <span style="color: #0000ff;">touch</span><span style="color: #000000;"> release.h
</span><span style="color: #008080;">21</span> <span style="color: #000000;"># 判断 release.h 是否已经创建 OK, OK 的话 exit 退出
</span><span style="color: #008080;">22</span> (<span style="color: #0000ff;">cat</span> release.h | <span style="color: #0000ff;">grep</span> SHA1 | <span style="color: #0000ff;">grep</span> $GIT_SHA1) &amp;&amp;<span style="color: #000000;"> \
</span><span style="color: #008080;">23</span> (<span style="color: #0000ff;">cat</span> release.h | <span style="color: #0000ff;">grep</span> DIRTY | <span style="color: #0000ff;">grep</span> $GIT_DIRTY) &amp;&amp; exit <span style="color: #800080;">0</span> # Already up-to-<span style="color: #0000ff;">date</span>
<span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span> <span style="color: #000000;"># release.h 写入宏配置 REDIS_GIT_SHA1 REDIS_GIT_DIRTY REDIS_BUILD_ID
</span><span style="color: #008080;">26</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">"</span><span style="color: #800000;">#define REDIS_GIT_SHA1 \"$GIT_SHA1\"</span><span style="color: #800000;">"</span> &gt;<span style="color: #000000;"> release.h
</span><span style="color: #008080;">27</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">"</span><span style="color: #800000;">#define REDIS_GIT_DIRTY \"$GIT_DIRTY\"</span><span style="color: #800000;">"</span> &gt;&gt;<span style="color: #000000;"> release.h
</span><span style="color: #008080;">28</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">"</span><span style="color: #800000;">#define REDIS_BUILD_ID \"$BUILD_ID\"</span><span style="color: #800000;">"</span> &gt;&gt;<span style="color: #000000;"> release.h
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span> # <span style="color: #0000ff;">touch</span><span style="color: #000000;"> 更新 文件访问时间 atime 文件内容更改时间 mtime 文件状态改动时间 ctime
</span><span style="color: #008080;">31</span> <span style="color: #0000ff;">touch</span> release.c # Force recompile release.c</span></code></pre>

<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #008080;">  1</span> <span style="color: #000000;"># Redis Makefile
</span><span style="color: #008080;">  2</span> # Copyright (C) <span style="color: #800080;">2009</span> Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;
<span style="color: #008080;">  3</span> # This <span style="color: #0000ff;">file</span> is released under the BSD license, see the COPYING <span style="color: #0000ff;">file</span>
<span style="color: #008080;">  4</span> <span style="color: #000000;">#
</span><span style="color: #008080;">  5</span> <span style="color: #000000;"># The Makefile composes the final FINAL_CFLAGS and FINAL_LDFLAGS using
</span><span style="color: #008080;">  6</span> # what is needed <span style="color: #0000ff;">for</span><span style="color: #000000;"> Redis plus the standard CFLAGS and LDFLAGS passed.
</span><span style="color: #008080;">  7</span> <span style="color: #000000;"># However when building the dependencies (Jemalloc, Lua, Hiredis, ...)
</span><span style="color: #008080;">  8</span> <span style="color: #000000;"># CFLAGS and LDFLAGS are propagated to the dependencies, so to pass
</span><span style="color: #008080;">  9</span> # flags only to be used when compiling /<span style="color: #000000;"> linking Redis itself REDIS_CFLAGS
</span><span style="color: #008080;"> 10</span> # and REDIS_LDFLAGS are used instead (this is the <span style="color: #0000ff;">case</span> of <span style="color: #800000;">'</span><span style="color: #800000;">make gcov</span><span style="color: #800000;">'</span><span style="color: #000000;">).
</span><span style="color: #008080;"> 11</span> <span style="color: #000000;">#
</span><span style="color: #008080;"> 12</span> # Dependencies are stored <span style="color: #0000ff;">in</span> the Makefile.dep <span style="color: #0000ff;">file</span>. To rebuild this <span style="color: #0000ff;">file</span>
<span style="color: #008080;"> 13</span> # Just use <span style="color: #800000;">'</span><span style="color: #800000;">make dep</span><span style="color: #800000;">'</span><span style="color: #000000;">, but this is only needed by developers.
</span><span style="color: #008080;"> 14</span> 
<span style="color: #008080;"> 15</span> # Makefile run <span style="color: #0000ff;">sh</span> ./mkreleasehdr.<span style="color: #0000ff;">sh</span>
<span style="color: #008080;"> 16</span> release_hdr := $(shell <span style="color: #0000ff;">sh</span> -c <span style="color: #800000;">'</span><span style="color: #800000;">./mkreleasehdr.sh</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 17</span> # 定义直接展示式变量 uname_S := 内核名称, 例如 <span style="color: #0000ff;">uname</span> -s -&gt;<span style="color: #000000;"> Linux 
</span><span style="color: #008080;"> 18</span> uname_S := $(shell <span style="color: #0000ff;">sh</span> -c <span style="color: #800000;">'</span><span style="color: #800000;">uname -s 2&gt;/dev/null || echo not</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 19</span> # 定义直接展示式变量 uname_M := 主机的硬件架构名称, 例如 <span style="color: #0000ff;">uname</span> -s -&gt;<span style="color: #000000;"> x86_64
</span><span style="color: #008080;"> 20</span> uname_M := $(shell <span style="color: #0000ff;">sh</span> -c <span style="color: #800000;">'</span><span style="color: #800000;">uname -m 2&gt;/dev/null || echo not</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 21</span> # 定义条件赋值变量, 当 OPTIMIZATION 不存在, 会有 OPTIMIZATION :=-<span style="color: #000000;">O2, 否则不改变 OPTIMIZATION
</span><span style="color: #008080;"> 22</span> OPTIMIZATION?=-<span style="color: #000000;">O2
</span><span style="color: #008080;"> 23</span> # 定义递归展开式变量 DEPENDENCY_TARGETS =<span style="color: #000000;">hiredis linenoise lua
</span><span style="color: #008080;"> 24</span> # Makefile 展开时候 =<span style="color: #000000;"> 后面如果有空格, 会保留.
</span><span style="color: #008080;"> 25</span> DEPENDENCY_TARGETS=<span style="color: #000000;">hiredis linenoise lua
</span><span style="color: #008080;"> 26</span> # 定义直接展示式变量 NODEPS :=<span style="color: #000000;">clean distclean
</span><span style="color: #008080;"> 27</span> NODEPS:=<span style="color: #000000;">clean distclean
</span><span style="color: #008080;"> 28</span> 
<span style="color: #008080;"> 29</span> <span style="color: #000000;"># Default settings
</span><span style="color: #008080;"> 30</span> # -std=<span style="color: #000000;">c11  使用 C11 标准
</span><span style="color: #008080;"> 31</span> # -pedantic 以ANSI/<span style="color: #000000;">ISO C标准列出的所有警告
</span><span style="color: #008080;"> 32</span> # -DREDIS_STATIC=<span style="color: #800000;">''</span> 进行 REDIS_STATIC=<span style="color: #800000;">''</span><span style="color: #000000;"> 宏定义
</span><span style="color: #008080;"> 33</span> STD=-std=c11 -pedantic -DREDIS_STATIC=<span style="color: #800000;">''</span>
<span style="color: #008080;"> 34</span> # ifneq ($<span style="color: #800080;">1</span>, $<span style="color: #800080;">2</span>) $<span style="color: #800080;">1</span> != $<span style="color: #800080;">2</span><span style="color: #000000;"> 为真 
</span><span style="color: #008080;"> 35</span> <span style="color: #000000;"># $(findstring clang,$(CC)) 在 $(CC) 中查找 clang 字符串, 找到了返回 clang, 否则返回空串
</span><span style="color: #008080;"> 36</span> <span style="color: #000000;"># $(findstring FreeBSD,$(uname_S)) 在 $(uname_S) 中查找 FreeBSD 字符串 ...
</span><span style="color: #008080;"> 37</span> # -Wno-c11-<span style="color: #000000;">extensions 删除 C11 扩展警告
</span><span style="color: #008080;"> 38</span> <span style="color: #000000;">ifneq (,$(findstring clang,$(CC)))
</span><span style="color: #008080;"> 39</span> <span style="color: #000000;">ifneq (,$(findstring FreeBSD,$(uname_S)))
</span><span style="color: #008080;"> 40</span>   STD+=-Wno-c11-<span style="color: #000000;">extensions
</span><span style="color: #008080;"> 41</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 42</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 43</span> # -<span style="color: #000000;">Wall 显示编译后所有警告
</span><span style="color: #008080;"> 44</span> # -W 类似-<span style="color: #000000;">Wall 会显示警告, 但是只显示编译器认为会出现错误的警告
</span><span style="color: #008080;"> 45</span> # -Wno-missing-field-<span style="color: #000000;">initializers 禁止结构初始化未指定所有字段警告
</span><span style="color: #008080;"> 46</span> WARN=-Wall -W -Wno-missing-field-<span style="color: #000000;">initializers
</span><span style="color: #008080;"> 47</span> # 定义递归展开式变量 OPT =$(OPTIMIZATION) ?=-<span style="color: #000000;">O2
</span><span style="color: #008080;"> 48</span> OPT=<span style="color: #000000;">$(OPTIMIZATION)
</span><span style="color: #008080;"> 49</span> 
<span style="color: #008080;"> 50</span> # # 定义条件赋值变量, 当 PREFIX 不存在, 会有 PREFIX :=/usr/<span style="color: #000000;">local, 否则维持 PREFIX 变量不变
</span><span style="color: #008080;"> 51</span> PREFIX?=/usr/<span style="color: #000000;">local
</span><span style="color: #008080;"> 52</span> INSTALL_BIN=$(PREFIX)/<span style="color: #000000;">bin
</span><span style="color: #008080;"> 53</span> INSTALL=<span style="color: #0000ff;">install</span>
<span style="color: #008080;"> 54</span> 
<span style="color: #008080;"> 55</span> # Default allocator defaults to Jemalloc <span style="color: #0000ff;">if</span> it<span style="color: #800000;">'</span><span style="color: #800000;">s not an ARM</span>
<span style="color: #008080;"> 56</span> MALLOC=<span style="color: #000000;">libc
</span><span style="color: #008080;"> 57</span> <span style="color: #000000;"># ifneq ($(uname_M),armv6l) $(uname_M) 硬件架构不是 armv6l 才为真
</span><span style="color: #008080;"> 58</span> <span style="color: #000000;"># ifneq ($(uname_M),armv7l) $(uname_M) 硬件架构不是 armv7l 才为真
</span><span style="color: #008080;"> 59</span> <span style="color: #000000;"># ifeq ($(uname_S),Linux) $(uname_S) 内核名称是 Linux 才为真
</span><span style="color: #008080;"> 60</span> <span style="color: #000000;">ifneq ($(uname_M),armv6l)
</span><span style="color: #008080;"> 61</span> <span style="color: #000000;">ifneq ($(uname_M),armv7l)
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">ifeq ($(uname_S),Linux)
</span><span style="color: #008080;"> 63</span>     MALLOC=<span style="color: #000000;">jemalloc
</span><span style="color: #008080;"> 64</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 65</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 66</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 67</span> 
<span style="color: #008080;"> 68</span> # To get ARM stack traces <span style="color: #0000ff;">if</span><span style="color: #000000;"> Redis crashes we need a special C flag.
</span><span style="color: #008080;"> 69</span> <span style="color: #000000;"># $(filter aarch64 armv,$(uname_M)) $(uname_M) 硬件架构中如果是 aarch64 or armv 就保留
</span><span style="color: #008080;"> 70</span> # -funwind-<span style="color: #000000;">tables 开启便于做 backtrace
</span><span style="color: #008080;"> 71</span> #    unwind table 表记录了与函数相关的信息, 函数的起始地址, 函数的结束地址, 一个 <span style="color: #0000ff;">info</span><span style="color: #000000;"> block 指针
</span><span style="color: #008080;"> 72</span> <span style="color: #000000;">ifneq (,$(filter aarch64 armv,$(uname_M)))
</span><span style="color: #008080;"> 73</span>         CFLAGS+=-funwind-<span style="color: #000000;">tables
</span><span style="color: #008080;"> 74</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;"> 75</span> <span style="color: #000000;">ifneq (,$(findstring armv,$(uname_M)))
</span><span style="color: #008080;"> 76</span>         CFLAGS+=-funwind-<span style="color: #000000;">tables
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 78</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 79</span> 
<span style="color: #008080;"> 80</span> # Backwards compatibility <span style="color: #0000ff;">for</span><span style="color: #000000;"> selecting an allocator
</span><span style="color: #008080;"> 81</span> <span style="color: #000000;">ifeq ($(USE_TCMALLOC),yes)
</span><span style="color: #008080;"> 82</span>     MALLOC=<span style="color: #000000;">tcmalloc
</span><span style="color: #008080;"> 83</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 84</span> 
<span style="color: #008080;"> 85</span> <span style="color: #000000;">ifeq ($(USE_TCMALLOC_MINIMAL),yes)
</span><span style="color: #008080;"> 86</span>     MALLOC=<span style="color: #000000;">tcmalloc_minimal
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 88</span> 
<span style="color: #008080;"> 89</span> # ifeq ($(USE_JEMALLOC),yes) $(USE_JEMALLOC) == yes 会让 MALLOC=<span style="color: #000000;">jemalloc
</span><span style="color: #008080;"> 90</span> <span style="color: #000000;">ifeq ($(USE_JEMALLOC),yes)
</span><span style="color: #008080;"> 91</span>     MALLOC=<span style="color: #000000;">jemalloc
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 93</span> 
<span style="color: #008080;"> 94</span> <span style="color: #000000;">ifeq ($(USE_JEMALLOC),no)
</span><span style="color: #008080;"> 95</span>     MALLOC=<span style="color: #000000;">libc
</span><span style="color: #008080;"> 96</span> <span style="color: #000000;">endif
</span><span style="color: #008080;"> 97</span> 
<span style="color: #008080;"> 98</span> # Override default settings <span style="color: #0000ff;">if</span><span style="color: #000000;"> possible
</span><span style="color: #008080;"> 99</span> # -<span style="color: #000000;"> 忽略错误
</span><span style="color: #008080;">100</span> # include .<span style="color: #0000ff;">make</span>-settings 导入 .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings Makefile 文件
</span><span style="color: #008080;">101</span> -include .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">102</span> 
<span style="color: #008080;">103</span> <span style="color: #000000;"># 以 Linux jemalloc 为例
</span><span style="color: #008080;">104</span> # FINAL_CFLAGS=-std=c11 -pedantic -DREDIS_STATIC=<span style="color: #800000;">''</span> -Wall -W -Wno-missing-field-initializers -O2 -g -<span style="color: #000000;">ggdb 
</span><span style="color: #008080;">105</span> # FINAL_LDFLAGS= -g -<span style="color: #000000;">ggdb
</span><span style="color: #008080;">106</span> # -<span style="color: #000000;">g 操作系统的原生格式(native format)生成调试信息, 其它调试器也可以用
</span><span style="color: #008080;">107</span> # -<span style="color: #000000;">ggdb 使 GCC 为 GDB 生成专用的更为丰富的调试信息
</span><span style="color: #008080;">108</span> # -<span style="color: #000000;">lm 链接 math.h 相关库
</span><span style="color: #008080;">109</span> FINAL_CFLAGS=<span style="color: #000000;">$(STD) $(WARN) $(OPT) $(DEBUG) $(CFLAGS) $(REDIS_CFLAGS)
</span><span style="color: #008080;">110</span> FINAL_LDFLAGS=<span style="color: #000000;">$(LDFLAGS) $(REDIS_LDFLAGS) $(DEBUG)
</span><span style="color: #008080;">111</span> FINAL_LIBS=-<span style="color: #000000;">lm
</span><span style="color: #008080;">112</span> DEBUG=-g -<span style="color: #000000;">ggdb
</span><span style="color: #008080;">113</span> 
<span style="color: #008080;">114</span> <span style="color: #000000;">ifeq ($(uname_S),SunOS)
</span><span style="color: #008080;">115</span> <span style="color: #000000;">    # SunOS
</span><span style="color: #008080;">116</span> <span style="color: #000000;">        ifneq ($(@@),32bit)
</span><span style="color: #008080;">117</span>         CFLAGS+= -<span style="color: #000000;">m64
</span><span style="color: #008080;">118</span>         LDFLAGS+= -<span style="color: #000000;">m64
</span><span style="color: #008080;">119</span> <span style="color: #000000;">    endif
</span><span style="color: #008080;">120</span>     DEBUG=-<span style="color: #000000;">g
</span><span style="color: #008080;">121</span>     DEBUG_FLAGS=-<span style="color: #000000;">g
</span><span style="color: #008080;">122</span> <span style="color: #000000;">    export CFLAGS LDFLAGS DEBUG DEBUG_FLAGS
</span><span style="color: #008080;">123</span>     INSTALL=<span style="color: #0000ff;">cp</span> -<span style="color: #000000;">pf
</span><span style="color: #008080;">124</span>     FINAL_CFLAGS+= -D__EXTENSIONS__ -<span style="color: #000000;">D_XPG6
</span><span style="color: #008080;">125</span>     FINAL_LIBS+= -ldl -lnsl -lsocket -lresolv -lpthread -<span style="color: #000000;">lrt
</span><span style="color: #008080;">126</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;">127</span> <span style="color: #000000;">ifeq ($(uname_S),Darwin)
</span><span style="color: #008080;">128</span> <span style="color: #000000;">    # Darwin
</span><span style="color: #008080;">129</span>     FINAL_LIBS+= -<span style="color: #000000;">ldl
</span><span style="color: #008080;">130</span>     OPENSSL_CFLAGS=-I/usr/local/opt/openssl/<span style="color: #000000;">include
</span><span style="color: #008080;">131</span>     OPENSSL_LDFLAGS=-L/usr/local/opt/openssl/<span style="color: #000000;">lib
</span><span style="color: #008080;">132</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;">133</span> <span style="color: #000000;">ifeq ($(uname_S),AIX)
</span><span style="color: #008080;">134</span> <span style="color: #000000;">        # AIX
</span><span style="color: #008080;">135</span>         FINAL_LDFLAGS+= -Wl,-<span style="color: #000000;">bexpall
</span><span style="color: #008080;">136</span>         FINAL_LIBS+=-ldl -pthread -lcrypt -<span style="color: #000000;">lbsd
</span><span style="color: #008080;">137</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;">138</span> <span style="color: #000000;">ifeq ($(uname_S),OpenBSD)
</span><span style="color: #008080;">139</span> <span style="color: #000000;">    # OpenBSD
</span><span style="color: #008080;">140</span>     FINAL_LIBS+= -<span style="color: #000000;">lpthread
</span><span style="color: #008080;">141</span> <span style="color: #000000;">    ifeq ($(USE_BACKTRACE),yes)
</span><span style="color: #008080;">142</span>         FINAL_CFLAGS+= -DUSE_BACKTRACE -I/usr/local/<span style="color: #000000;">include
</span><span style="color: #008080;">143</span>         FINAL_LDFLAGS+= -L/usr/local/<span style="color: #000000;">lib
</span><span style="color: #008080;">144</span>         FINAL_LIBS+= -<span style="color: #000000;">lexecinfo
</span><span style="color: #008080;">145</span> <span style="color: #000000;">        endif
</span><span style="color: #008080;">146</span> 
<span style="color: #008080;">147</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;">148</span> <span style="color: #000000;">ifeq ($(uname_S),FreeBSD)
</span><span style="color: #008080;">149</span> <span style="color: #000000;">    # FreeBSD
</span><span style="color: #008080;">150</span>     FINAL_LIBS+= -lpthread -<span style="color: #000000;">lexecinfo
</span><span style="color: #008080;">151</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;">152</span> <span style="color: #000000;">ifeq ($(uname_S),DragonFly)
</span><span style="color: #008080;">153</span> <span style="color: #000000;">    # FreeBSD
</span><span style="color: #008080;">154</span>     FINAL_LIBS+= -lpthread -<span style="color: #000000;">lexecinfo
</span><span style="color: #008080;">155</span> <span style="color: #0000ff;">else</span>
<span style="color: #008080;">156</span> <span style="color: #000000;">    # All the other OSes (notably Linux)
</span><span style="color: #008080;">157</span>     FINAL_LDFLAGS+= -<span style="color: #000000;">rdynamic
</span><span style="color: #008080;">158</span>     FINAL_LIBS+=-ldl -pthread -<span style="color: #000000;">lrt
</span><span style="color: #008080;">159</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">160</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">161</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">162</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">163</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">164</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">165</span> <span style="color: #000000;"># Include paths to dependencies
</span><span style="color: #008080;">166</span> FINAL_CFLAGS+= -I../deps/hiredis -I../deps/linenoise -I../deps/lua/<span style="color: #000000;">src
</span><span style="color: #008080;">167</span> 
<span style="color: #008080;">168</span> <span style="color: #000000;">ifeq ($(MALLOC),tcmalloc)
</span><span style="color: #008080;">169</span>     FINAL_CFLAGS+= -<span style="color: #000000;">DUSE_TCMALLOC
</span><span style="color: #008080;">170</span>     FINAL_LIBS+= -<span style="color: #000000;">ltcmalloc
</span><span style="color: #008080;">171</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">172</span> 
<span style="color: #008080;">173</span> <span style="color: #000000;">ifeq ($(MALLOC),tcmalloc_minimal)
</span><span style="color: #008080;">174</span>     FINAL_CFLAGS+= -<span style="color: #000000;">DUSE_TCMALLOC
</span><span style="color: #008080;">175</span>     FINAL_LIBS+= -<span style="color: #000000;">ltcmalloc_minimal
</span><span style="color: #008080;">176</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">177</span> 
<span style="color: #008080;">178</span> # ifeq ($(MALLOC),jemalloc) $(MALLOC) ==<span style="color: #000000;"> jemalloc 为真才进入条件分支
</span><span style="color: #008080;">179</span> # DEPENDENCY_TARGETS += jemalloc -&gt; DEPENDENCY_TARGETS =<span style="color: #000000;"> hiredis linenoise lua jemalloc
</span><span style="color: #008080;">180</span> # FINAL_CFLAGS 继续 += -DUSE_JEMALLOC -I../deps/jemalloc/<span style="color: #000000;">include 引入 USE_JEMALLOC 宏和指定头文件路径
</span><span style="color: #008080;">181</span> # FINAL_LIBS := ../deps/jemalloc/lib/libjemalloc.a -<span style="color: #000000;">lm
</span><span style="color: #008080;">182</span> <span style="color: #000000;">ifeq ($(MALLOC),jemalloc)
</span><span style="color: #008080;">183</span>     DEPENDENCY_TARGETS+=<span style="color: #000000;"> jemalloc
</span><span style="color: #008080;">184</span>     FINAL_CFLAGS+= -DUSE_JEMALLOC -I../deps/jemalloc/<span style="color: #000000;">include
</span><span style="color: #008080;">185</span>     FINAL_LIBS := ../deps/jemalloc/lib/<span style="color: #000000;">libjemalloc.a $(FINAL_LIBS)
</span><span style="color: #008080;">186</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">187</span> 
<span style="color: #008080;">188</span> # BUILD_TLS -&gt;<span style="color: #000000;"> USE_OPENSSL
</span><span style="color: #008080;">189</span> <span style="color: #000000;">ifeq ($(BUILD_TLS),yes)
</span><span style="color: #008080;">190</span>     FINAL_CFLAGS+=-<span style="color: #000000;">DUSE_OPENSSL $(OPENSSL_CFLAGS)
</span><span style="color: #008080;">191</span>     FINAL_LDFLAGS+=<span style="color: #000000;">$(OPENSSL_LDFLAGS)
</span><span style="color: #008080;">192</span>     FINAL_LIBS += ../deps/hiredis/libhiredis_ssl.a -lssl -<span style="color: #000000;">lcrypto
</span><span style="color: #008080;">193</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">194</span> 
<span style="color: #008080;">195</span> REDIS_CC=<span style="color: #000000;">$(QUIET_CC)$(CC) $(FINAL_CFLAGS)
</span><span style="color: #008080;">196</span> REDIS_LD=<span style="color: #000000;">$(QUIET_LINK)$(CC) $(FINAL_LDFLAGS)
</span><span style="color: #008080;">197</span> REDIS_INSTALL=<span style="color: #000000;">$(QUIET_INSTALL)$(INSTALL)
</span><span style="color: #008080;">198</span> 
<span style="color: #008080;">199</span> # CCCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[34m</span><span style="color: #800000;">"</span><span style="color: #000000;">        蓝色字
</span><span style="color: #008080;">200</span> # LINKCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[34;1m</span><span style="color: #800000;">"</span><span style="color: #000000;">    蓝色字 高亮
</span><span style="color: #008080;">201</span> # SRCCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[33m</span><span style="color: #800000;">"</span><span style="color: #000000;">        黄色字
</span><span style="color: #008080;">202</span> # BINCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[37;1m</span><span style="color: #800000;">"</span><span style="color: #000000;">        白色字 高亮
</span><span style="color: #008080;">203</span> # MAKECOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[32;1m</span><span style="color: #800000;">"</span><span style="color: #000000;">    绿色字 高亮
</span><span style="color: #008080;">204</span> # ENDCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[0m</span><span style="color: #800000;">"</span><span style="color: #000000;">        关闭所有属性
</span><span style="color: #008080;">205</span> CCCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[34m</span><span style="color: #800000;">"</span>
<span style="color: #008080;">206</span> LINKCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[34;1m</span><span style="color: #800000;">"</span>
<span style="color: #008080;">207</span> SRCCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[33m</span><span style="color: #800000;">"</span>
<span style="color: #008080;">208</span> BINCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[37;1m</span><span style="color: #800000;">"</span>
<span style="color: #008080;">209</span> MAKECOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[32;1m</span><span style="color: #800000;">"</span>
<span style="color: #008080;">210</span> ENDCOLOR=<span style="color: #800000;">"</span><span style="color: #800000;">\033[0m</span><span style="color: #800000;">"</span>
<span style="color: #008080;">211</span> 
<span style="color: #008080;">212</span> <span style="color: #000000;"># ifndef 不存在 V 那么就为真
</span><span style="color: #008080;">213</span> <span style="color: #000000;"># @printf Makefile 屏幕上不再回显执行的命令
</span><span style="color: #008080;">214</span> # %<span style="color: #000000;">b 相对应的参数被视为含有要被处理的转义序列之字符串
</span><span style="color: #008080;">215</span> # <span style="color: #800080;">1</span>&gt;&amp;<span style="color: #800080;">2</span><span style="color: #000000;"> 标准输出重定向到标准错误
</span><span style="color: #008080;">216</span> <span style="color: #000000;"># $@ 表示规则中的目标
</span><span style="color: #008080;">217</span> <span style="color: #000000;"># QUIET_CC 编译, QUIET_LINK 链接, QUIET_INSTALL 安装
</span><span style="color: #008080;">218</span> <span style="color: #000000;">ifndef V
</span><span style="color: #008080;">219</span> QUIET_CC = @printf <span style="color: #800000;">'</span><span style="color: #800000;">    %b %b\n</span><span style="color: #800000;">'</span> $(CCCOLOR)CC$(ENDCOLOR) $(SRCCOLOR)$@$(ENDCOLOR) <span style="color: #800080;">1</span>&gt;&amp;<span style="color: #800080;">2</span><span style="color: #000000;">;
</span><span style="color: #008080;">220</span> QUIET_LINK = @printf <span style="color: #800000;">'</span><span style="color: #800000;">    %b %b\n</span><span style="color: #800000;">'</span> $(LINKCOLOR)LINK$(ENDCOLOR) $(BINCOLOR)$@$(ENDCOLOR) <span style="color: #800080;">1</span>&gt;&amp;<span style="color: #800080;">2</span><span style="color: #000000;">;
</span><span style="color: #008080;">221</span> QUIET_INSTALL = @printf <span style="color: #800000;">'</span><span style="color: #800000;">    %b %b\n</span><span style="color: #800000;">'</span> $(LINKCOLOR)INSTALL$(ENDCOLOR) $(BINCOLOR)$@$(ENDCOLOR) <span style="color: #800080;">1</span>&gt;&amp;<span style="color: #800080;">2</span><span style="color: #000000;">;
</span><span style="color: #008080;">222</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">223</span> 
<span style="color: #008080;">224</span> REDIS_SERVER_NAME=redis-<span style="color: #000000;">server
</span><span style="color: #008080;">225</span> REDIS_SENTINEL_NAME=redis-<span style="color: #000000;">sentinel
</span><span style="color: #008080;">226</span> REDIS_SERVER_OBJ=adlist.o quicklist.o ae.o anet.o dict.o server.o sds.o zmalloc.o lzf_c.o lzf_d.o pqsort.o zipmap.o sha1.o ziplist.o release.o networking.o util.o <span style="color: #0000ff;">object</span>.o db.o replication.o rdb.o t_string.o t_list.o t_set.o t_zset.o t_hash.o config.o aof.o pubsub.o multi.o debug.o <span style="color: #0000ff;">sort</span>.o intset.o syncio.o cluster.o crc16.o endianconv.o slowlog.o scripting.o bio.o rio.o rand.o memtest.o crc64.o bitops.o sentinel.o notify.o setproctitle.o blocked.o hyperloglog.o latency.o sparkline.o redis-check-rdb.o redis-check-<span style="color: #000000;">aof.o geo.o lazyfree.o module.o evict.o expire.o geohash.o geohash_helper.o childinfo.o defrag.o siphash.o rax.o t_stream.o listpack.o localtime.o lolwut.o lolwut5.o lolwut6.o acl.o gopher.o tracking.o connection.o tls.o sha256.o
</span><span style="color: #008080;">227</span> REDIS_CLI_NAME=redis-<span style="color: #000000;">cli
</span><span style="color: #008080;">228</span> REDIS_CLI_OBJ=anet.o adlist.o dict.o redis-<span style="color: #000000;">cli.o zmalloc.o release.o anet.o ae.o crc64.o siphash.o crc16.o
</span><span style="color: #008080;">229</span> REDIS_BENCHMARK_NAME=redis-<span style="color: #000000;">benchmark
</span><span style="color: #008080;">230</span> REDIS_BENCHMARK_OBJ=ae.o anet.o redis-benchmark.o adlist.o dict.o zmalloc.o siphash.o redis-<span style="color: #000000;">benchmark.o
</span><span style="color: #008080;">231</span> REDIS_CHECK_RDB_NAME=redis-check-<span style="color: #000000;">rdb
</span><span style="color: #008080;">232</span> REDIS_CHECK_AOF_NAME=redis-check-<span style="color: #000000;">aof
</span><span style="color: #008080;">233</span> 
<span style="color: #008080;">234</span> <span style="color: #000000;">all: $(REDIS_SERVER_NAME) $(REDIS_SENTINEL_NAME) $(REDIS_CLI_NAME) $(REDIS_BENCHMARK_NAME) $(REDIS_CHECK_RDB_NAME) $(REDIS_CHECK_AOF_NAME)
</span><span style="color: #008080;">235</span>     @echo <span style="color: #800000;">""</span>
<span style="color: #008080;">236</span>     @echo <span style="color: #800000;">"</span><span style="color: #800000;">Hint: It's a good idea to run 'make test' ;)</span><span style="color: #800000;">"</span>
<span style="color: #008080;">237</span>     @echo <span style="color: #800000;">""</span>
<span style="color: #008080;">238</span> 
<span style="color: #008080;">239</span> <span style="color: #000000;"># 构建 Makefile.dep 文件
</span><span style="color: #008080;">240</span> # -<span style="color: #000000;">M  不是输出预编译过程的结果, 而是输出一个用于make的规则, 该规则描述了这个源文件的依赖关系.
</span><span style="color: #008080;">241</span> #     预编译器输出的这个 <span style="color: #0000ff;">make</span><span style="color: #000000;"> 规则包含名字与原文件相同的目标文件, 冒号和所有 include 文件的名字
</span><span style="color: #008080;">242</span> # -MM 与 -<span style="color: #000000;">M 相似, 只是不包含系统头文件
</span><span style="color: #008080;">243</span> <span style="color: #000000;">Makefile.dep:
</span><span style="color: #008080;">244</span>     -$(REDIS_CC) -MM *.c &gt; Makefile.dep <span style="color: #800080;">2</span>&gt; /dev/<span style="color: #0000ff;">null</span> || <span style="color: #0000ff;">true</span>
<span style="color: #008080;">245</span> 
<span style="color: #008080;">246</span> # $(words &lt;text&gt;<span style="color: #000000;">) 单词个数统计函数
</span><span style="color: #008080;">247</span> <span style="color: #000000;"># MAKECMDGOALS 会存放你所指定的终极目标的列表，如果在命令行上，你没有指定目标，那么，这个变量是空值
</span><span style="color: #008080;">248</span> # NODEPS:=<span style="color: #000000;">clean distclean
</span><span style="color: #008080;">249</span> ifeq (<span style="color: #800080;">0</span><span style="color: #000000;">, $(words $(findstring $(MAKECMDGOALS), $(NODEPS))))
</span><span style="color: #008080;">250</span> -<span style="color: #000000;">include Makefile.dep
</span><span style="color: #008080;">251</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">252</span> 
<span style="color: #008080;">253</span> <span style="color: #000000;">.PHONY: all
</span><span style="color: #008080;">254</span> 
<span style="color: #008080;">255</span> # 构建 .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">256</span> persist-<span style="color: #000000;">settings: distclean
</span><span style="color: #008080;">257</span>     <span style="color: #0000ff;">echo</span> STD=$(STD) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">258</span>     <span style="color: #0000ff;">echo</span> WARN=$(WARN) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">259</span>     <span style="color: #0000ff;">echo</span> OPT=$(OPT) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">260</span>     <span style="color: #0000ff;">echo</span> MALLOC=$(MALLOC) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">261</span>     <span style="color: #0000ff;">echo</span> CFLAGS=$(CFLAGS) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">262</span>     <span style="color: #0000ff;">echo</span> LDFLAGS=$(LDFLAGS) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">263</span>     <span style="color: #0000ff;">echo</span> REDIS_CFLAGS=$(REDIS_CFLAGS) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">264</span>     <span style="color: #0000ff;">echo</span> REDIS_LDFLAGS=$(REDIS_LDFLAGS) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">265</span>     <span style="color: #0000ff;">echo</span> PREV_FINAL_CFLAGS=$(FINAL_CFLAGS) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">266</span>     <span style="color: #0000ff;">echo</span> PREV_FINAL_LDFLAGS=$(FINAL_LDFLAGS) &gt;&gt; .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">settings
</span><span style="color: #008080;">267</span>     -(cd ../deps &amp;&amp;<span style="color: #000000;"> $(MAKE) $(DEPENDENCY_TARGETS))
</span><span style="color: #008080;">268</span> 
<span style="color: #008080;">269</span> .PHONY: persist-<span style="color: #000000;">settings
</span><span style="color: #008080;">270</span> 
<span style="color: #008080;">271</span> <span style="color: #000000;"># Prerequisites target
</span><span style="color: #008080;">272</span> .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">prerequisites:
</span><span style="color: #008080;">273</span> <span style="color: #000000;">    @touch $@
</span><span style="color: #008080;">274</span> 
<span style="color: #008080;">275</span> # Clean everything, persist settings and build dependencies <span style="color: #0000ff;">if</span><span style="color: #000000;"> anything changed
</span><span style="color: #008080;">276</span> <span style="color: #000000;">ifneq ($(strip $(PREV_FINAL_CFLAGS)), $(strip $(FINAL_CFLAGS)))
</span><span style="color: #008080;">277</span> .<span style="color: #0000ff;">make</span>-prerequisites: persist-<span style="color: #000000;">settings
</span><span style="color: #008080;">278</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">279</span> 
<span style="color: #008080;">280</span> <span style="color: #000000;"># $(strip STRINT) 去空格函数
</span><span style="color: #008080;">281</span> <span style="color: #000000;">ifneq ($(strip $(PREV_FINAL_LDFLAGS)), $(strip $(FINAL_LDFLAGS)))
</span><span style="color: #008080;">282</span> .<span style="color: #0000ff;">make</span>-prerequisites: persist-<span style="color: #000000;">settings
</span><span style="color: #008080;">283</span> <span style="color: #000000;">endif
</span><span style="color: #008080;">284</span> 
<span style="color: #008080;">285</span> # redis-<span style="color: #000000;">server
</span><span style="color: #008080;">286</span> <span style="color: #000000;">$(REDIS_SERVER_NAME): $(REDIS_SERVER_OBJ)
</span><span style="color: #008080;">287</span>     $(REDIS_LD) -o $@ $^ ../deps/hiredis/libhiredis.a ../deps/lua/src/<span style="color: #000000;">liblua.a $(FINAL_LIBS)
</span><span style="color: #008080;">288</span> 
<span style="color: #008080;">289</span> # redis-<span style="color: #000000;">sentinel
</span><span style="color: #008080;">290</span> <span style="color: #000000;">$(REDIS_SENTINEL_NAME): $(REDIS_SERVER_NAME)
</span><span style="color: #008080;">291</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_SERVER_NAME) $(REDIS_SENTINEL_NAME)
</span><span style="color: #008080;">292</span> 
<span style="color: #008080;">293</span> # redis-check-<span style="color: #000000;">rdb
</span><span style="color: #008080;">294</span> <span style="color: #000000;">$(REDIS_CHECK_RDB_NAME): $(REDIS_SERVER_NAME)
</span><span style="color: #008080;">295</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_SERVER_NAME) $(REDIS_CHECK_RDB_NAME)
</span><span style="color: #008080;">296</span> 
<span style="color: #008080;">297</span> # redis-check-<span style="color: #000000;">aof
</span><span style="color: #008080;">298</span> <span style="color: #000000;">$(REDIS_CHECK_AOF_NAME): $(REDIS_SERVER_NAME)
</span><span style="color: #008080;">299</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_SERVER_NAME) $(REDIS_CHECK_AOF_NAME)
</span><span style="color: #008080;">300</span> 
<span style="color: #008080;">301</span> # redis-<span style="color: #000000;">cli
</span><span style="color: #008080;">302</span> <span style="color: #000000;">$(REDIS_CLI_NAME): $(REDIS_CLI_OBJ)
</span><span style="color: #008080;">303</span>     $(REDIS_LD) -o $@ $^ ../deps/hiredis/libhiredis.a ../deps/linenoise/<span style="color: #000000;">linenoise.o $(FINAL_LIBS)
</span><span style="color: #008080;">304</span> 
<span style="color: #008080;">305</span> # redis-<span style="color: #000000;">benchmark
</span><span style="color: #008080;">306</span> <span style="color: #000000;">$(REDIS_BENCHMARK_NAME): $(REDIS_BENCHMARK_OBJ)
</span><span style="color: #008080;">307</span>     $(REDIS_LD) -o $@ $^ ../deps/hiredis/<span style="color: #000000;">libhiredis.a $(FINAL_LIBS)
</span><span style="color: #008080;">308</span> 
<span style="color: #008080;">309</span> dict-<span style="color: #000000;">benchmark: dict.c zmalloc.c sds.c siphash.c
</span><span style="color: #008080;">310</span>     $(REDIS_CC) $(FINAL_CFLAGS) $^ -D DICT_BENCHMARK_MAIN -<span style="color: #000000;">o $@ $(FINAL_LIBS)
</span><span style="color: #008080;">311</span> 
<span style="color: #008080;">312</span> <span style="color: #000000;"># Because the jemalloc.h header is generated as a part of the jemalloc build,
</span><span style="color: #008080;">313</span> # building it should complete before building any other <span style="color: #0000ff;">object</span><span style="color: #000000;">. Instead of
</span><span style="color: #008080;">314</span> <span style="color: #000000;"># depending on a single artifact, build all dependencies first.
</span><span style="color: #008080;">315</span> %.o: %.c .<span style="color: #0000ff;">make</span>-<span style="color: #000000;">prerequisites
</span><span style="color: #008080;">316</span>     $(REDIS_CC) -c $&lt;
<span style="color: #008080;">317</span> 
<span style="color: #008080;">318</span> <span style="color: #000000;">clean:
</span><span style="color: #008080;">319</span>     <span style="color: #0000ff;">rm</span> -rf $(REDIS_SERVER_NAME) $(REDIS_SENTINEL_NAME) $(REDIS_CLI_NAME) $(REDIS_BENCHMARK_NAME) $(REDIS_CHECK_RDB_NAME) $(REDIS_CHECK_AOF_NAME) *.o *.gcda *.gcno *.gcov redis.<span style="color: #0000ff;">info</span> lcov-html Makefile.dep dict-<span style="color: #000000;">benchmark
</span><span style="color: #008080;">320</span> 
<span style="color: #008080;">321</span> <span style="color: #000000;">.PHONY: clean
</span><span style="color: #008080;">322</span> 
<span style="color: #008080;">323</span> <span style="color: #000000;">distclean: clean
</span><span style="color: #008080;">324</span>     -(cd ../deps &amp;&amp;<span style="color: #000000;"> $(MAKE) distclean)
</span><span style="color: #008080;">325</span>     -(<span style="color: #0000ff;">rm</span> -f .<span style="color: #0000ff;">make</span>-*<span style="color: #000000;">)
</span><span style="color: #008080;">326</span> 
<span style="color: #008080;">327</span> <span style="color: #000000;">.PHONY: distclean
</span><span style="color: #008080;">328</span> 
<span style="color: #008080;">329</span> <span style="color: #000000;">test: $(REDIS_SERVER_NAME) $(REDIS_CHECK_AOF_NAME)
</span><span style="color: #008080;">330</span>     @(cd ..; ./<span style="color: #000000;">runtest)
</span><span style="color: #008080;">331</span> 
<span style="color: #008080;">332</span> test-<span style="color: #000000;">sentinel: $(REDIS_SENTINEL_NAME)
</span><span style="color: #008080;">333</span>     @(cd ..; ./runtest-<span style="color: #000000;">sentinel)
</span><span style="color: #008080;">334</span> 
<span style="color: #008080;">335</span> <span style="color: #000000;">check: test
</span><span style="color: #008080;">336</span> 
<span style="color: #008080;">337</span> <span style="color: #000000;">lcov:
</span><span style="color: #008080;">338</span> <span style="color: #000000;">    $(MAKE) gcov
</span><span style="color: #008080;">339</span>     @(set -e; cd ..; ./runtest --clients <span style="color: #800080;">1</span><span style="color: #000000;">)
</span><span style="color: #008080;">340</span>     @geninfo -o redis.<span style="color: #0000ff;">info</span><span style="color: #000000;"> .
</span><span style="color: #008080;">341</span>     @genhtml --legend -o lcov-html redis.<span style="color: #0000ff;">info</span>
<span style="color: #008080;">342</span> 
<span style="color: #008080;">343</span> test-<span style="color: #000000;">sds: sds.c sds.h
</span><span style="color: #008080;">344</span>     $(REDIS_CC) sds.c zmalloc.c -DSDS_TEST_MAIN $(FINAL_LIBS) -o /tmp/<span style="color: #000000;">sds_test
</span><span style="color: #008080;">345</span>     /tmp/<span style="color: #000000;">sds_test
</span><span style="color: #008080;">346</span> 
<span style="color: #008080;">347</span> <span style="color: #000000;">.PHONY: lcov
</span><span style="color: #008080;">348</span> 
<span style="color: #008080;">349</span> <span style="color: #000000;">bench: $(REDIS_BENCHMARK_NAME)
</span><span style="color: #008080;">350</span>     ./<span style="color: #000000;">$(REDIS_BENCHMARK_NAME)
</span><span style="color: #008080;">351</span> 
<span style="color: #008080;">352</span> <span style="color: #000000;">32bit:
</span><span style="color: #008080;">353</span>     @echo <span style="color: #800000;">""</span>
<span style="color: #008080;">354</span>     @echo <span style="color: #800000;">"</span><span style="color: #800000;">WARNING: if it fails under Linux you probably need to install libc6-dev-i386</span><span style="color: #800000;">"</span>
<span style="color: #008080;">355</span>     @echo <span style="color: #800000;">""</span>
<span style="color: #008080;">356</span>     $(MAKE) CFLAGS=<span style="color: #800000;">"</span><span style="color: #800000;">-m32</span><span style="color: #800000;">"</span> LDFLAGS=<span style="color: #800000;">"</span><span style="color: #800000;">-m32</span><span style="color: #800000;">"</span>
<span style="color: #008080;">357</span> 
<span style="color: #008080;">358</span> <span style="color: #000000;">gcov:
</span><span style="color: #008080;">359</span>     $(MAKE) REDIS_CFLAGS=<span style="color: #800000;">"</span><span style="color: #800000;">-fprofile-arcs -ftest-coverage -DCOVERAGE_TEST</span><span style="color: #800000;">"</span> REDIS_LDFLAGS=<span style="color: #800000;">"</span><span style="color: #800000;">-fprofile-arcs -ftest-coverage</span><span style="color: #800000;">"</span>
<span style="color: #008080;">360</span> 
<span style="color: #008080;">361</span> <span style="color: #000000;">noopt:
</span><span style="color: #008080;">362</span>     $(MAKE) OPTIMIZATION=<span style="color: #800000;">"</span><span style="color: #800000;">-O0</span><span style="color: #800000;">"</span>
<span style="color: #008080;">363</span> 
<span style="color: #008080;">364</span> <span style="color: #000000;">valgrind:
</span><span style="color: #008080;">365</span>     $(MAKE) OPTIMIZATION=<span style="color: #800000;">"</span><span style="color: #800000;">-O0</span><span style="color: #800000;">"</span> MALLOC=<span style="color: #800000;">"</span><span style="color: #800000;">libc</span><span style="color: #800000;">"</span>
<span style="color: #008080;">366</span> 
<span style="color: #008080;">367</span> <span style="color: #000000;">helgrind:
</span><span style="color: #008080;">368</span>     $(MAKE) OPTIMIZATION=<span style="color: #800000;">"</span><span style="color: #800000;">-O0</span><span style="color: #800000;">"</span> MALLOC=<span style="color: #800000;">"</span><span style="color: #800000;">libc</span><span style="color: #800000;">"</span> CFLAGS=<span style="color: #800000;">"</span><span style="color: #800000;">-D__ATOMIC_VAR_FORCE_SYNC_MACROS</span><span style="color: #800000;">"</span>
<span style="color: #008080;">369</span> 
<span style="color: #008080;">370</span> # 生成 src/<span style="color: #000000;">help.h 头文件
</span><span style="color: #008080;">371</span> # @../utils/generate-command-help.rb &gt;<span style="color: #000000;"> help.h 通过 ruby 脚本请求 
</span><span style="color: #008080;">372</span> # https:<span style="color: #008000;">//</span><span style="color: #008000;">raw.githubusercontent.com/antirez/redis-doc/master/commands.json 构建相关 C 中全局区变量信息</span>
<span style="color: #008080;">373</span> src/<span style="color: #000000;">help.h:
</span><span style="color: #008080;">374</span>     @../utils/generate-command-help.rb &gt;<span style="color: #000000;"> help.h
</span><span style="color: #008080;">375</span> 
<span style="color: #008080;">376</span> <span style="color: #0000ff;">install</span><span style="color: #000000;">: all
</span><span style="color: #008080;">377</span>     @mkdir -<span style="color: #000000;">p $(INSTALL_BIN)
</span><span style="color: #008080;">378</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_SERVER_NAME) $(INSTALL_BIN)
</span><span style="color: #008080;">379</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_BENCHMARK_NAME) $(INSTALL_BIN)
</span><span style="color: #008080;">380</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_CLI_NAME) $(INSTALL_BIN)
</span><span style="color: #008080;">381</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_CHECK_RDB_NAME) $(INSTALL_BIN)
</span><span style="color: #008080;">382</span> <span style="color: #000000;">    $(REDIS_INSTALL) $(REDIS_CHECK_AOF_NAME) $(INSTALL_BIN)
</span><span style="color: #008080;">383</span>     @ln -sf $(REDIS_SERVER_NAME) $(INSTALL_BIN)/<span style="color: #000000;">$(REDIS_SENTINEL_NAME)
</span><span style="color: #008080;">384</span> 
<span style="color: #008080;">385</span> <span style="color: #000000;">uninstall:
</span><span style="color: #008080;">386</span>     <span style="color: #0000ff;">rm</span> -f $(INSTALL_BIN)/{$(REDIS_SERVER_NAME),$(REDIS_BENCHMARK_NAME),$(REDIS_CLI_NAME),$(REDIS_CHECK_RDB_NAME),$(REDIS_CHECK_AOF_NAME),$(REDIS_SENTINEL_NAME)}</span></code></pre>

<p><span style="font-family: 'courier new', courier;">感谢大家 ☆ redis 最简单的数据结构 adlist 双向链表就带大家写到这了. 有缘再见 ~&nbsp;</span></p>
<h2><span style="font-family: 'courier new', courier;">后记 - 如果</span></h2>
<p><span style="font-family: 'courier new', courier;">错误是难免, 欢迎大家指正交流, 共同提高 ~</span></p>
<div class="cnblogs_code">
<pre><code><span style="font-family: 'courier new', courier;"><span style="color: #0000ff;">IF</span>《如果》&mdash;&mdash;Rudyard Kipling（拉迪亚德.<span style="color: #000000;">吉普林）
　　
　　</span><span style="color: #0000ff;">If</span><span style="color: #000000;"> you can keep your head when all about you
　　Are losing theirs and blaming it on you;
　　</span><span style="color: #0000ff;">If</span> you can trust yourself when all men doubt you,<span style="color: #000000;">
　　But make allowance </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> their doubting too;
　　</span><span style="color: #0000ff;">If</span> you can wait and not be tired by waiting,<span style="color: #000000;">
　　Or</span>, being lied about, don'<span style="color: #000000;">t deal in lies,
　　Or, being hated, don</span>'t give way to hating,<span style="color: #000000;">
　　And yet don</span>'<span style="color: #000000;">t look too good, nor talk too wise;
　　如果所有人都失去理智，咒骂你，
　　你仍能保持头脑清醒；
　　如果所有人都怀疑你，
　　你仍能坚信自己，让所有的怀疑动摇；
　　如果你要等待，不要因此厌烦，
　　为人所骗，不要因此骗人，
　　为人所恨，不要因此抱恨，
　　不要太乐观，不要自以为是；
　　
　　If you can dream - and not make dreams your master;
　　If you can think - and not make thoughts your aim;
　　If you can meet with triumph and disaster
　　And treat those two imposters just the same;
　　If you can bear to hear the truth you</span>'<span style="color: #000000;">ve spoken
　　Twisted by knaves to make a trap </span><span style="color: #0000ff;">for</span> fools,<span style="color: #000000;">
　　Or watch the things you gave your life to broken</span>,<span style="color: #000000;">
　　And stoop and build &lsquo;em up with worn</span>-<span style="color: #000000;">out tools;
　　如果你是个追梦人&mdash;&mdash;不要被梦主宰；
　　如果你是个爱思考的人&mdash;&mdash;不要以思想者自居；
　　如果你遇到骄傲和挫折
　　把两者当骗子看待；
　　如果你能忍受，你曾讲过的事实
　　被恶棍扭曲，用于蒙骗傻子；
　　或者，看着你用毕生去看护的东西被破坏，
　　俯下身去，用破旧的工具把它修补；
　　
　　</span><span style="color: #0000ff;">If</span><span style="color: #000000;"> you can make one heap of all your winnings
　　And risk it on one turn of pitch</span>-and-toss,<span style="color: #000000;">
　　And lose</span>,<span style="color: #000000;"> and start again at your beginnings
　　And never breath a word about your loss;
　　</span><span style="color: #0000ff;">If</span><span style="color: #000000;"> you can force your heart and nerve and sinew
　　To serve your turn long after they are gone</span>,<span style="color: #000000;">
　　And so hold on when there is nothing in you
　　Except the Will which says to them</span>: "Hold on"<span style="color: #000000;">;
　　如果在你赢得无数桂冠之后，
　　然后孤注一掷再搏一次，
　　失败过后，东山再起，
　　不要抱怨你的失败；
　　如果你能迫使自己，
　　在别人走后，长久坚守阵地，
　　在你心中已空荡荡无一物，
　　只有意志告诉你&ldquo;坚持！&rdquo;；
　　
　　</span><span style="color: #0000ff;">If</span> you can talk with crowds and keep your virtue,<span style="color: #000000;">
　　Or walk with kings </span>- nor lose the common <span style="color: #008080;">touch</span><span style="color: #000000;">;
　　</span><span style="color: #0000ff;">If</span><span style="color: #000000;"> neither foes nor loving friends can hurt you;
　　</span><span style="color: #0000ff;">If</span> all men <span style="color: #008080;">count</span> with you,<span style="color: #000000;"> but none too much;
　　</span><span style="color: #0000ff;">If</span><span style="color: #000000;"> you can fill the unforgiving minute
　　With sixty seconds</span>'<span style="color: #000000;"> worth of distance run -
　　Yours is the Earth and everything that</span>'s in it,<span style="color: #000000;">
　　如果你与人交谈，能保持风度，
　　伴王同行，能保持距离；
　　如果仇敌和好友都不害你；
　　如果所有人都指望你，却无人全心全意；
　　如果你花六十秒进行短程跑，
　　填满那不可饶恕的一分钟&mdash;&mdash;
　　你就可以拥有一个世界，
　　这个世界的一切都是你的，
　　更重要的是，孩子，你是个顶天立地的人。</span></span></code></pre>


</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>